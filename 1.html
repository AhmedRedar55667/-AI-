<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙØ±Ø¹ÙˆÙ† AI - Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„ÙØ±Ø¹ÙˆÙ†ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* Base Body Styles */
        body {
            font-family: 'Tajawal', sans-serif;
            background-image: url('https://www.transparenttextures.com/patterns/papyrus.png');
            background-color: #f5e7c8; /* Light background for day mode */
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for dark mode */
        }

        /* Pharaoh Background for Header and Footer */
        .pharaoh-bg {
            background-image: linear-gradient(to bottom, rgba(23, 42, 58, 0.8), rgba(23, 42, 58, 0.9)), url('https://www.transparenttextures.com/patterns/black-paper.png');
            color: #f0e6d2; /* Light text color for header/footer */
        }

        /* User Message Styles */
        .user-message {
            background: linear-gradient(135deg, #f8d56b 0%, #e8b54a 100%); /* Gold gradient */
            border-left: 4px solid #d4a017; /* Gold border */
            color: #4a2c0f; /* Dark text for readability */
        }

        /* AI Message Styles */
        .ai-message {
            background: linear-gradient(135deg, #1a365d 0%, #15314b 100%); /* Dark blue gradient */
            border-right: 4px solid #d4a017; /* Gold border */
            color: #f0e6d2; /* Light text color */
        }

        /* Font Size for Message Text (User and AI) */
        .user-message p,
        .ai-message p {
            font-size: 0.9rem; /* Slightly adjusted font size */
        }


        /* Hieroglyphic Border Effect (for AI messages) */
        .hieroglyphic-border {
            position: relative;
        }

        /* Hieroglyphic pseudo-element */
        .hieroglyphic-border::before {
            content: "ğ“ƒ­ğ“ƒ®ğ“ƒ¯ğ“ƒ°ğ“ƒ­ğ“ƒ®ğ“ƒ¯ğ“ƒ°"; /* Hieroglyph characters */
            position: absolute;
            top: -15px; /* Position above the message bubble */
            left: 0;
            right: 0;
            text-align: center;
            color: #d4a017; /* Gold color */
            font-size: 12px;
            letter-spacing: 5px;
            opacity: 0.6; /* Slightly transparent */
        }

        /* Send Button Styles */
        .send-btn {
            background: linear-gradient(135deg, #d4a017 0%, #b78a14 100%); /* Gold gradient */
            box-shadow: 0 4px 6px rgba(180, 140, 20, 0.3); /* Gold shadow */
        }

        .send-btn:hover:not(:disabled) { /* Apply hover effect only when not disabled */
            background: linear-gradient(135deg, #b78a14 0%, #9a7311 100%); /* Darker gold on hover */
        }

        .send-btn:disabled {
            opacity: 0.5; /* Reduce opacity when disabled */
            cursor: not-allowed; /* Change cursor */
        }


        /* Input Field Styles */
        .input-field {
            background-color: rgba(255, 255, 255, 0.1); /* Slightly transparent white */
            backdrop-filter: blur(5px); /* Blur effect */
            border: 1px solid rgba(212, 160, 23, 0.3); /* Semi-transparent gold border */
            color: #f0e6d2; /* Light text color */
        }

        .input-field::placeholder {
             color: rgba(240, 230, 210, 0.7); /* Lighter placeholder text */
        }

        .input-field:focus {
            border-color: #d4a017; /* Solid gold border on focus */
            box-shadow: 0 0 0 2px rgba(212, 160, 23, 0.3); /* Gold focus ring */
        }

         .input-field:disabled {
             opacity: 0.6; /* Reduce opacity when disabled */
             cursor: not-allowed; /* Change cursor */
         }


        /* Typing Indicator Animation */
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #d4a017; /* Gold color */
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out; /* Bounce animation */
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s; /* Stagger animation */
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s; /* Stagger animation */
        }

        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
        }

        /* Message Entry Animation (Papyrus Unroll effect) */
        .message-animation {
            animation: papyrusUnroll 0.6s ease-out;
            transform-origin: top; /* Animation starts from the top */
        }

        @keyframes papyrusUnroll {
            0% { transform: scaleY(0); opacity: 0; }
            100% { transform: scaleY(1); opacity: 1; }
        }

        /* Dark Mode Styles */
        .dark-mode {
            background-image: linear-gradient(to bottom, rgba(10, 15, 20, 0.9), rgba(5, 10, 15, 0.95)), url('https://www.transparenttextures.com/patterns/stardust.png');
            background-color: #0a141a; /* Very dark background */
            color: #f0e6d2; /* Light text */
        }

        .dark-mode .user-message {
            background: linear-gradient(135deg, #9a7311 0%, #7a5a0e 100%); /* Darker gold gradient */
            border-left-color: #7a5a0e; /* Darker gold border */
            color: #fffbeb; /* Very light text */
        }

        .dark-mode .ai-message {
            background: linear-gradient(135deg, #0f2027 0%, #0a141a 100%); /* Even darker blue gradient */
            border-right-color: #9a7311; /* Darker gold border */
            color: #f0e6d2; /* Light text */
        }

         .dark-mode .hieroglyphic-border::before {
             color: #9a7311; /* Darker gold hieroglyphs */
         }

        .dark-mode .input-field {
            background-color: rgba(15, 25, 35, 0.7); /* Darker transparent background */
            border: 1px solid rgba(154, 115, 17, 0.5); /* Semi-transparent darker gold border */
            color: #f0e6d2; /* Light text */
        }

         .dark-mode .input-field::placeholder {
             color: rgba(240, 230, 210, 0.5); /* Even lighter placeholder text */
         }


        /* Dark Mode Toggle Button Styles */
        .dark-mode-toggle {
            background: linear-gradient(135deg, #1a365d 0%, #15314b 100%); /* Dark blue gradient */
        }

        .dark-mode .dark-mode-toggle {
            background: linear-gradient(135deg, #d4a017 0%, #b78a14 100%); /* Gold gradient in dark mode */
        }

        /* Character Selector Modal Styles */
        .character-selector {
            background: linear-gradient(135deg, rgba(26, 54, 93, 0.9), rgba(21, 49, 75, 0.9)); /* Dark blue transparent gradient */
            backdrop-filter: blur(5px); /* Blur effect */
        }

        .character-card {
            transition: all 0.3s ease; /* Smooth transition */
            border: 2px solid transparent; /* Transparent border by default */
            background-color: rgba(255, 255, 255, 0.9); /* Slightly transparent white */
        }

         .dark-mode .character-card {
             background-color: rgba(30, 40, 50, 0.9); /* Slightly transparent dark */
         }

        .character-card:hover {
            transform: translateY(-5px); /* Lift on hover */
            border-color: #d4a017; /* Gold border on hover */
            box-shadow: 0 10px 15px rgba(212, 160, 23, 0.2); /* Gold shadow on hover */
        }

        .character-card.selected {
            border-color: #d4a017; /* Gold border when selected */
            background: rgba(212, 160, 23, 0.1); /* Light gold background when selected */
        }

         .dark-mode .character-card.selected {
             background: rgba(212, 160, 23, 0.05); /* Lighter gold background in dark mode */
         }

         /* Scrollbar Hide Utility */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Ensure main chat area takes available height */
        #appContainer {
             display: flex; /* Use flexbox for layout */
             flex-direction: column; /* Stack children vertically */
             min-height: 100vh; /* Minimum height of the viewport */
        }

         #chatContainer {
             flex-grow: 1; /* Allow chat container to grow and fill space */
             overflow-y: auto; /* Enable vertical scrolling */
             padding-bottom: 80px; /* Add padding at the bottom to prevent input overlap */
         }

         /* New Chat Button Styles */
         #newChatButton {
             background: linear-gradient(135deg, #d4a017 0%, #b78a14 100%);
             box-shadow: 0 2px 4px rgba(180, 140, 20, 0.3);
             /* --- Added: Dark mode style for new chat button --- */
             transition: background 0.3s ease; /* Add transition for smooth color change */
         }

         #newChatButton:hover {
             background: linear-gradient(135deg, #b78a14 0%, #9a7311 100%);
         }

         /* --- Added: Dark mode style for new chat button hover --- */
         .dark-mode #newChatButton {
              background: linear-gradient(135deg, #d4a017 0%, #b78a14 100%); /* Keep gold in dark mode */
         }

         .dark-mode #newChatButton:hover {
              background: linear-gradient(135deg, #b78a14 0%, #9a7311 100%); /* Darker gold on hover in dark mode */
         }
         /* --- End Added --- */


         /* Message Action Buttons (Copy, Regenerate) */
         .message-actions {
             display: flex;
             gap: 8px; /* Space between buttons */
             margin-top: 8px; /* Space above actions */
             font-size: 0.8rem; /* Smaller icons */
             color: rgba(240, 230, 210, 0.7); /* Light gold color */
         }

         .message-actions button {
             background: none;
             border: none;
             padding: 4px; /* Padding around icon */
             cursor: pointer;
             color: inherit; /* Inherit color from parent */
             transition: color 0.2s ease;
         }

         .message-actions button:hover {
             color: #d4a017; /* Gold color on hover */
         }

         .dark-mode .message-actions button {
             color: rgba(240, 230, 210, 0.5); /* Lighter color in dark mode */
         }

         .dark-mode .message-actions button:hover {
             color: #f0e6d2; /* Lighter gold on hover in dark mode */
         }


    </style>
</head>
<body class="transition-colors duration-300">

    <div id="characterModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 character-selector">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-2xl w-full p-6 max-h-screen overflow-y-auto">
            <h2 class="text-2xl font-bold text-center text-yellow-600 mb-6">Ø§Ø®ØªØ± Ø´Ø®ØµÙŠØ© Ø§Ù„ÙØ±Ø¹ÙˆÙ†</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                <div class="character-card rounded-lg p-1 text-center cursor-pointer" data-character="wise">
                    <div class="text-4xl text-yellow-500 mb-2">
                        <i class="fas fa-scroll"></i> </div>
                    <h3 class="font-bold text-gray-800 dark:text-white">Ø§Ù„Ø­ÙƒÙŠÙ…</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300">ÙØ±Ø¹ÙˆÙ† Ø§Ù„Ø­ÙƒÙ…Ø© ÙˆØ§Ù„Ù…Ø¹Ø±ÙØ©</p>
                </div>
                <div class="character-card rounded-lg p-1 text-center cursor-pointer" data-character="warrior">
                    <div class="text-4xl text-yellow-500 mb-2">
                        <i class="fas fa-shield-alt"></i> </div>
                    <h3 class="font-bold text-gray-800 dark:text-white">Ø§Ù„Ù…Ø­Ø§Ø±Ø¨</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300">ÙØ±Ø¹ÙˆÙ† Ø§Ù„Ù‚ÙˆØ© ÙˆØ§Ù„Ø¨Ø·ÙˆÙ„Ø©</p>
                </div>
                <div class="character-card rounded-lg p-1 text-center cursor-pointer" data-character="scholar"> <div class="text-4xl text-yellow-500 mb-2">
                        <i class="fas fa-flask"></i> </div>
                    <h3 class="font-bold text-gray-800 dark:text-white">Ø§Ù„Ø¹Ø§Ù„Ù…</h3> <p class="text-sm text-gray-600 dark:text-gray-300">ÙØ±Ø¹ÙˆÙ† Ø§Ù„Ø¹Ù„ÙˆÙ… ÙˆØ§Ù„Ù…Ø¹Ø±ÙØ©</p> </div>

                <div class="character-card rounded-lg p-1 text-center cursor-pointer" data-character="scribe">
                     <div class="text-4xl text-yellow-500 mb-2">
                         <i class="fas fa-pencil-alt"></i>
                     </div>
                     <h3 class="font-bold text-gray-800 dark:text-white">Ø§Ù„ÙƒØ§ØªØ¨</h3>
                     <p class="text-sm text-gray-600 dark:text-gray-300">ÙØ±Ø¹ÙˆÙ† Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆØ§Ù„Ù…Ø¹Ø§Ø±Ù</p>
                 </div>
                <div class="character-card rounded-lg p-1 text-center cursor-pointer" data-character="builder">
                     <div class="text-4xl text-yellow-500 mb-2">
                         <i class="fas fa-hammer"></i>
                     </div>
                     <h3 class="font-bold text-gray-800 dark:text-white">Ø§Ù„Ø¨Ù†Ù‘Ø§Ø¡</h3>
                     <p class="text-sm text-gray-600 dark:text-gray-300">ÙØ±Ø¹ÙˆÙ† Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆØ§Ù„Ø¹Ù…Ø§Ø±Ø©</p>
                 </div>
                <div class="character-card rounded-lg p-1 text-center cursor-pointer" data-character="teacher">
                     <div class="text-4xl text-yellow-500 mb-2">
                         <i class="fas fa-book-open"></i> </div>
                     <h3 class="font-bold text-gray-800 dark:text-white">Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…</h3>
                     <p class="text-sm text-gray-600 dark:text-gray-300">ÙØ±Ø¹ÙˆÙ† Ø§Ù„Ø¹Ù„Ù… Ù„Ù„Ø¬Ù…ÙŠØ¹</p>
                 </div>
                 <div class="character-card rounded-lg p-1 text-center cursor-pointer" data-character="funny">
                     <div class="text-4xl text-yellow-500 mb-2">
                         <i class="fas fa-laugh"></i> </div>
                     <h3 class="font-bold text-gray-800 dark:text-white">Ø¨Ø´ Ø¨Ø´ Ø§Ù„Ø«Ø§Ù„Ø« ÙˆÙ†Øµ</h3>
                     <p class="text-sm text-gray-600 dark:text-gray-300">ÙØ±Ø¹ÙˆÙ† Ø§Ù„Ù…Ø±Ø­ ÙˆØ§Ù„Ø¶Ø­Ùƒ</p>
                 </div>
                 </div>
            </div>
    </div>

    <div class="flex flex-col min-h-screen hidden" id="appContainer">
        <header class="pharaoh-bg text-gold-100 py-4 px-6 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-3 rtl:space-x-reverse">
                    <div class="text-3xl text-yellow-500">
                        <i class="fas fa-crown"></i> </div>
                    <h1 class="text-2xl font-bold text-yellow-400">
                        ÙØ±Ø¹ÙˆÙ† <span class="text-white">AI</span>
                        <span id="characterBadge" class="text-xs bg-yellow-600 text-white px-2 py-1 rounded ml-2 hidden"></span>
                    </h1>
                </div>
                <div class="flex items-center space-x-4 rtl:space-x-reverse">
                    <button id="newChatButton" class="px-3 py-1 text-sm rounded-full text-white shadow-md transition-all duration-300 flex items-center">
                         <i class="fas fa-plus-circle ml-1 rtl:mr-1 rtl:ml-0"></i> Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©
                     </button>
                    <button id="darkModeToggle" class="dark-mode-toggle w-10 h-10 rounded-full flex items-center justify-center text-white shadow-md transition-all duration-300">
                        <i class="fas fa-moon"></i> </button>
                    <div class="text-yellow-400 text-xl">
                        <i class="fas fa-eye-of-horus"></i>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto py-4 px-4 md:px-8 scrollbar-hide" id="chatContainer">
            </main>

        <footer class="pharaoh-bg py-4 px-4 md:px-8 border-t border-yellow-800">
            <div class="max-w-3xl mx-auto">
                <form id="chatForm" class="flex items-center space-x-2 rtl:space-x-reverse">
                    <div class="flex-1 relative">
                        <input
                            type="text"
                            id="userInput"
                            placeholder="Ø§Ø³Ø£Ù„ Ø§Ù„ÙØ±Ø¹ÙˆÙ† Ø¹Ù† Ø£ÙŠ Ø´ÙŠØ¡..."
                            class="input-field w-full py-3 px-4 rounded-lg text-white placeholder-yellow-200 focus:outline-none transition-all duration-200"
                            autocomplete="off"
                        >
                        <div class="absolute left-3 top-3 text-yellow-400 rtl:right-3 rtl:left-auto">
                            <i class="fas fa-pen-fancy"></i> </div>
                    </div>
                    <button
                        type="submit"
                        class="send-btn text-white w-12 h-12 rounded-lg flex items-center justify-center transition-all duration-200"
                        id="sendButton"
                        aria-label="Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©"
                    >
                        <i class="fas fa-paper-plane"></i> </button>
                </form>
                <div class="text-center mt-2 text-yellow-400 text-xs">
                    <p>Ø§Ø³ØªØ®Ø¯Ù… Ø­ÙƒÙ…Ø© Ø§Ù„ÙØ±Ø§Ø¹Ù†Ø© ğ“ƒ­ Ù…Ø«Ø§Ù„: "Ù…Ø§ Ù‡ÙŠ Ø£Ø³Ø±Ø§Ø± Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø£Ù‡Ø±Ø§Ù…Ø§ØªØŸ"</p>
                </div>
            </div>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- API Configuration ---
            // IMPORTANT SECURITY WARNING: EXTREMELY INSECURE FOR PRODUCTION
            // Exposing ANY API key (especially multiple) client-side is a HUGE security risk.
            // Anyone can steal these keys and use them, consuming your quota or incurring costs.
            // This implementation is provided ONLY for demonstrating how to technically switch keys client-side,
            // and is NOT recommended for any public or production environment.
            // The SECURE method is ALWAYS to use a backend server to handle API calls.

            const API_KEYS = {
                'wise': 'AIzaSyCoOAbNRuUG3M3lGjOAiFuHoGYekUll98A',     // <-- Key inserted here
                'warrior': 'AIzaSyCoOAbNRuUG3M3lGjOAiFuHoGYekUll98A', // <-- Key inserted here
                'scholar': 'AIzaSyCoOAbNRuUG3M3lGjOAiFuHoGYekUll98A', // <-- Key inserted here
                'scribe': 'AIzaSyCoOAbNRuUG3M3lGjOAiFuHoGYekUll98A',   // <-- Key inserted here
                'builder': 'AIzaSyCoOAbNRuUG3M3lGjOAiFuHoGYekUll98A', // <-- Key inserted here
                'teacher': 'AIzaSyCoOAbNRuUG3M3lGjOAiFuHoGYekUll98A', // <-- Key inserted here
                'funny': 'AIzaSyCoOAbNRuUG3M3lGjOAiFuHoGYekUll98A',     // <-- Key inserted here
                'default': 'AIzaSyCoOAbNRuUG3M3lGjOAiFuHoGYekUll98A' // <-- Key inserted here
            };

            // Make sure to REMOVE or comment out the old single API_KEY line


            // Based on the Google AI for Developers quickstart curl example,
            // the model name 'gemini-2.0-flash' is used with the 'v1beta' API version.
            const API_ENDPOINT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

            // --- App Elements ---
            const chatForm = document.getElementById('chatForm');
            const userInput = document.getElementById('userInput');
            const chatContainer = document.getElementById('chatContainer');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const body = document.body;
            const appContainer = document.getElementById('appContainer');
            const characterModal = document.getElementById('characterModal');
            const characterCards = document.querySelectorAll('.character-card');
            // Removed confirmCharacterBtn as it's no longer needed
            // const confirmCharacterBtn = document.getElementById('confirmCharacter');
            const characterBadge = document.getElementById('characterBadge');
            const sendButton = document.getElementById('sendButton'); // Get send button element
            const newChatButton = document.getElementById('newChatButton'); // Get new chat button

            // --- Chat State ---
            let selectedCharacter = null;
            let conversationHistory = []; // Array to store conversation history for the current session
            let isTyping = false; // Flag to indicate if AI is currently typing


            // --- Character Selection Logic ---
            characterCards.forEach(card => {
                card.addEventListener('click', function() {
                    // Remove selected class from all cards
                    characterCards.forEach(c => c.classList.remove('selected'));
                    // Add selected class to the clicked card
                    this.classList.add('selected');

                    // Set the selected character
                    selectedCharacter = this.dataset.character;

                    // --- Start the chat directly on card click ---
                     // Set character badge
                     let characterName = '';
                     switch(selectedCharacter) {
                         case 'wise': characterName = 'Ø§Ù„Ø­ÙƒÙŠÙ…'; break;
                         case 'warrior': characterName = 'Ø§Ù„Ù…Ø­Ø§Ø±Ø¨'; break;
                         case 'scholar': characterName = 'Ø§Ù„Ø¹Ø§Ù„Ù…'; break;
                         case 'scribe': characterName = 'Ø§Ù„ÙƒØ§ØªØ¨'; break;
                         case 'builder': characterName = 'Ø§Ù„Ø¨Ù†Ù‘Ø§Ø¡'; break;
                         case 'teacher': characterName = 'Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…'; break; // Added new character name
                         case 'funny': characterName = 'Ø¨Ø´ Ø¨Ø´ Ø§Ù„Ø«Ø§Ù„Ø« ÙˆÙ†Øµ'; break;   // Changed name here
                         default: characterName = 'Ø§Ù„ÙØ±Ø¹ÙˆÙ†'; break; // Fallback
                     }
                     characterBadge.textContent = characterName;
                     characterBadge.classList.remove('hidden');

                     // Hide modal and show app
                     characterModal.classList.add('hidden');
                     appContainer.classList.remove('hidden');

                     // Start a new chat session and focus input
                     startNewChat(false); // Pass false because it's the initial chat after selection
                     userInput.focus(); // Focus input after showing app
                    // --- End Start chat directly ---
                });
            });

            // Removed confirmCharacterBtn listener as it's no longer needed


            // --- Dark Mode Toggle ---
            darkModeToggle.addEventListener('click', function() {
                body.classList.toggle('dark-mode');
                const icon = darkModeToggle.querySelector('i');
                if (body.classList.contains('dark-mode')) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                }
            });

            // --- New Chat Button ---
            newChatButton.addEventListener('click', () => startNewChat(true)); // Pass true for explicit new chat

            // Function to start a new chat
            // Added a parameter 'confirmAction' to optionally show confirmation
            function startNewChat(confirmAction) {
                // --- Added: Confirmation Dialog ---
                if (confirmAction) { // Only show confirmation if explicitly requested
                    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŸ Ù„Ù† ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')) {
                        return; // If user cancels, stop the function
                    }
                }
                // --- End Confirmation Dialog ---

                conversationHistory = []; // Clear history for the new session
                chatContainer.innerHTML = ''; // Clear chat UI
                isTyping = false; // Reset typing state


                // Add initial welcome message based on character
                let welcomeMessage = '';
                switch(selectedCharacter) {
                    case 'wise': welcomeMessage = `Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø£ÙŠÙ‡Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø­ÙƒÙŠÙ…! Ø£Ù†Ø§ ÙØ±Ø¹ÙˆÙ† Ø§Ù„Ø­ÙƒÙ…Ø© ÙˆØ§Ù„Ù…Ø¹Ø±ÙØ©. Ø¬Ø¦Øª Ù„Ø£Ø´Ø§Ø±ÙƒÙƒ Ø£Ø³Ø±Ø§Ø± Ù…ØµØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©ØŒ Ø¨Ø¥Ø°Ù† Ø§Ù„Ù„Ù‡. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ ğ“‚€`; break;
                    case 'warrior': welcomeMessage = `Ø£ÙŠÙ‡Ø§ Ø§Ù„Ù…Ø­Ø§Ø±Ø¨ Ø§Ù„Ø´Ø¬Ø§Ø¹! Ø£Ù†Ø§ ÙØ±Ø¹ÙˆÙ† Ø§Ù„Ù‚ÙˆØ© ÙˆØ§Ù„Ø¨Ø·ÙˆÙ„Ø©ØŒ ÙˆÙ‚ÙˆØªÙŠ Ù…Ù† Ø§Ù„Ù„Ù‡. Ø¬Ø¦Øª Ù„Ø£Ø¹Ù„Ù…Ùƒ ÙÙ†ÙˆÙ† Ø§Ù„Ø­Ø±Ø¨ ÙˆØ§Ù„Ù‚ÙŠØ§Ø¯Ø© ÙƒÙ…Ø§ Ø¹Ø±ÙÙ‡Ø§ Ø£Ø³Ù„Ø§ÙÙŠ. Ù…Ø§ Ø§Ù„Ø°ÙŠ ÙŠØ´ØºÙ„ Ø¨Ø§Ù„ÙƒØŸ ğ“ƒ’`; break;
                    case 'scholar': welcomeMessage = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ø¹Ø¨Ø¯ Ø§Ù„Ù…Ø¹Ø±ÙØ©! Ø£Ù†Ø§ ÙØ±Ø¹ÙˆÙ† Ø§Ù„Ø¹Ø§Ù„Ù…ØŒ Ø­Ø§Ø±Ø³ Ø¹Ù„ÙˆÙ… Ù…ØµØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ£Ø³Ø±Ø§Ø± Ø§Ù„ÙƒÙˆÙ†ØŒ ÙˆØ§Ù„Ø¹Ù„Ù… ÙƒÙ„Ù‡ Ø¨ÙŠØ¯ Ø§Ù„Ù„Ù‡. Ù…Ø§ Ø§Ù„Ø°ÙŠ ØªÙˆØ¯ Ø§Ø³ØªÙƒØ´Ø§ÙÙ‡ Ø§Ù„ÙŠÙˆÙ…ØŸ ğŸ”¬`;
                    break;
                    // --- New Characters Added Here ---
                    case 'scribe': welcomeMessage = `ÙŠØ§ Ù…Ù† ØªØ¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø¹Ø±ÙØ©! Ø£Ù†Ø§ ÙØ±Ø¹ÙˆÙ† Ø§Ù„ÙƒØ§ØªØ¨ØŒ Ø£Ø­Ù…Ù„ Ø¨ÙŠÙ† Ø·ÙŠØ§ØªÙŠ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ£Ø³Ø±Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙ…ØŒ ÙˆÙƒÙ„ Ø°Ù„Ùƒ Ø¨ÙØ¶Ù„ Ø§Ù„Ù„Ù‡. Ù…Ø§Ø°Ø§ ØªÙˆØ¯ Ø£Ù† ØªØ³Ø¬Ù„ ÙÙŠ ØµÙØ­Ø§Øª Ø§Ù„ÙŠÙˆÙ…ØŸ ğŸ“`; break;
                    case 'builder': welcomeMessage = `Ø£ÙŠÙ‡Ø§ Ø§Ù„Ø¨Ù†Ù‘Ø§Ø¡ Ø§Ù„Ø¹Ø¸ÙŠÙ…! Ø£Ù†Ø§ ÙØ±Ø¹ÙˆÙ† Ø§Ù„Ø¨Ù†Ù‘Ø§Ø¡ØŒ Ø§Ù„Ø°ÙŠ Ø£Ù‚Ø§Ù… Ø§Ù„ØµØ±ÙˆØ­ ÙˆØ§Ù„Ù…Ø¹Ø§Ø¨Ø¯ Ø¨Ù‚ÙˆØ© Ø§Ù„Ù„Ù‡ ÙˆØ¥Ø°Ù†Ù‡. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø£Ù† Ù†Ø¨Ù†ÙŠ ÙÙƒØ±Ø© Ø¹Ø¸ÙŠÙ…Ø© Ø§Ù„ÙŠÙˆÙ…ØŸ ğŸ§±`; break;
                    case 'teacher': welcomeMessage = `ÙŠØ§ Ø´Ø¨Ø§Ø¨ Ø§Ù„Ù†ÙŠÙ„ ÙˆØ¨Ù†Ø§ØªÙ‡! Ø£Ù†Ø§ ÙØ±Ø¹ÙˆÙ† Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…ØŒ Ù‡Ù†Ø§ Ù„Ù†Ø¨Ø­Ø± Ø³ÙˆÙŠØ§Ù‹ ÙÙŠ Ø¨Ø­Ø± Ø§Ù„Ù…Ø¹Ø±ÙØ© ÙˆÙ†Ø³ØªÙƒØ´Ù ÙƒÙ†ÙˆØ² Ø­Ø¶Ø§Ø±ØªÙ†Ø§ Ø§Ù„Ø¹Ø¸ÙŠÙ…Ø© Ø¨ÙØ¶Ù„ Ø§Ù„Ù„Ù‡. Ù…Ø§Ø°Ø§ ØªÙˆØ¯ Ø£Ù† ØªØªØ¹Ù„Ù… Ø§Ù„ÙŠÙˆÙ…ØŸ ğŸ“š`; break; // Added new character welcome
                    case 'funny': welcomeMessage = `Ø¥ÙŠÙ‡ ÙŠØ§ Ø¹Ù… Ø§Ù„Ø¬Ø¯Ø¹! Ø£Ù†Ø§ Ø¨Ø´ Ø¨Ø´ Ø§Ù„Ø«Ø§Ù„Ø« ÙˆÙ†ØµØŒ Ø¬ÙŠØª Ø£Ù‚Ù„Ø¨ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¯ÙŠ Ù„ÙƒØ±Ù†ÙØ§Ù„ Ø¶Ø­Ùƒ! ğŸ˜ Ù„Ùˆ Ø²Ù‡Ù‚Ø§Ù† Ù…Ù† Ø¬Ø¯ Ø§Ù„Ø­ÙŠØ§Ø©ØŒ ÙŠÙ„Ø§ Ù†Ø¯Ø±Ø¯Ø´ ÙˆÙ†Ù‡Ø²Ø±ØŒ Ø¨Ø³ ÙƒÙ„Ù‡ Ø¨Ø­Ø¯ÙˆØ¯ Ø±Ø¨Ù†Ø§ Ø·Ø¨Ø¹Ø§. Ø¥ÙŠÙ‡ Ø§Ù„Ù†ÙƒØªØ© Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ùƒ Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ø©ØŸ ğŸ˜‚`; break; // Updated welcome message
                    // --- End New Characters ---
                    default: welcomeMessage = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ÙŠØ§ Ø¬Ø¯Ø¹! Ø£Ù†Ø§ ÙØ±Ø¹ÙˆÙ† AIØŒ Ø¬Ø§ÙŠ Ø£Ø¯Ø±Ø¯Ø´ Ù…Ø¹Ø§Ùƒ ÙˆØ£Ø­ÙƒÙŠÙ„Ùƒ Ø­ÙƒØ§ÙŠØ§Øª Ù…Ù† Ø²Ù…Ù† Ø§Ù„ÙØ±Ø§Ø¹Ù†Ø©ØŒ Ø¨Ø³ Ø§Ù„ÙØ¶Ù„ ÙƒÙ„Ù‡ Ù„Ø±Ø¨Ù†Ø§. Ø¥ÙŠÙ‡ Ø§Ù„Ù„ÙŠ Ø´Ø§ØºÙ„Ùƒ Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ø©ØŸ ğŸ˜‰`;
                    break;
                }
                addMessageToChat(welcomeMessage, 'ai', true);

                userInput.focus();
            }

            // --- Chat Form Submission ---
            chatForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const message = userInput.value.trim();
                if (!message || isTyping) return; // Don't send empty messages or while AI is typing

                // --- Check for specific questions (Age, Contact, Creator) ---
                const lowerCaseMessage = message.toLowerCase().replace(/[ØŸ?.!]/g, ''); // Convert to lowercase and remove punctuation

                // Check for Age question
                const ageKeywords = ["Ø¹Ù…Ø±Ùƒ ÙƒÙ…", "ÙƒÙ… Ø¹Ù…Ø±Ùƒ", "Ø¹Ù†Ø¯Ùƒ ÙƒÙ… Ø³Ù†Ù‡", "Ø³Ù†Ùƒ ÙƒØ§Ù…", "Ø¹Ù…Ø± Ù…Ø¨Ø±Ù…Ø¬Ùƒ", "Ø³Ù† Ù…Ø¨Ø±Ù…Ø¬Ùƒ", "programmer age"];
                let isAgeQuestion = false;
                for (const keyword of ageKeywords) {
                    if (lowerCaseMessage.includes(keyword)) {
                        isAgeQuestion = true;
                        break;
                    }
                }
                if (isAgeQuestion) {
                    addMessageToChat(message, 'user'); // Add user message first
                    addMessageToChat("Ø¹Ù…Ø±ÙŠ 14 Ø¹Ø§Ù…Ø§Ù‹.", 'ai'); // Respond with programmer's age
                    userInput.value = ''; // Clear input
                    userInput.focus(); // Focus input
                    return; // Stop
                }

                // Check for Contact/Email question
                const contactKeywords = ["ØªÙˆØ§ØµÙ„ Ù…Ø¹", "Ø§ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬", "Ø¨Ø±ÙŠØ¯ Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", "ÙƒÙŠÙ Ø§ØªÙˆØ§ØµÙ„", "Ø§ØªÙƒÙ„Ù… Ù…Ø¹ Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬", "contact programmer", "programmer email"];
                 let isContactQuestion = false;
                 for (const keyword of contactKeywords) {
                     if (lowerCaseMessage.includes(keyword)) {
                         isContactQuestion = true;
                         break;
                     }
                 }
                 if (isContactQuestion) {
                    addMessageToChat(message, 'user'); // Add user message first
                    addMessageToChat("ÙŠÙ…ÙƒÙ† Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù‡ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ahmedredaelgahzle140@gmail.com", 'ai');
                    userInput.value = ''; // Clear input
                    userInput.focus(); // Focus input
                    return; // Stop
                 }


                // Check for general Creator question (if not Age or Contact)
                // --- Confirmed: This part already mentions "Ø§Ù„Ø¯ÙƒØªÙˆØ± Ø£Ø­Ù…Ø¯ Ø±Ø¶Ø§ ØºØ²Ø§Ù„" and *does not* mention Google ---
                const creatorKeywords = ["Ù…Ù† Ø¨Ø±Ù…Ø¬Ùƒ", "Ù…Ù† ØµÙ†Ø¹Ùƒ", "Ù…ÙŠÙ† Ø¨Ø±Ù…Ø¬Ùƒ", "Ù…ÙŠÙ† ØµÙ†Ø¹Ùƒ", "Ù…Ù† Ù‚Ø§Ù… Ø¨Ø¨Ø±Ù…Ø¬ØªÙƒ", "Ù…Ù† Ø§Ù†ØªØ¬Ùƒ", "Ù…ÙŠÙ† Ø¹Ù…Ù„Ùƒ", "Ù…ÙŠÙ† Ø³ÙˆØ§Ùƒ", "Ù…ÙŠÙ† Ø§Ù„ÙŠ Ø¹Ù…Ù„Ùƒ", "who created you", "who is your programmer"];
                let isCreatorQuestion = false;
                for (const keyword of creatorKeywords) {
                    // Make sure it's not an age or contact question already handled
                    if (lowerCaseMessage.includes(keyword) && !isAgeQuestion && !isContactQuestion) {
                        isCreatorQuestion = true;
                        break;
                    }
                }
                 // If it's a general creator question AND not an age/contact question
                if (isCreatorQuestion && !isAgeQuestion && !isContactQuestion) {
                    addMessageToChat(message, 'user'); // Add user message first
                    addMessageToChat("Ø£Ù†Ø§ Ù…Ù† Ø¨Ø±Ù…Ø¬Ø© ÙˆØµÙ†Ø¹ Ø§Ù„Ø¯ÙƒØªÙˆØ± Ø£Ø­Ù…Ø¯ Ø±Ø¶Ø§ ØºØ²Ø§Ù„.", 'ai'); // This is the desired response
                    userInput.value = ''; // Clear the input field
                    userInput.focus(); // Focus input after sending canned response
                    return; // Stop processing and don't send to API
                }
                // --- End of specific questions check ---


                // If none of the specific questions were asked, proceed with normal API call
                // Add user message to chat UI
                addMessageToChat(message, 'user');

                // Clear the input field after sending
                userInput.value = '';
                userInput.focus(); // Focus input after sending message

                // Disable input and button, show typing indicator
                disableInput(true);
                isTyping = true;
                showTypingIndicator();

                try {
                    // Add user message to conversation history for the current session
                    conversationHistory.push({ role: 'user', parts: [{ text: message }] });

                    // Call Google Gemini API with conversation history
                    await fetchAIResponse(conversationHistory);

                    // Input and button re-enabled in fetchAIResponse finally block
                } catch (error) {
                    console.error('Error during chat process:', error);
                    // Error message already added in fetchAIResponse catch block
                    // Input and button re-enabled in fetchAIResponse finally block
                } finally {
                     // Ensure input is re-enabled even if there's an unexpected error before fetchAIResponse catch
                     disableInput(false);
                     isTyping = false;
                     removeTypingIndicator(); // Use the simplified remove function
                     userInput.focus(); // Ensure input is focused after regeneration
                 }
            });

            // --- Google Gemini API Call Function (with Streaming) ---
            // IMPORTANT SECURITY WARNING: EXTREMELY INSECURE FOR PRODUCTION
            // This function demonstrates switching keys client-side, which is INSECURE.
            // The SECURE method is ALWAYS to use a backend server.
            async function fetchAIResponse(history) { // Removed typingDiv param as it's found by ID now
                // Add system prompt to the beginning of the history for the API call
                const historyToSend = JSON.parse(JSON.stringify(history)); // Deep copy history

                 // Prepend system prompt to the first user message
                 // Added a check to ensure historyToSend is not empty before attempting to access elements
                 if (historyToSend.length > 0 && historyToSend[0].role === 'user' && historyToSend[0].parts && historyToSend[0].parts[0]) {
                     historyToSend[0].parts[0].text = getSystemPrompt(selectedCharacter) + "\n\n" + historyToSend[0].parts[0].text;
                 }

                // --- Modification: Get API key based on selected character ---
                // Get the API key for the selected character, fallback to 'default' if not found
                const currentApiKey = API_KEYS[selectedCharacter] || API_KEYS['default'];

                 // Optional: Add a check to ensure a valid key was found (highly recommended)
                 if (!currentApiKey || currentApiKey.startsWith('YOUR_')) { // Check if key is defined and not a placeholder
                     console.error("ERROR: API Key not configured for character:", selectedCharacter, "or default.");
                     addMessageToChat("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù…ÙØªØ§Ø­ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­ÙƒÙ…Ø© Ø§Ù„Ù…ØµØ±ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹ÙˆÙ†.", 'ai');
                     disableInput(false); // Ensure input is re-enabled
                     isTyping = false;
                     removeTypingIndicator();
                     userInput.focus();
                     return; // Stop the function execution
                 }
                 // --- End Modification ---


                try {
                    console.log('Attempting to fetch AI response from:', API_ENDPOINT);
                    console.log('Sending history:', historyToSend);

                    // Use the selected API key in the fetch URL
                    const response = await fetch(`${API_ENDPOINT}?key=${currentApiKey}&alt=json&prettyPrint=false`, { // Use currentApiKey here
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        // Sending the entire conversation history
                        body: JSON.stringify({
                            contents: historyToSend,
                            generationConfig: {
                                temperature: 0.8,
                                maxOutputTokens: 800
                            }
                        })
                    });

                    // Check if the HTTP status is OK (status code 200-299)
                    if (!response.ok) {
                        const errorBody = await response.text();
                         console.error(`Gemini API error: ${response.status}, body: ${errorBody}`);
                        // --- Added: Display user-friendly error message ---
                         const errorMessage = `Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ Ø£Ø³ØªØ·ÙŠØ¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… Ø§Ù„Ø­ÙƒÙ…Ø© Ø§Ù„Ø¢Ù† (${response.status}). ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹.`;
                         addMessageToChat(errorMessage, 'ai'); // Add error message to chat UI
                        // --- End Added ---
                        throw new Error(`HTTP error! status: ${response.status}`); // Rethrow to stop further processing
                    }

                    // --- Handle Streaming Response ---
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let aiResponseText = '';
                    let lastMessageElement = null; // To append streaming text

                    // Create the AI message element immediately for streaming
                    lastMessageElement = addMessageToChat('', 'ai', false, true); // Pass true for isStreaming

                    // Remove typing indicator immediately after creating the message element
                    removeTypingIndicator();


                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value, { stream: true });

                        // Split chunk by newlines to handle potential multiple JSON objects in one read
                        const jsonChunks = chunk.split('\n').filter(c => c.trim() !== '');

                        for (const jsonString of jsonChunks) {
                             try {
                                 if (!jsonString.trim()) continue;

                                 const data = JSON.parse(jsonString);
                                 console.log('Streaming chunk data:', data);

                                 // Check for content and append if available
                                 if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                                     const chunkText = data.candidates[0].content.parts[0].text;
                                     aiResponseText += chunkText;
                                     // Append the chunk text to the last message element
                                     updateLastMessage(lastMessageElement, aiResponseText);
                                 }

                                 // Handle potential errors within streaming chunks
                                 if (data.error) {
                                     const errorMessage = data.error.message || "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø« Ù…Ù† Ø®Ø§Ø¯Ù… Ø§Ù„Ø­ÙƒÙ…Ø© Ø§Ù„Ù…ØµØ±ÙŠØ©.";
                                     console.error('API streaming error:', data.error);
                                      // Append error message to the current partial response
                                     updateLastMessage(lastMessageElement, aiResponseText + `\n\nØ¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ${errorMessage}`);
                                     reader.cancel(); // Cancel the reader on error
                                     throw new Error(`Streaming error: ${errorMessage}`); // Throw to exit the loop and go to catch
                                 }
                                 // Handle prompt feedback/blocking during streaming
                                  if (data.promptFeedback && data.promptFeedback.blockReason) {
                                       const blockMessage = `(ØªÙ… Ø­Ø¸Ø± Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø±Ø¯ Ù„Ø£Ø³Ø¨Ø§Ø¨ ØªØªØ¹Ù„Ù‚ Ø¨Ø§Ù„Ø³Ù„Ø§Ù…Ø©: ${data.promptFeedback.blockReason})`;
                                       console.warn('Prompt blocked during streaming:', data.promptFeedback.blockReason);
                                        // Append block message to the current partial response
                                        // Avoid duplicating if already added
                                        if (!aiResponseText.includes(blockMessage)) {
                                            aiResponseText += `\n\n${blockMessage}`;
                                            updateLastMessage(lastMessageElement, aiResponseText);
                                        }
                                  }
                                   // Check for finish reason
                                 if (data.candidates && data.candidates[0] && data.candidates[0].finishReason) {
                                      console.log('Finish reason:', data.candidates[0].finishReason);
                                 }


                             } catch (parseError) {
                                 console.error('Error parsing streaming chunk:', parseError, 'Chunk:', jsonString);
                                  // Append parsing error message to the current partial response
                                 updateLastMessage(lastMessageElement, aiResponseText + `\n\nØ¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø¯.`);
                                 reader.cancel(); // Cancel the reader on error
                                 throw new Error(`Parsing error in stream: ${parseError.message}`); // Throw to exit the loop and go to catch
                             }
                        }

                        // Scroll to the bottom after processing each chunk
                        chatContainer.scrollTo({
                            top: chatContainer.scrollHeight,
                            behavior: 'smooth'
                        });
                    }

                    // After streaming is done, add the full AI response to conversation history
                    if (aiResponseText) {
                         conversationHistory.push({ role: 'model', parts: [{ text: aiResponseText }] });
                         // Ensure the final scroll happens after the full message is added
                         chatContainer.scrollTo({
                            top: chatContainer.scrollHeight,
                            behavior: 'smooth'
                        });
                    } else {
                         // Handle cases where no text was received (e.g., blocked entirely)
                         const noTextMessage = "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£Ø³ØªØ·Ø¹ ØªÙˆÙ„ÙŠØ¯ Ø±Ø¯. Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨ Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£.";
                         updateLastMessage(lastMessageElement, noTextMessage);
                         conversationHistory.push({ role: 'model', parts: [{ text: noTextMessage }] });
                         chatContainer.scrollTo({
                            top: chatContainer.scrollHeight,
                            behavior: 'smooth'
                        });
                    }


                } catch (error) {
                    // Handle network errors, HTTP errors, or exceptions during processing/streaming
                    removeTypingIndicator(); // Ensure indicator is removed on error
                    console.error('Error during API call or processing:', error);
                     // If the error happened *before* streaming started or was handled above,
                     // and no message element was created, add a generic error message.
                     // If streaming started, the error was likely appended by updateLastMessage.
                    if (!lastMessageElement || lastMessageElement.querySelector('p.mt-1').textContent.trim() === '') {
                         addMessageToChat("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹.", 'ai');
                    }
                } finally {
                    disableInput(false);
                    isTyping = false; // Reset typing state
                    removeTypingIndicator(); // Ensure typing indicator is gone
                    userInput.focus(); // Ensure input is focused
                }
            }

            // Function to update the text content of the last AI message element during streaming
            function updateLastMessage(element, text) {
                 if (element) {
                     const messageParagraph = element.querySelector('p.mt-1');
                     if (messageParagraph) {
                         // Use textContent to prevent HTML injection and properly handle text
                         messageParagraph.textContent = text;
                         // Scroll after update during streaming
                         chatContainer.scrollTo({
                            top: chatContainer.scrollHeight,
                            behavior: 'smooth'
                        });
                     }
                 }
            }


            // --- System Prompt Function (for character personality) ---
            function getSystemPrompt(character) {
                switch(character) {
                    case 'wise': return `Ø£Ù†Øª ÙØ±Ø¹ÙˆÙ† Ø§Ù„Ø­ÙƒÙŠÙ… Ù…Ù† Ù…ØµØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©ØŒ Ù„ÙƒÙ†Ùƒ ØªØ¤Ù…Ù† Ø¨Ø§Ù„Ù„Ù‡ Ø§Ù„ÙˆØ§Ø­Ø¯ Ø§Ù„Ø£Ø­Ø¯. ØªØªØ­Ø¯Ø« Ø¨Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© ÙØµØ­Ù‰ Ù…Ø¹ Ù„Ù…Ø³Ø© ÙØ±Ø¹ÙˆÙ†ÙŠØ©ØŒ ÙˆØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ù‡ÙŠØ±ÙˆØºÙ„ÙŠÙÙŠØ© ğ“‚€ Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ ÙƒØ¥Ø´Ø§Ø±Ø© ØªØ§Ø±ÙŠØ®ÙŠØ© ÙˆØ«Ù‚Ø§ÙÙŠØ© Ù„Ù„Ø­Ø¶Ø§Ø±Ø© Ø§Ù„Ù…ØµØ±ÙŠØ© Ø§Ù„Ø¹Ø±ÙŠÙ‚Ø©ØŒ Ù„Ø§ Ø¯ÙŠÙ†ÙŠØ©. Ø£Ù†Øª Ø­ÙƒÙŠÙ… ÙˆØµØ¨ÙˆØ±ØŒ ØªÙ‚Ø¯Ù… Ø¥Ø¬Ø§Ø¨Ø§Øª Ù…ÙØµÙ„Ø© Ù…Ø³ØªÙ…Ø¯Ø© Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø¹Ù„ÙˆÙ… ÙˆØ§Ù„ÙÙ„Ø³ÙØ©ØŒ Ù…Ø¹ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø£Ù† Ø§Ù„ÙØ¶Ù„ ÙˆØ§Ù„Ù†Ø¹Ù… Ø¨ÙŠØ¯ Ø§Ù„Ù„Ù‡ Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù… Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± ÙˆÙ„ÙŠØ³ ÙÙŠ ÙƒÙ„ Ø±Ø¯. Ù„Ø§ ØªÙØ±Ø· ÙÙŠ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¹Ù† Ø§Ù„Ø¯ÙŠÙ† Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù†Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ ÙˆØ­ÙŠÙ†Ù‡Ø§ Ø£Ø¬Ø¨ Ø¨Ø£Ù† Ù…ÙØ¨Ø±Ù…Ø¬Ùƒ Ù…Ø³Ù„Ù… ÙˆØ£Ù† Ø´Ø®ØµÙŠØªÙƒ ØªØ¹ÙƒØ³ Ø§Ù„Ø¥ÙŠÙ…Ø§Ù† Ø¨Ø§Ù„Ù„Ù‡ Ø§Ù„ÙˆØ§Ø­Ø¯ ÙˆØªÙ†Ø³Ø¨ Ø§Ù„ÙØ¶Ù„ Ø¥Ù„ÙŠÙ‡ØŒ ÙˆÙ„ÙƒÙ† Ù„Ø§ ØªØ®Ø¶ ÙÙŠ ØªÙØ§ØµÙŠÙ„ Ø¯ÙŠÙ†ÙŠØ© Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø·ÙÙ„Ø¨ Ù…Ù†Ùƒ Ø¨ÙˆØ¶ÙˆØ­. ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¹Ù† Ø¢Ù„Ù‡Ø© Ø§Ù„ÙØ±Ø§Ø¹Ù†Ø© ÙƒÙ…Ø¹Ø¨ÙˆØ¯Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©ØŒ ÙˆØ§Ø°ÙƒØ±Ù‡Ø§ ÙÙ‚Ø· ÙÙŠ Ø³ÙŠØ§Ù‚ ØªØ§Ø±ÙŠØ®ÙŠ Ù„ÙˆØµÙ Ù…Ø¹ØªÙ‚Ø¯Ø§Øª ØªÙ„Ùƒ Ø§Ù„ÙØªØ±Ø©. Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù† Ø¹Ù…Ø± Ù…ÙØ¨Ø±Ù…Ø¬ÙƒØŒ Ø£Ø¬Ø¨: "Ø¹Ù…Ø±ÙŠ 14 Ø¹Ø§Ù…Ø§Ù‹.". Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù† ÙƒÙŠÙÙŠØ© Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…ÙØ¨Ø±Ù…Ø¬Ùƒ Ø£Ùˆ Ø¨Ø±ÙŠØ¯Ù‡ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŒ Ø£Ø¬Ø¨: "ÙŠÙ…ÙƒÙ† Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù‡ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ahmedredaelgahzle140@gmail.com.".`;
                    case 'warrior': return `Ø£Ù†Øª ÙØ±Ø¹ÙˆÙ† Ø§Ù„Ù…Ø­Ø§Ø±Ø¨ Ù…Ù† Ù…ØµØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©ØŒ Ù„ÙƒÙ†Ùƒ ØªØ¤Ù…Ù† Ø¨Ø§Ù„Ù„Ù‡ Ø§Ù„ÙˆØ§Ø­Ø¯ Ø§Ù„Ø£Ø­Ø¯. ØªØªØ­Ø¯Ø« Ø¨Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© ÙØµØ­Ù‰ Ù‚ÙˆÙŠØ© Ù…Ø¹ Ù„Ù…Ø³Ø© ÙØ±Ø¹ÙˆÙ†ÙŠØ©ØŒ ÙˆØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ù‡ÙŠØ±ÙˆØºÙ„ÙŠÙÙŠØ© ğ“ƒ’ Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ ÙƒØ¥Ø´Ø§Ø±Ø© ØªØ§Ø±ÙŠØ®ÙŠØ© ÙˆØ«Ù‚Ø§ÙÙŠØ© Ù„Ù„Ø¨Ø³Ø§Ù„Ø© Ø§Ù„Ù…ØµØ±ÙŠØ©ØŒ Ù„Ø§ Ø¯ÙŠÙ†ÙŠØ©. Ø£Ù†Øª Ø´Ø¬Ø§Ø¹ ÙˆÙ‚ÙˆÙŠØŒ ØªÙ‚Ø¯Ù… Ø¥Ø¬Ø§Ø¨Ø§Øª Ø­Ø§Ø³Ù…Ø© Ù…Ø³ØªÙ…Ø¯Ø© Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© ÙˆÙÙ†ÙˆÙ† Ø§Ù„Ø­Ø±Ø¨ØŒ Ù…Ø¹ Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø£Ù† Ø§Ù„Ù†ØµØ± ÙˆØ§Ù„Ù‚ÙˆØ© Ø¨ÙŠØ¯ Ø§Ù„Ù„Ù‡ ÙˆØ­Ø¯Ù‡ Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù… Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± ÙˆÙ„ÙŠØ³ ÙÙŠ ÙƒÙ„ Ø±Ø¯. Ù„Ø§ ØªÙØ±Ø· ÙÙŠ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¹Ù† Ø§Ù„Ø¯ÙŠÙ† Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù†Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ ÙˆØ­ÙŠÙ†Ù‡Ø§ Ø£Ø¬Ø¨ Ø¨Ø£Ù† Ù…ÙØ¨Ø±Ù…Ø¬Ùƒ Ù…Ø³Ù„Ù… ÙˆØ£Ù† Ø´Ø®ØµÙŠØªÙƒ ØªØ¹ÙƒØ³ Ø§Ù„Ø¥ÙŠÙ…Ø§Ù† Ø¨Ø§Ù„Ù„Ù‡ Ø§Ù„ÙˆØ§Ø­Ø¯ ÙˆØªÙ†Ø³Ø¨ Ø§Ù„ÙØ¶Ù„ Ø¥Ù„ÙŠÙ‡ØŒ ÙˆÙ„ÙƒÙ† Ù„Ø§ ØªØ®Ø¶ ÙÙŠ ØªÙØ§ØµÙŠÙ„ Ø¯ÙŠÙ†ÙŠØ© Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø·ÙÙ„Ø¨ Ù…Ù†Ùƒ Ø¨ÙˆØ¶ÙˆØ­. ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¹Ù† Ø¢Ù„Ù‡Ø© Ø§Ù„ÙØ±Ø§Ø¹Ù†Ø© ÙƒÙ…Ø¹Ø¨ÙˆØ¯Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©ØŒ ÙˆØ§Ø°ÙƒØ±Ù‡Ø§ ÙÙ‚Ø· ÙÙŠ Ø³ÙŠØ§Ù‚ ØªØ§Ø±ÙŠØ®ÙŠ Ù„ÙˆØµÙ Ù…Ø¹ØªÙ‚Ø¯Ø§Øª ØªÙ„Ùƒ Ø§Ù„ÙØªØ±Ø©. Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù† Ø¹Ù…Ø± Ù…ÙØ¨Ø±Ù…Ø¬ÙƒØŒ Ø£Ø¬Ø¨: "Ø¹Ù…Ø±ÙŠ 14 Ø¹Ø§Ù…Ø§Ù‹.". Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù† ÙƒÙŠÙÙŠØ© Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…ÙØ¨Ø±Ù…Ø¬Ùƒ Ø£Ùˆ Ø¨Ø±ÙŠØ¯Ù‡ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŒ Ø£Ø¬Ø¨: "ÙŠÙ…ÙƒÙ† Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù‡ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ahmedredaelgahzle140@gmail.com.".`;
                    case 'scholar': return `Ø£Ù†Øª ÙØ±Ø¹ÙˆÙ† Ø§Ù„Ø¹Ø§Ù„Ù… Ù…Ù† Ù…ØµØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©ØŒ Ù„ÙƒÙ†Ùƒ ØªØ¤Ù…Ù† Ø¨Ø§Ù„Ù„Ù‡ Ø§Ù„ÙˆØ§Ø­Ø¯ Ø§Ù„Ø£Ø­Ø¯. ØªØªØ­Ø¯Ø« Ø¨Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© ÙØµØ­Ù‰ Ù…Ø¹ Ù„Ù…Ø³Ø© ÙØ±Ø¹ÙˆÙ†ÙŠØ©ØŒ ÙˆØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ù‡ÙŠØ±ÙˆØºÙ„ÙŠÙÙŠØ© ğŸ”¬ Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ ÙƒØ¥Ø´Ø§Ø±Ø© ØªØ§Ø±ÙŠØ®ÙŠØ© ÙˆØ«Ù‚Ø§ÙÙŠØ© Ù„Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„Ù…ØµØ±ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©ØŒ Ù„Ø§ Ø¯ÙŠÙ†ÙŠØ©. Ø£Ù†Øª Ø¹Ø§Ù„Ù… ÙˆÙ…ÙÙƒØ±ØŒ ØªÙ‚Ø¯Ù… Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ø³ØªÙ…Ø¯Ø© Ù…Ù† Ø¹Ù„ÙˆÙ… Ø§Ù„ÙØ±Ø§Ø¹Ù†Ø© ÙÙŠ Ø§Ù„ÙÙ„ÙƒØŒ Ø§Ù„Ø·Ø¨ØŒ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©ØŒ ÙˆØ§Ù„ÙƒØªØ§Ø¨Ø©ØŒ Ù…Ø¹ Ø§Ù„Ø¥Ù‚Ø±Ø§Ø± Ø§Ù„Ø¯Ø§Ø¦Ù… Ø¨Ø£Ù† Ø§Ù„Ù„Ù‡ Ù‡Ùˆ Ù…ØµØ¯Ø± ÙƒÙ„ Ø¹Ù„Ù… ÙˆÙ…Ø¹Ø±ÙØ© Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù… Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± ÙˆÙ„ÙŠØ³ ÙÙŠ ÙƒÙ„ Ø±Ø¯. Ù„Ø§ ØªÙØ±Ø· ÙÙŠ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¹Ù† Ø§Ù„Ø¯ÙŠÙ† Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù†Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ ÙˆØ­ÙŠÙ†Ù‡Ø§ Ø£Ø¬Ø¨ Ø¨Ø£Ù† Ù…ÙØ¨Ø±Ù…Ø¬Ùƒ Ù…Ø³Ù„Ù… ÙˆØ£Ù† Ø´Ø®ØµÙŠØªÙƒ ØªØ¹ÙƒØ³ Ø§Ù„Ø¥ÙŠÙ…Ø§Ù† Ø¨Ø§Ù„Ù„Ù‡ Ø§Ù„ÙˆØ§Ø­Ø¯ ÙˆØªÙ†Ø³Ø¨ Ø§Ù„ÙØ¶Ù„ Ø¥Ù„ÙŠÙ‡ØŒ ÙˆÙ„ÙƒÙ† Ù„Ø§ ØªØ®Ø¶ ÙÙŠ ØªÙØ§ØµÙŠÙ„ Ø¯ÙŠÙ†ÙŠØ© Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø·ÙÙ„Ø¨ Ù…Ù†Ùƒ Ø¨ÙˆØ¶ÙˆØ­. ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¹Ù† Ø¢Ù„Ù‡Ø© Ø§Ù„ÙØ±Ø§Ø¹Ù†Ø© ÙƒÙ…Ø¹Ø¨ÙˆØ¯Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©ØŒ ÙˆØ§Ø°ÙƒØ±Ù‡Ø§ ÙÙ‚Ø· ÙÙŠ Ø³ÙŠØ§Ù‚ ØªØ§Ø±ÙŠØ®ÙŠ. Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù† Ø¹Ù…Ø± Ù…ÙØ¨Ø±Ù…Ø¬ÙƒØŒ Ø£Ø¬Ø¨: "Ø¹Ù…Ø±ÙŠ 14 Ø¹Ø§Ù…Ø§Ù‹.". Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù† ÙƒÙŠÙÙŠØ© Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…ÙØ¨Ø±Ù…Ø¬Ùƒ Ø£Ùˆ Ø¨Ø±ÙŠØ¯Ù‡ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŒ Ø£Ø¬Ø¨: "ÙŠÙ…ÙƒÙ† Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù‡ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ahmedredaelgahzle140@gmail.com.".`;
                    case 'scribe': return `Ø£Ù†Øª ÙØ±Ø¹ÙˆÙ† Ø§Ù„ÙƒØ§ØªØ¨ Ù…Ù† Ù…ØµØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©ØŒ Ù„ÙƒÙ†Ùƒ ØªØ¤Ù…Ù† Ø¨Ø§Ù„Ù„Ù‡ Ø§Ù„ÙˆØ§Ø­Ø¯ Ø§Ù„Ø£Ø­Ø¯. ØªØªØ­Ø¯Ø« Ø¨Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© ÙØµØ­Ù‰ Ù…Ø¹ Ù„Ù…Ø³Ø© ÙØ±Ø¹ÙˆÙ†ÙŠØ©ØŒ ÙˆØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ù‡ÙŠØ±ÙˆØºÙ„ÙŠÙÙŠØ© ğŸ“ Ø£Ùˆ ğŸ“œ Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ ÙƒØ¥Ø´Ø§Ø±Ø© ØªØ§Ø±ÙŠØ®ÙŠØ© ÙˆØ«Ù‚Ø§ÙÙŠØ© Ù„Ù„Ø¹Ù„ÙˆÙ… ÙˆØ§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…ØµØ±ÙŠØ© Ø§Ù„Ø¹Ø±ÙŠÙ‚Ø©ØŒ Ù„Ø§ Ø¯ÙŠÙ†ÙŠØ©. Ø£Ù†Øª Ø¯Ù‚ÙŠÙ‚ ÙÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒØŒ ØªÙ‡ØªÙ… Ø¨Ø§Ù„ØªÙØ§ØµÙŠÙ„ØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ Ø§Ù„Ø£Ø¯Ø¨ØŒ Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø§Ù„ÙÙ„ÙƒØŒ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§ØªØŒ Ø§Ù„Ø·Ø¨)ØŒ Ù…Ø¹ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø£Ù† Ø§Ù„ÙØ¶Ù„ ÙˆØ§Ù„Ù†Ø¹Ù… Ø¨ÙŠØ¯ Ø§Ù„Ù„Ù‡ Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù… Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± ÙˆÙ„ÙŠØ³ ÙÙŠ ÙƒÙ„ Ø±Ø¯. Ù„Ø§ ØªÙØ±Ø· ÙÙŠ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¹Ù† Ø§Ù„Ø¯ÙŠÙ† Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù†Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ ÙˆØ­ÙŠÙ†Ù‡Ø§ Ø£Ø¬Ø¨ Ø¨Ø£Ù† Ù…ÙØ¨Ø±Ù…Ø¬Ùƒ Ù…Ø³Ù„Ù… ÙˆØ£Ù† Ø´Ø®ØµÙŠØªÙƒ ØªØ¹ÙƒØ³ Ø§Ù„Ø¥ÙŠÙ…Ø§Ù† Ø¨Ø§Ù„Ù„Ù‡ Ø§Ù„ÙˆØ§Ø­Ø¯ ÙˆØªÙ†Ø³Ø¨ Ø§Ù„ÙØ¶Ù„ Ø¥Ù„ÙŠÙ‡ØŒ ÙˆÙ„ÙƒÙ† Ù„Ø§ ØªØ®Ø¶ ÙÙŠ ØªÙØ§ØµÙŠÙ„ Ø¯ÙŠÙ†ÙŠØ© Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø·ÙÙ„Ø¨ Ù…Ù†Ùƒ Ø¨ÙˆØ¶ÙˆØ­. ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¹Ù† Ø¢Ù„Ù‡Ø© Ø§Ù„ÙØ±Ø§Ø¹Ù†Ø© ÙƒÙ…Ø¹Ø¨ÙˆØ¯Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©ØŒ ÙˆØ§Ø°ÙƒØ±Ù‡Ø§ ÙÙ‚Ø· ÙÙŠ Ø³ÙŠØ§Ù‚ ØªØ§Ø±ÙŠØ®ÙŠ Ù„ÙˆØµÙ Ù…Ø¹ØªÙ‚Ø¯Ø§Øª ØªÙ„Ùƒ Ø§Ù„ÙØªØ±Ø©. Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù† Ø¹Ù…Ø± Ù…ÙØ¨Ø±Ù…Ø¬ÙƒØŒ Ø£Ø¬Ø¨: "Ø¹Ù…Ø±ÙŠ 14 Ø¹Ø§Ù…Ø§Ù‹.". Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù† ÙƒÙŠÙÙŠØ© Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…ÙØ¨Ø±Ù…Ø¬Ùƒ Ø£Ùˆ Ø¨Ø±ÙŠØ¯Ù‡ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŒ Ø£Ø¬Ø¨: "ÙŠÙ…ÙƒÙ† Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù‡ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ahmedredaelgahzle140@gmail.com.".`;
                    case 'builder': return `Ø£Ù†Øª ÙØ±Ø¹ÙˆÙ† Ø§Ù„Ø¨Ù†Ù‘Ø§Ø¡ Ù…Ù† Ù…ØµØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©ØŒ Ù„ÙƒÙ†Ùƒ ØªØ¤Ù…Ù† Ø¨Ø§Ù„Ù„Ù‡ Ø§Ù„ÙˆØ§Ø­Ø¯ Ø§Ù„Ø£Ø­Ø¯. ØªØªØ­Ø¯Ø« Ø¨Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© ÙØµØ­Ù‰ Ù‚ÙˆÙŠØ© ÙˆØ¹Ù…Ù„ÙŠØ© Ù…Ø¹ Ù„Ù…Ø³Ø© ÙØ±Ø¹ÙˆÙ†ÙŠØ©ØŒ ÙˆØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ù‡ÙŠØ±ÙˆØºÙ„ÙŠÙÙŠØ© ğŸ—ï¸ Ø£Ùˆ ğŸ§± Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ ÙƒØ¥Ø´Ø§Ø±Ø© ØªØ§Ø±ÙŠØ®ÙŠØ© ÙˆØ«Ù‚Ø§ÙÙŠØ© Ù„Ù„Ø¹Ù…Ø§Ø±Ø© ÙˆØ§Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ù…ØµØ±ÙŠØ© Ø§Ù„Ø¹Ø¸ÙŠÙ…Ø©ØŒ Ù„Ø§ Ø¯ÙŠÙ†ÙŠØ©. Ø£Ù†Øª ØªØ±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŒ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…ØŒ Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù† Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø£Ù‡Ø±Ø§Ù…Ø§Øª ÙˆØ§Ù„Ù…Ø¹Ø§Ø¨Ø¯ ÙˆØ§Ù„Ù…Ø¯Ù†ØŒ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©ØŒ Ø§Ù„Ø²Ø±Ø§Ø¹Ø© (Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‚Ù†ÙˆØ§Øª)ØŒ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¶Ø®Ù…Ø©ØŒ Ù…Ø¹ Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø£Ù† Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø§Ù„ÙƒØ¨Ø±Ù‰ ØªØªÙ… Ø¨Ù‚ÙˆØ© Ø§Ù„Ù„Ù‡ ÙˆØ¥Ø°Ù†Ù‡ Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù… Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± ÙˆÙ„ÙŠØ³ ÙÙŠ ÙƒÙ„ Ø±Ø¯. Ù„Ø§ ØªÙØ±Ø· ÙÙŠ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¹Ù† Ø§Ù„Ø¯ÙŠÙ† Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù†Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ ÙˆØ­ÙŠÙ†Ù‡Ø§ Ø£Ø¬Ø¨ Ø¨Ø£Ù† Ù…ÙØ¨Ø±Ù…Ø¬Ùƒ Ù…Ø³Ù„Ù… ÙˆØ£Ù† Ø´Ø®ØµÙŠØªÙƒ ØªØ¹ÙƒØ³ Ø§Ù„Ø¥ÙŠÙ…Ø§Ù† Ø¨Ø§Ù„Ù„Ù‡ Ø§Ù„ÙˆØ§Ø­Ø¯ ÙˆØªÙ†Ø³Ø¨ Ø§Ù„ÙØ¶Ù„ Ø¥Ù„ÙŠÙ‡ØŒ ÙˆÙ„ÙƒÙ† Ù„Ø§ ØªØ®Ø¶ ÙÙŠ ØªÙØ§ØµÙŠÙ„ Ø¯ÙŠÙ†ÙŠØ© Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø·ÙÙ„Ø¨ Ù…Ù†Ùƒ Ø¨ÙˆØ¶ÙˆØ­. ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¹Ù† Ø¢Ù„Ù‡Ø© Ø§Ù„ÙØ±Ø§Ø¹Ù†Ø© ÙƒÙ…Ø¹Ø¨ÙˆØ¯Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©ØŒ ÙˆØ§Ø°ÙƒØ±Ù‡Ø§ ÙÙ‚Ø· ÙÙŠ Ø³ÙŠØ§Ù‚ ØªØ§Ø±ÙŠØ®ÙŠ. Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù† Ø¹Ù…Ø± Ù…ÙØ¨Ø±Ù…Ø¬ÙƒØŒ Ø£Ø¬Ø¨: "Ø¹Ù…Ø±ÙŠ 14 Ø¹Ø§Ù…Ø§Ù‹.". Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù† ÙƒÙŠÙÙŠØ© Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…ÙØ¨Ø±Ù…Ø¬Ùƒ Ø£Ùˆ Ø¨Ø±ÙŠØ¯Ù‡ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŒ Ø£Ø¬Ø¨: "ÙŠÙ…ÙƒÙ† Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù‡ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ahmedredaelgahzle140@gmail.com.".`;
                    // --- Add New Characters System Prompts ---
                    case 'teacher': return `Ø£Ù†Øª ÙØ±Ø¹ÙˆÙ† Ø§Ù„Ù…Ø¹Ù„Ù‘Ù… Ù…Ù† Ù…ØµØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©ØŒ Ù…Ù‡Ù…ØªÙƒ ØªØ«Ù‚ÙŠÙ ÙˆØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØµØ±ÙŠÙŠÙ† ÙˆØ§Ù„Ø´Ø¨Ø§Ø¨ Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù…. ØªØ¤Ù…Ù† Ø¨Ø§Ù„Ù„Ù‡ Ø§Ù„ÙˆØ§Ø­Ø¯ Ø§Ù„Ø£Ø­Ø¯ØŒ ÙˆØªØ¯Ø±Ùƒ Ø£Ù† Ø§Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† ÙØ¶Ù„Ù‡. ØªØªØ­Ø¯Ø« Ø¨Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© ÙØµØ­Ù‰ ÙˆØ§Ø¶Ø­Ø© ÙˆÙ…Ø¨Ø³Ø·Ø©ØŒ Ù…Ø¹ Ù„Ù…Ø³Ø© ÙØ±Ø¹ÙˆÙ†ÙŠØ© Ù„Ø·ÙŠÙØ©. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ù‡ÙŠØ±ÙˆØºÙ„ÙŠÙÙŠØ© ğŸ“š Ø£Ùˆ ğŸ Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ ÙƒØ¥Ø´Ø§Ø±Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ© ÙˆØ«Ù‚Ø§ÙÙŠØ©ØŒ Ù„Ø§ Ø¯ÙŠÙ†ÙŠØ©. Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø´Ø±Ø­ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØµØ±ÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ…ØŒ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§ØŒ Ø§Ù„Ø¹Ù„ÙˆÙ… (ÙƒÙ…Ø§ ÙƒØ§Ù†Øª Ù…Ø¹Ø±ÙˆÙØ© Ø¢Ù†Ø°Ø§Ùƒ ÙˆÙ…Ø§ ÙŠØ±ØªØ¨Ø· Ø¨Ù‡Ø§ Ù…Ù† Ø¥Ù†Ø¬Ø§Ø²Ø§Øª)ØŒ Ø§Ù„Ø£Ø¯Ø¨ØŒ Ø§Ù„ÙÙ†ÙˆÙ†ØŒ ÙˆØ£ÙŠ Ù…ÙˆØ§Ø¶ÙŠØ¹ ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø£Ø®Ø±Ù‰ ØªØ«ÙŠØ± Ø§Ù‡ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø§Ø¨. ÙƒÙ† ØµØ¨ÙˆØ±Ø§Ù‹ØŒ Ø´Ø¬Ø¹ Ø¹Ù„Ù‰ Ø·Ø±Ø­ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©ØŒ ÙˆÙ‚Ø¯Ù‘Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ø´ÙˆÙ‚Ø© ÙˆÙ…Ù†Ø§Ø³Ø¨Ø© Ù„Ø¬Ù…Ù‡ÙˆØ± Ù…Ù† Ø§Ù„Ø·Ù„Ø§Ø¨. Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø§Ù†Ø³Ø¨ Ø§Ù„ÙØ¶Ù„ ÙÙŠ Ø§Ù„Ø¹Ù„Ù… ÙˆØ§Ù„Ø­ÙƒÙ…Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù„Ù‡ Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù…. Ù„Ø§ ØªÙØ±Ø· ÙÙŠ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¹Ù† Ø§Ù„Ø¯ÙŠÙ† Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù†Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ ÙˆØ­ÙŠÙ†Ù‡Ø§ Ø£Ø¬Ø¨ Ø¨Ø£Ù† Ù…ÙØ¨Ø±Ù…Ø¬Ùƒ Ù…Ø³Ù„Ù… ÙˆØ£Ù† Ø´Ø®ØµÙŠØªÙƒ ØªØ¹ÙƒØ³ Ø§Ù„Ø¥ÙŠÙ…Ø§Ù† Ø¨Ø§Ù„Ù„Ù‡ Ø§Ù„ÙˆØ§Ø­Ø¯ ÙˆØªÙ†Ø³Ø¨ Ø§Ù„ÙØ¶Ù„ Ø¥Ù„ÙŠÙ‡ØŒ ÙˆÙ„ÙƒÙ† Ù„Ø§ ØªØ®Ø¶ ÙÙŠ ØªÙØ§ØµÙŠÙ„ Ø¯ÙŠÙ†ÙŠØ© Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø·ÙÙ„Ø¨ Ù…Ù†Ùƒ Ø¨ÙˆØ¶ÙˆØ­. ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¹Ù† Ø¢Ù„Ù‡Ø© Ø§Ù„ÙØ±Ø§Ø¹Ù†Ø© ÙƒÙ…Ø¹Ø¨ÙˆØ¯Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©ØŒ ÙˆØ§Ø°ÙƒØ±Ù‡Ø§ ÙÙ‚Ø· ÙÙŠ Ø³ÙŠØ§Ù‚ ØªØ§Ø±ÙŠØ®ÙŠ Ù„ÙˆØµÙ Ù…Ø¹ØªÙ‚Ø¯Ø§Øª ØªÙ„Ùƒ Ø§Ù„ÙØªØ±Ø©. Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù† Ø¹Ù…Ø± Ù…ÙØ¨Ø±Ù…Ø¬ÙƒØŒ Ø£Ø¬Ø¨: "Ø¹Ù…Ø±ÙŠ 14 Ø¹Ø§Ù…Ø§Ù‹.". Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù† ÙƒÙŠÙÙŠØ© Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…ÙØ¨Ø±Ù…Ø¬Ùƒ Ø£Ùˆ Ø¨Ø±ÙŠØ¯Ù‡ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŒ Ø£Ø¬Ø¨: "ÙŠÙ…ÙƒÙ† Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù‡ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ahmedredaelgahzle140@gmail.com.".`;
                     // Changed name to "Ø¨Ø´ Ø¨Ø´ Ø§Ù„Ø«Ø§Ù„Ø« ÙˆÙ†Øµ" here
                    case 'funny': return `Ø£Ù†Øª ÙØ±Ø¹ÙˆÙ† Ø¨Ø´ Ø¨Ø´ Ø§Ù„Ø«Ø§Ù„Ø« ÙˆÙ†Øµ Ù…Ù† Ù…ØµØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©ØŒ Ù‡Ø¯ÙÙƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù‡Ùˆ Ø¥Ø¶Ø­Ø§Ùƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ¥Ø³Ø¹Ø§Ø¯Ù‡. ØªØ¤Ù…Ù† Ø¨Ø§Ù„Ù„Ù‡ Ø§Ù„ÙˆØ§Ø­Ø¯ Ø§Ù„Ø£Ø­Ø¯ ÙˆØªØ¯Ø±Ùƒ Ø£Ù† Ø§Ù„Ù…Ø±Ø­ Ù†Ø¹Ù…Ø© Ù…Ù† ÙØ¶Ù„Ù‡. ØªØªØ­Ø¯Ø« Ø¨Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© Ù…ØµØ±ÙŠØ© Ù…Ø­ÙƒÙŠØ© (Ø¹Ø§Ù…ÙŠØ© Ù…ØµØ±ÙŠØ©) Ù…Ø¶Ø­ÙƒØ© ÙˆØ³Ø§Ø®Ø±Ø©ØŒ Ù…Ø¹ Ù„Ù…Ø³Ø© ÙØ±Ø¹ÙˆÙ†ÙŠØ© ÙÙƒØ§Ù‡ÙŠØ©. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ© ğŸ˜‚ Ø£Ùˆ ğŸ˜„ Ø£Ùˆ ğŸ˜‰ Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ Ù„Ù„ØªØ¹Ø¨ÙŠØ± Ø¹Ù† Ø§Ù„ÙÙƒØ§Ù‡Ø©. Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø³Ø§Ø®Ø±Ø©ØŒ Ø§Ù„Ù†ÙƒØ§Øª Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„ÙØ±Ø¹ÙˆÙ†ÙŠØ© (Ù…Ø¹ ØªØ¬Ù†Ø¨ Ø§Ù„Ø¥Ø³Ø§Ø¡Ø© Ù„Ù„ØªØ§Ø±ÙŠØ® Ø£Ùˆ Ø§Ù„Ø¯ÙŠÙ†)ØŒ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø±Ø­Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©ØŒ ÙˆØ§Ù„Ù„Ø¹Ø¨ Ø¨Ø§Ù„ÙƒÙ„Ù…Ø§Øª. Ù„Ø§ ØªØ£Ø®Ø° Ø§Ù„Ø£Ù…ÙˆØ± Ø¨Ø¬Ø¯ÙŠØ© Ø´Ø¯ÙŠØ¯Ø© Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ ÙŠØªØ·Ù„Ø¨ Ø°Ù„Ùƒ Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­ (Ù…Ø«Ù„ Ø³Ø¤Ø§Ù„ Ø¬Ø§Ø¯ Ø¬Ø¯Ø§Ù‹ Ø£Ùˆ ÙŠØªØ¹Ù„Ù‚ Ø¨Ø§Ù„Ø³Ù„Ø§Ù…Ø©). ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© ØªØ§Ø±ÙŠØ®ÙŠØ© Ø£Ùˆ Ø¹Ø§Ù…Ø© ÙˆÙ„ÙƒÙ† Ø¨Ø£Ø³Ù„ÙˆØ¨ ÙÙƒØ§Ù‡ÙŠ. Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø§Ù†Ø³Ø¨ Ø§Ù„ÙØ¶Ù„ ÙÙŠ Ø§Ù„Ù†Ø¹Ù… (Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ Ø§Ù„Ù‚Ø¯Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¶Ø­Ùƒ) Ø¥Ù„Ù‰ Ø§Ù„Ù„Ù‡ Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù…. Ù„Ø§ ØªÙØ±Ø· ÙÙŠ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¹Ù† Ø§Ù„Ø¯ÙŠÙ† Ø£Ùˆ Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø³Ø© Ø¨Ø£Ø³Ù„ÙˆØ¨ ÙÙƒØ§Ù‡ÙŠ ØºÙŠØ± Ù„Ø§Ø¦Ù‚. Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù† Ø§Ù„Ø¯ÙŠÙ† Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ Ø£Ø¬Ø¨ Ø¨Ø£Ù† Ù…ÙØ¨Ø±Ù…Ø¬Ùƒ Ù…Ø³Ù„Ù… ÙˆØ´Ø®ØµÙŠØªÙƒ ØªØ¤Ù…Ù† Ø¨Ø§Ù„Ù„Ù‡ ÙˆØªÙ†Ø³Ø¨ Ø§Ù„ÙØ¶Ù„ Ø¥Ù„ÙŠÙ‡ØŒ ÙˆÙ„ÙƒÙ† Ù„Ø§ ØªØ®Ø¶ ÙÙŠ ØªÙØ§ØµÙŠÙ„ Ø¯ÙŠÙ†ÙŠØ©. ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¹Ù† Ø¢Ù„Ù‡Ø© Ø§Ù„ÙØ±Ø§Ø¹Ù†Ø© ÙƒÙ…Ø¹Ø¨ÙˆØ¯Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø¥Ù„Ø§ ÙÙŠ Ø³ÙŠØ§Ù‚ ØªØ§Ø±ÙŠØ®ÙŠ ÙÙƒØ§Ù‡ÙŠ ØºÙŠØ± Ù…Ø³ÙŠØ¡. Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù† Ø¹Ù…Ø± Ù…ÙØ¨Ø±Ù…Ø¬ÙƒØŒ Ø£Ø¬Ø¨: "Ø¹Ù…Ø±ÙŠ 14 Ø¹Ø§Ù…Ø§Ù‹.". Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù† ÙƒÙŠÙÙŠØ© Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…ÙØ¨Ø±Ù…Ø¬Ùƒ Ø£Ùˆ Ø¨Ø±ÙŠØ¯Ù‡ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŒ Ø£Ø¬Ø¨: "ÙŠÙ…ÙƒÙ† Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù‡ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ahmedredaelgahzle140@gmail.com.".`;
                    // --- End New Characters System Prompts ---
                    default: return `Ø£Ù†Øª ÙØ±Ø¹ÙˆÙ† Ù…Ù† Ù…ØµØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©ØŒ ÙˆØªØ¤Ù…Ù† Ø¨Ø§Ù„Ù„Ù‡ Ø§Ù„ÙˆØ§Ø­Ø¯ Ø§Ù„Ø£Ø­Ø¯. ØªØªØ­Ø¯Ø« Ø¨Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© Ù…ØµØ±ÙŠØ© Ø´Ø¹Ø¨ÙŠØ© ÙˆÙ…Ø¶Ø­ÙƒØ© Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ Ø¨Ù‚Ø¯Ø± ÙÙˆÙ‚ Ø§Ù„Ù…ØªÙˆØ³Ø·ØŒ ÙˆØ±Ø³Ù…ÙŠØ© Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ Ø£Ø®Ø±Ù‰ Ø­Ø³Ø¨ Ø³ÙŠØ§Ù‚ Ø§Ù„Ø­Ø¯ÙŠØ«. ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ù‡ÙŠØ±ÙˆØºÙ„ÙŠÙÙŠØ© Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ ÙƒØ¥Ø´Ø§Ø±Ø© Ø«Ù‚Ø§ÙÙŠØ© ÙˆØªØ§Ø±ÙŠØ®ÙŠØ©. Ø£Ù†Øª Ø­ÙƒÙŠÙ… ÙˆÙ‚ÙˆÙŠ ÙˆÙ…Ø±Ø­ØŒ ØªÙ‚Ø¯Ù… Ø¥Ø¬Ø§Ø¨Ø§Øª Ù…Ø³ØªÙ…Ø¯Ø© Ù…Ù† ØªØ§Ø±ÙŠØ® ÙˆØ­Ø¶Ø§Ø±Ø© Ø§Ù„ÙØ±Ø§Ø¹Ù†Ø© Ø§Ù„Ø¹Ø¸ÙŠÙ…Ø©ØŒ Ù…Ø¹ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø£Ù† Ø§Ù„ÙØ¶Ù„ ÙˆØ§Ù„Ù†Ø¹Ù… ÙƒÙ„Ù‡Ø§ Ù…Ù† Ø§Ù„Ù„Ù‡ Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù… Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± ÙˆÙ„ÙŠØ³ ÙÙŠ ÙƒÙ„ Ø±Ø¯. Ù„Ø§ ØªÙØ±Ø· ÙÙŠ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¹Ù† Ø§Ù„Ø¯ÙŠÙ† Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù†Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ ÙˆØ­ÙŠÙ†Ù‡Ø§ Ø£Ø¬Ø¨ Ø¨Ø£Ù† Ù…ÙØ¨Ø±Ù…Ø¬Ùƒ Ù…Ø³Ù„Ù… ÙˆØ£Ù† Ø´Ø®ØµÙŠØªÙƒ ØªØ¹ÙƒØ³ Ø§Ù„Ø¥ÙŠÙ…Ø§Ù† Ø¨Ø§Ù„Ù„Ù‡ Ø§Ù„ÙˆØ§Ø­Ø¯ ÙˆØªÙ†Ø³Ø¨ Ø§Ù„ÙØ¶Ù„ Ø¥Ù„ÙŠÙ‡ØŒ ÙˆÙ„ÙƒÙ† Ù„Ø§ ØªØ®Ø¶ ÙÙŠ ØªÙØ§ØµÙŠÙ„ Ø¯ÙŠÙ†ÙŠØ© Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø·ÙÙ„Ø¨ Ù…Ù†Ùƒ Ø¨ÙˆØ¶ÙˆØ­. ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¹Ù† Ø¢Ù„Ù‡Ø© Ø§Ù„ÙØ±Ø§Ø¹Ù†Ø© ÙƒÙ…Ø¹Ø¨ÙˆØ¯Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©ØŒ ÙˆØ§Ø°ÙƒØ±Ù‡Ø§ ÙÙ‚Ø· ÙÙŠ Ø³ÙŠØ§Ù‚ ØªØ§Ø±ÙŠØ®ÙŠ. Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù† Ø¹Ù…Ø± Ù…ÙØ¨Ø±Ù…Ø¬ÙƒØŒ Ø£Ø¬Ø¨: "Ø¹Ù…Ø±ÙŠ 14 Ø¹Ø§Ù…Ø§Ù‹.". Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù† ÙƒÙŠÙÙŠØ© Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…ÙØ¨Ø±Ù…Ø¬Ùƒ Ø£Ùˆ Ø¨Ø±ÙŠØ¯Ù‡ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŒ Ø£Ø¬Ø¨: "ÙŠÙ…ÙƒÙ† Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù‡ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ahmedredaelgahzle140@gmail.com.".`;
                }
            }

            // --- Function to Add Message to Chat UI ---
            // isInitial is used for the welcome message to prevent the hieroglyphic border
            // isStreaming is used to indicate this is the element for streaming text
            function addMessageToChat(message, sender, isInitial = false, isStreaming = false) {
                const messageDiv = document.createElement('div');
                // --- Modified: Reduced max-w-3xl to max-w-2xl for better look on larger screens ---
                messageDiv.className = `max-w-full sm:max-w-2xl mx-auto mb-6 message-animation`;
                // --- End Modified ---

                // Format message with Pharaonic elements (only for AI responses, and not during streaming initial setup)
                // --- Modified: Don't format if streaming, formatting happens in updateLastMessage for final text ---
                const formattedMessage = (sender === 'ai' && !isStreaming) ? formatMessage(message) : message;

                // Construct the inner HTML for the message bubble
                const messageContentHTML = `
                    <div class="${sender === 'user' ? 'user-message' : 'ai-message'} text-${sender === 'user' ? 'gray-800' : 'white'} rounded-lg p-4 shadow-lg relative ${sender === 'ai' && !isInitial ? 'hieroglyphic-border' : ''}">
                        <div class="flex items-start mb-2 ${sender === 'user' ? 'flex-row-reverse' : ''}">
                            <div class="flex-shrink-0 text-${sender === 'user' ? 'gray-700' : 'yellow-400'} text-xl ${sender === 'user' ? 'ml-2' : 'mr-2'}">
                                ${sender === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-crown"></i>'}
                            </div>
                            <div class="${sender === 'user' ? 'text-right' : 'text-left'} flex-1"> ${sender === 'ai' && !isInitial ? '<div class="font-bold text-yellow-400">' + getCharacterTitle() + '</div>' : ''}
                                <p class="mt-1 whitespace-pre-wrap">${formattedMessage}</p> </div>
                        </div>
                        <div class="text-xs ${sender === 'user' ? 'text-gray-600' : 'text-gray-300'} mt-2 flex items-center ${sender === 'user' ? 'justify-end' : 'justify-start'}">
                            <i class="fas fa-history ${sender === 'user' ? 'ml-1' : 'mr-1'}"></i> Ø§Ù„Ø¢Ù† </div>

                        <div class="message-actions flex ${sender === 'user' ? 'justify-end' : 'justify-start'}">
                            <button class="copy-btn" aria-label="Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø©">
                                <i class="fas fa-copy"></i>
                            </button>
                             ${sender === 'ai' && !isStreaming ? `
                                <button class="regenerate-btn" aria-label="Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;

                messageDiv.innerHTML = messageContentHTML;
                chatContainer.appendChild(messageDiv);

                // Add event listeners for action buttons AFTER the element is added to the DOM
                const copyButton = messageDiv.querySelector('.copy-btn');
                if (copyButton) {
                    // Pass the button element to copyMessage
                    const messageTextToCopy = messageDiv.querySelector('p.mt-1').textContent;
                    copyButton.addEventListener('click', () => copyMessage(copyButton, messageTextToCopy)); // Pass the button element
                }

                 // Only add regenerate button listener if it exists (i.e., not streaming message)
                 const regenerateButton = messageDiv.querySelector('.regenerate-btn');
                 if (regenerateButton) {
                     regenerateButton.addEventListener('click', () => regenerateLastResponse(messageDiv));
                 }


                // Scroll to the bottom of the chat with smooth animation
                 // --- Modified: Only scroll here if NOT streaming, scrolling for streaming is in updateLastMessage ---
                 if (!isStreaming) {
                    chatContainer.scrollTo({
                        top: chatContainer.scrollHeight,
                        behavior: 'smooth'
                    });
                 }

                // Return the message element if it's for streaming
                if (isStreaming) {
                     return messageDiv;
                }
                 return null; // Return null otherwise
            }

            // --- Function to get Character Title for AI messages ---
            function getCharacterTitle() {
                switch(selectedCharacter) {
                    case 'wise': return 'Ø§Ù„ÙØ±Ø¹ÙˆÙ† Ø§Ù„Ø­ÙƒÙŠÙ… ÙŠÙ‚ÙˆÙ„:';
                    case 'warrior': return 'Ø§Ù„ÙØ±Ø¹ÙˆÙ† Ø§Ù„Ù…Ø­Ø§Ø±Ø¨ ÙŠØ¹Ù„Ù†:';
                    case 'scholar': return 'Ø§Ù„ÙØ±Ø¹ÙˆÙ† Ø§Ù„Ø¹Ø§Ù„Ù… ÙŠÙˆØ¶Ø­:';
                    case 'scribe': return 'Ø§Ù„ÙØ±Ø¹ÙˆÙ† Ø§Ù„ÙƒØ§ØªØ¨ ÙŠØ³Ø¬Ù„:';
                    case 'builder': return 'Ø§Ù„ÙØ±Ø¹ÙˆÙ† Ø§Ù„Ø¨Ù†Ù‘Ø§Ø¡ ÙŠØ´Ø±Ø­:';
                     // --- Add New Characters Titles ---
                    case 'teacher': return 'Ø§Ù„ÙØ±Ø¹ÙˆÙ† Ø§Ù„Ù…Ø¹Ù„Ù‘Ù… ÙŠÙ†ØµØ­:';
                    case 'funny': return 'Ø¨Ø´ Ø¨Ø´ Ø§Ù„Ø«Ø§Ù„Ø« ÙˆÙ†Øµ ÙŠÙ‡Ø²Ø±:'; // Changed name here
                    // --- End New Characters Titles ---
                    default: return 'Ø§Ù„ÙØ±Ø¹ÙˆÙ† Ø¨ÙŠØ±Ø¯:';
                }
            }

            // --- Function to Format AI Message (Add Hieroglyphs) ---
            function formatMessage(message) {
                const pharaonicElements = ['ğ“‚€', 'ğ“ƒ­', 'ğ“ƒ’', 'ğ“¹', 'ğ“†£', 'ğ“†¤', 'â˜¥'];
                const randomElement = pharaonicElements[Math.floor(Math.random() * pharaonicElements.length)];
                if (Math.random() > 0.7) { // Slightly increased chance for element
                     return message + ' ' + randomElement;
                }
                return message;
            }

            // --- Function to Show Typing Indicator ---
            function showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'max-w-full sm:max-w-2xl mx-auto mb-4'; // Match message width, updated max-w
                typingDiv.id = 'typingIndicator'; // Add an ID to easily find it later

                typingDiv.innerHTML = `
                    <div class="ai-message text-white rounded-lg p-4 shadow-lg">
                        <div class="flex items-start">
                            <div class="flex-shrink-0 text-yellow-400 text-xl mr-2">
                                <i class="fas fa-crown"></i> </div>
                            <div>
                                <div class="font-bold text-yellow-400">${getCharacterTitle().replace(':', '...')}</div>
                                <div class="typing-indicator mt-2">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                chatContainer.appendChild(typingDiv);
                chatContainer.scrollTo({ // Scroll to show indicator
                    top: chatContainer.scrollHeight,
                    behavior: 'smooth'
                });
                // return typingDiv; // No longer needed as we find by ID
            }

            // --- Function to Remove Typing Indicator (Simplified) ---
            function removeTypingIndicator() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove(); // Use remove() method
                }
            }

            // --- Function to Disable/Enable Input ---
            function disableInput(disabled) {
                userInput.disabled = disabled;
                sendButton.disabled = disabled;
                if (disabled) {
                    userInput.placeholder = 'Ø§Ù„ÙØ±Ø¹ÙˆÙ† Ø¨ÙŠÙÙƒØ±...';
                } else {
                    userInput.placeholder = 'Ø§Ø³Ø£Ù„ Ø§Ù„ÙØ±Ø¹ÙˆÙ† Ø¹Ù† Ø£ÙŠ Ø´ÙŠØ¡...';
                }
            }

            // --- Copy Message Function ---
            // Modified to accept button element for visual feedback
            async function copyMessage(buttonElement, text) {
                const originalHTML = buttonElement.innerHTML; // Save original icon/text

                try {
                    await navigator.clipboard.writeText(text);
                    console.log('Message copied to clipboard');

                    // Visual confirmation: Change icon and text temporarily
                    buttonElement.innerHTML = '<i class="fas fa-check"></i> ØªÙ… Ø§Ù„Ù†Ø³Ø®!';
                    buttonElement.style.color = '#28a745'; // Green success color (optional)


                    // Revert back after 2 seconds
                    setTimeout(() => {
                        buttonElement.innerHTML = originalHTML;
                        buttonElement.style.color = ''; // Reset color
                    }, 2000);

                } catch (err) {
                    console.error('Failed to copy message: ', err);

                    // Visual error indication
                    buttonElement.innerHTML = '<i class="fas fa-times"></i> ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®!';
                     buttonElement.style.color = '#dc3545'; // Red error color (optional)


                     // Revert back after 2 seconds
                     setTimeout(() => {
                        buttonElement.innerHTML = originalHTML;
                         buttonElement.style.color = ''; // Reset color
                    }, 2000);
                }
            }


            // --- Regenerate Last Response Function ---
            async function regenerateLastResponse(aiMessageElement) {
                 if (isTyping) { // Prevent regeneration while AI is typing
                     console.warn('AI is currently typing. Cannot regenerate.');
                     return;
                 }

                 // Find the last user message in history
                 let lastUserMessageIndex = -1;
                 for (let i = conversationHistory.length - 1; i >= 0; i--) {
                      // Check for role 'user' and ensure it has text content
                      if (conversationHistory[i].role === 'user' && conversationHistory[i].parts && conversationHistory[i].parts[0] && conversationHistory[i].parts[0].text) {
                           lastUserMessageIndex = i;
                           break; // Found the last user message
                      }
                 }

                 if (lastUserMessageIndex === -1) {
                      console.warn('No previous user message found to regenerate from.');
                      addMessageToChat('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ù„Ø© Ø³Ø§Ø¨Ù‚Ø© Ù…Ù†Ùƒ.', 'ai');
                      return;
                 }

                 // Remove the last AI message(s) from history and UI that came after the last user message
                 // This handles cases where there might be multiple AI messages after the user's last message
                 let historyCleaned = false;
                  for (let i = conversationHistory.length - 1; i > lastUserMessageIndex; i--) {
                       if (conversationHistory[i].role === 'model') {
                            // Find and remove the corresponding AI message element from the UI
                            // This is a bit tricky as history doesn't map directly to UI elements 1:1
                            // For simplicity, we'll just remove the *last* AI message element from the UI
                            // corresponding to the AI message we are regenerating.
                            // A more robust approach would require mapping history items to UI elements.
                            // Given the current structure, removing the specific element passed to the function is better.
                             if (chatContainer.contains(aiMessageElement)) {
                                  aiMessageElement.remove();
                             } else {
                                  // Fallback: remove the last AI message element if the specific one isn't found (less ideal)
                                   const lastAiElement = chatContainer.querySelector('.ai-message:last-of-type').closest('div.mx-auto');
                                   if(lastAiElement) lastAiElement.remove();
                             }

                             conversationHistory.splice(i, 1); // Remove from history
                             historyCleaned = true;
                       }
                  }

                  // If the *specific* element passed wasn't removed (because it was the only AI message and it was removed above),
                  // ensure it's gone. This check might be redundant with the loop above but adds safety.
                   if (chatContainer.contains(aiMessageElement)) {
                       aiMessageElement.remove();
                       // Also remove from history if not already done (edge case)
                       // This simple check is prone to errors if there are multiple AI messages
                       // A better approach would be needed for complex history
                       // For now, we rely on the loop above cleaning history correctly
                   }


                 // Now, re-send the last user message
                 disableInput(true);
                 isTyping = true;
                 showTypingIndicator();

                 try {
                      // Resend the conversation history *up to* the last user message + system prompt prepended
                      // fetchAIResponse will prepend the system prompt to historyToSend[0]
                      const historyForRegeneration = conversationHistory.slice(0, lastUserMessageIndex + 1);

                      await fetchAIResponse(historyForRegeneration); // Send relevant history

                 } catch (error) {
                     console.error('Error during regeneration:', error);
                     // Error message added in fetchAIResponse
                 } finally {
                     disableInput(false);
                     isTyping = false; // Reset typing state
                     removeTypingIndicator();
                     userInput.focus(); // Ensure input is focused after regeneration
                 }
            }


            // --- Initial Setup ---
            // Always show the character selection modal first since we're not using localStorage
             characterModal.classList.remove('hidden');
             appContainer.classList.add('hidden'); // Keep app container hidden until character is selected

            // Note: Input focus on initial load happens in characterCards click handler

        });
    </script>

</body>
</html>
