<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ŸÅÿ±ÿπŸàŸÜ AI - ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ÿßŸÑŸÅÿ±ÿπŸàŸÜŸä</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* Base Body Styles */
        body {
            font-family: 'Tajawal', sans-serif;
            background-image: url('https://www.transparenttextures.com/patterns/papyrus.png');
            background-color: #f5e7c8; /* Light background for day mode */
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for dark mode */
        }

        /* Pharaoh Background for Header and Footer */
        .pharaoh-bg {
            background-image: linear-gradient(to bottom, rgba(23, 42, 58, 0.8), rgba(23, 42, 58, 0.9)), url('https://www.transparenttextures.com/patterns/black-paper.png');
            color: #f0e6d2; /* Light text color for header/footer */
        }

        /* User Message Styles */
        .user-message {
            background: linear-gradient(135deg, #f8d56b 0%, #e8b54a 100%); /* Gold gradient */
            border-left: 4px solid #d4a017; /* Gold border */
            color: #4a2c0f; /* Dark text for readability */
        }

        /* AI Message Styles */
        .ai-message {
            background: linear-gradient(135deg, #1a365d 0%, #15314b 100%); /* Dark blue gradient */
            border-right: 4px solid #d4a017; /* Gold border */
            color: #f0e6d2; /* Light text color */
        }

        /* Font Size for Message Text (User and AI) */
        .user-message p,
        .ai-message p {
            font-size: 0.9rem; /* Slightly adjusted font size */
        }


        /* Hieroglyphic Border Effect (for AI messages) */
        .hieroglyphic-border {
            position: relative;
        }

        /* Hieroglyphic pseudo-element */
        .hieroglyphic-border::before {
            content: "ìÉ≠ìÉÆìÉØìÉ∞ìÉ≠ìÉÆìÉØìÉ∞"; /* Hieroglyph characters */
            position: absolute;
            top: -15px; /* Position above the message bubble */
            left: 0;
            right: 0;
            text-align: center;
            color: #d4a017; /* Gold color */
            font-size: 12px;
            letter-spacing: 5px;
            opacity: 0.6; /* Slightly transparent */
        }

        /* Send Button Styles */
        .send-btn {
            background: linear-gradient(135deg, #d4a017 0%, #b78a14 100%); /* Gold gradient */
            box-shadow: 0 4px 6px rgba(180, 140, 20, 0.3); /* Gold shadow */
        }

        .send-btn:hover:not(:disabled) { /* Apply hover effect only when not disabled */
            background: linear-gradient(135deg, #b78a14 0%, #9a7311 100%); /* Darker gold on hover */
        }

        .send-btn:disabled {
            opacity: 0.5; /* Reduce opacity when disabled */
            cursor: not-allowed; /* Change cursor */
        }


        /* Input Field Styles */
        .input-field {
            background-color: rgba(255, 255, 255, 0.1); /* Slightly transparent white */
            backdrop-filter: blur(5px); /* Blur effect */
            border: 1px solid rgba(212, 160, 23, 0.3); /* Semi-transparent gold border */
            color: #f0e6d2; /* Light text color */
        }

        .input-field::placeholder {
             color: rgba(240, 230, 210, 0.7); /* Lighter placeholder text */
        }

        .input-field:focus {
            border-color: #d4a017; /* Solid gold border on focus */
            box-shadow: 0 0 0 2px rgba(212, 160, 23, 0.3); /* Gold focus ring */
        }

         .input-field:disabled {
             opacity: 0.6; /* Reduce opacity when disabled */
             cursor: not-allowed; /* Change cursor */
         }


        /* Typing Indicator Animation */
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #d4a017; /* Gold color */
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out; /* Bounce animation */
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s; /* Stagger animation */
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s; /* Stagger animation */
        }

        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
        }

        /* Message Entry Animation (Papyrus Unroll effect) */
        .message-animation {
            animation: papyrusUnroll 0.6s ease-out;
            transform-origin: top; /* Animation starts from the top */
        }

        @keyframes papyrusUnroll {
            0% { transform: scaleY(0); opacity: 0; }
            100% { transform: scaleY(1); opacity: 1; }
        }

        /* Dark Mode Styles */
        .dark-mode {
            background-image: linear-gradient(to bottom, rgba(10, 15, 20, 0.9), rgba(5, 10, 15, 0.95)), url('https://www.transparenttextures.com/patterns/stardust.png');
            background-color: #0a141a; /* Very dark background */
            color: #f0e6d2; /* Light text */
        }

        .dark-mode .user-message {
            background: linear-gradient(135deg, #9a7311 0%, #7a5a0e 100%); /* Darker gold gradient */
            border-left-color: #7a5a0e; /* Darker gold border */
            color: #fffbeb; /* Very light text */
        }

        .dark-mode .ai-message {
            background: linear-gradient(135deg, #0f2027 0%, #0a141a 100%); /* Even darker blue gradient */
            border-right-color: #9a7311; /* Darker gold border */
            color: #f0e6d2; /* Light text */
        }

         .dark-mode .hieroglyphic-border::before {
             color: #9a7311; /* Darker gold hieroglyphs */
         }

        .dark-mode .input-field {
            background-color: rgba(15, 25, 35, 0.7); /* Darker transparent background */
            border: 1px solid rgba(154, 115, 17, 0.5); /* Semi-transparent darker gold border */
            color: #f0e6d2; /* Light text */
        }

         .dark-mode .input-field::placeholder {
             color: rgba(240, 230, 210, 0.5); /* Even lighter placeholder text */
         }


        /* Dark Mode Toggle Button Styles */
        .dark-mode-toggle {
            background: linear-gradient(135deg, #1a365d 0%, #15314b 100%); /* Dark blue gradient */
        }

        .dark-mode .dark-mode-toggle {
            background: linear-gradient(135deg, #d4a017 0%, #b78a14 100%); /* Gold gradient in dark mode */
        }

        /* Character Selector Modal Styles */
        .character-selector {
            background: linear-gradient(135deg, rgba(26, 54, 93, 0.9), rgba(21, 49, 75, 0.9)); /* Dark blue transparent gradient */
            backdrop-filter: blur(5px); /* Blur effect */
        }

        .character-card {
            transition: all 0.3s ease; /* Smooth transition */
            border: 2px solid transparent; /* Transparent border by default */
            background-color: rgba(255, 255, 255, 0.9); /* Slightly transparent white */
        }

         .dark-mode .character-card {
             background-color: rgba(30, 40, 50, 0.9); /* Slightly transparent dark */
         }

        .character-card:hover {
            transform: translateY(-5px); /* Lift on hover */
            border-color: #d4a017; /* Gold border on hover */
            box-shadow: 0 10px 15px rgba(212, 160, 23, 0.2); /* Gold shadow on hover */
        }

        .character-card.selected {
            border-color: #d4a017; /* Gold border when selected */
            background: rgba(212, 160, 23, 0.1); /* Light gold background when selected */
        }

         .dark-mode .character-card.selected {
             background: rgba(212, 160, 23, 0.05); /* Lighter gold background in dark mode */
         }

         /* Scrollbar Hide Utility */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Ensure main chat area takes available height */
        #appContainer {
             display: flex; /* Use flexbox for layout */
             flex-direction: column; /* Stack children vertically */
             min-height: 100vh; /* Minimum height of the viewport */
        }

         #chatContainer {
             flex-grow: 1; /* Allow chat container to grow and fill space */
             overflow-y: auto; /* Enable vertical scrolling */
             padding-bottom: 80px; /* Add padding at the bottom to prevent input overlap */
         }

         /* New Chat Button Styles */
         #newChatButton {
             background: linear-gradient(135deg, #d4a017 0%, #b78a14 100%);
             box-shadow: 0 2px 4px rgba(180, 140, 20, 0.3);
             /* --- Added: Dark mode style for new chat button --- */
             transition: background 0.3s ease; /* Add transition for smooth color change */
         }

         #newChatButton:hover {
             background: linear-gradient(135deg, #b78a14 0%, #9a7311 100%);
         }

         /* --- Added: Dark mode style for new chat button hover --- */
         .dark-mode #newChatButton {
              background: linear-gradient(135deg, #d4a017 0%, #b78a14 100%); /* Keep gold in dark mode */
         }

         .dark-mode #newChatButton:hover {
              background: linear-gradient(135deg, #b78a14 0%, #9a7311 100%); /* Darker gold on hover in dark mode */
         }
         /* --- End Added --- */


         /* Message Action Buttons (Copy, Regenerate) */
         .message-actions {
             display: flex;
             gap: 8px; /* Space between buttons */
             margin-top: 8px; /* Space above actions */
             font-size: 0.8rem; /* Smaller icons */
             color: rgba(240, 230, 210, 0.7); /* Light gold color */
         }

         .message-actions button {
             background: none;
             border: none;
             padding: 4px; /* Padding around icon */
             cursor: pointer;
             color: inherit; /* Inherit color from parent */
             transition: color 0.2s ease;
         }

         .message-actions button:hover {
             color: #d4a017; /* Gold color on hover */
         }

         .dark-mode .message-actions button {
             color: rgba(240, 230, 210, 0.5); /* Lighter color in dark mode */
         }

         .dark-mode .message-actions button:hover {
             color: #f0e6d2; /* Lighter gold on hover in dark mode */
         }


    </style>
</head>
<body class="transition-colors duration-300">

    <div id="characterModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 character-selector">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-2xl w-full p-6 max-h-screen overflow-y-auto">
            <h2 class="text-2xl font-bold text-center text-yellow-600 mb-6">ÿßÿÆÿ™ÿ± ÿ¥ÿÆÿµŸäÿ© ÿßŸÑŸÅÿ±ÿπŸàŸÜ</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                <div class="character-card rounded-lg p-1 text-center cursor-pointer" data-character="wise">
                    <div class="text-4xl text-yellow-500 mb-2">
                        <i class="fas fa-scroll"></i> </div>
                    <h3 class="font-bold text-gray-800 dark:text-white">ÿßŸÑÿ≠ŸÉŸäŸÖ</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300">ŸÅÿ±ÿπŸàŸÜ ÿßŸÑÿ≠ŸÉŸÖÿ© ŸàÿßŸÑŸÖÿπÿ±ŸÅÿ©</p>
                </div>
                <div class="character-card rounded-lg p-1 text-center cursor-pointer" data-character="warrior">
                    <div class="text-4xl text-yellow-500 mb-2">
                        <i class="fas fa-shield-alt"></i> </div>
                    <h3 class="font-bold text-gray-800 dark:text-white">ÿßŸÑŸÖÿ≠ÿßÿ±ÿ®</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300">ŸÅÿ±ÿπŸàŸÜ ÿßŸÑŸÇŸàÿ© ŸàÿßŸÑÿ®ÿ∑ŸàŸÑÿ©</p>
                </div>
                <div class="character-card rounded-lg p-1 text-center cursor-pointer" data-character="scholar"> <div class="text-4xl text-yellow-500 mb-2">
                        <i class="fas fa-flask"></i> </div>
                    <h3 class="font-bold text-gray-800 dark:text-white">ÿßŸÑÿπÿßŸÑŸÖ</h3> <p class="text-sm text-gray-600 dark:text-gray-300">ŸÅÿ±ÿπŸàŸÜ ÿßŸÑÿπŸÑŸàŸÖ ŸàÿßŸÑŸÖÿπÿ±ŸÅÿ©</p> </div>

                <div class="character-card rounded-lg p-1 text-center cursor-pointer" data-character="scribe">
                     <div class="text-4xl text-yellow-500 mb-2">
                         <i class="fas fa-pencil-alt"></i>
                     </div>
                     <h3 class="font-bold text-gray-800 dark:text-white">ÿßŸÑŸÉÿßÿ™ÿ®</h3>
                     <p class="text-sm text-gray-600 dark:text-gray-300">ŸÅÿ±ÿπŸàŸÜ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ŸàÿßŸÑŸÖÿπÿßÿ±ŸÅ</p>
                 </div>
                <div class="character-card rounded-lg p-1 text-center cursor-pointer" data-character="builder">
                     <div class="text-4xl text-yellow-500 mb-2">
                         <i class="fas fa-hammer"></i>
                     </div>
                     <h3 class="font-bold text-gray-800 dark:text-white">ÿßŸÑÿ®ŸÜŸëÿßÿ°</h3>
                     <p class="text-sm text-gray-600 dark:text-gray-300">ŸÅÿ±ÿπŸàŸÜ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ŸàÿßŸÑÿπŸÖÿßÿ±ÿ©</p>
                 </div>
                <div class="character-card rounded-lg p-1 text-center cursor-pointer" data-character="teacher">
                     <div class="text-4xl text-yellow-500 mb-2">
                         <i class="fas fa-book-open"></i> </div>
                     <h3 class="font-bold text-gray-800 dark:text-white">ÿßŸÑŸÖÿπŸÑŸëŸÖ</h3>
                     <p class="text-sm text-gray-600 dark:text-gray-300">ŸÅÿ±ÿπŸàŸÜ ÿßŸÑÿπŸÑŸÖ ŸÑŸÑÿ¨ŸÖŸäÿπ</p>
                 </div>
                 <div class="character-card rounded-lg p-1 text-center cursor-pointer" data-character="funny">
                     <div class="text-4xl text-yellow-500 mb-2">
                         <i class="fas fa-laugh"></i> </div>
                     <h3 class="font-bold text-gray-800 dark:text-white">ÿ®ÿ¥ ÿ®ÿ¥ ÿßŸÑÿ´ÿßŸÑÿ´ ŸàŸÜÿµ</h3>
                     <p class="text-sm text-gray-600 dark:text-gray-300">ŸÅÿ±ÿπŸàŸÜ ÿßŸÑŸÖÿ±ÿ≠ ŸàÿßŸÑÿ∂ÿ≠ŸÉ</p>
                 </div>
                 </div>
            </div>
    </div>

    <div class="flex flex-col min-h-screen hidden" id="appContainer">
        <header class="pharaoh-bg text-gold-100 py-4 px-6 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-3 rtl:space-x-reverse">
                    <div class="text-3xl text-yellow-500">
                        <i class="fas fa-crown"></i> </div>
                    <h1 class="text-2xl font-bold text-yellow-400">
                        ŸÅÿ±ÿπŸàŸÜ <span class="text-white">AI</span>
                        <span id="characterBadge" class="text-xs bg-yellow-600 text-white px-2 py-1 rounded ml-2 hidden"></span>
                    </h1>
                </div>
                <div class="flex items-center space-x-4 rtl:space-x-reverse">
                    <button id="newChatButton" class="px-3 py-1 text-sm rounded-full text-white shadow-md transition-all duration-300 flex items-center">
                         <i class="fas fa-plus-circle ml-1 rtl:mr-1 rtl:ml-0"></i> ŸÖÿ≠ÿßÿØÿ´ÿ© ÿ¨ÿØŸäÿØÿ©
                     </button>
                    <button id="darkModeToggle" class="dark-mode-toggle w-10 h-10 rounded-full flex items-center justify-center text-white shadow-md transition-all duration-300">
                        <i class="fas fa-moon"></i> </button>
                    <div class="text-yellow-400 text-xl">
                        <i class="fas fa-eye-of-horus"></i>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto py-4 px-4 md:px-8 scrollbar-hide" id="chatContainer">
            </main>

        <footer class="pharaoh-bg py-4 px-4 md:px-8 border-t border-yellow-800">
            <div class="max-w-3xl mx-auto">
                <form id="chatForm" class="flex items-center space-x-2 rtl:space-x-reverse">
                    <div class="flex-1 relative">
                        <input
                            type="text"
                            id="userInput"
                            placeholder="ÿßÿ≥ÿ£ŸÑ ÿßŸÑŸÅÿ±ÿπŸàŸÜ ÿπŸÜ ÿ£Ÿä ÿ¥Ÿäÿ°..."
                            class="input-field w-full py-3 px-4 rounded-lg text-white placeholder-yellow-200 focus:outline-none transition-all duration-200"
                            autocomplete="off"
                        >
                        <div class="absolute left-3 top-3 text-yellow-400 rtl:right-3 rtl:left-auto">
                            <i class="fas fa-pen-fancy"></i> </div>
                    </div>
                    <button
                        type="submit"
                        class="send-btn text-white w-12 h-12 rounded-lg flex items-center justify-center transition-all duration-200"
                        id="sendButton"
                        aria-label="ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©"
                    >
                        <i class="fas fa-paper-plane"></i> </button>
                </form>
                <div class="text-center mt-2 text-yellow-400 text-xs">
                    <p>ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿ≠ŸÉŸÖÿ© ÿßŸÑŸÅÿ±ÿßÿπŸÜÿ© ìÉ≠ ŸÖÿ´ÿßŸÑ: "ŸÖÿß ŸáŸä ÿ£ÿ≥ÿ±ÿßÿ± ÿ®ŸÜÿßÿ° ÿßŸÑÿ£Ÿáÿ±ÿßŸÖÿßÿ™ÿü"</p>
                </div>
            </div>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- API Configuration ---
            // IMPORTANT SECURITY WARNING: EXTREMELY INSECURE FOR PRODUCTION
            // Exposing ANY API key (especially multiple) client-side is a HUGE security risk.
            // Anyone can steal these keys and use them, consuming your quota or incurring costs.
            // This implementation is provided ONLY for demonstrating how to technically switch keys client-side,
            // and is NOT recommended for any public or production environment.
            // The SECURE method is ALWAYS to use a backend server to handle API calls.

            const API_KEYS = {
                'wise': 'AIzaSyCoOAbNRuUG3M3lGjOAiFuHoGYekUll98A',     // <-- Key inserted here
                'warrior': 'AIzaSyCoOAbNRuUG3M3lGjOAiFuHoGYekUll98A', // <-- Key inserted here
                'scholar': 'AIzaSyCoOAbNRuUG3M3lGjOAiFuHoGYekUll98A', // <-- Key inserted here
                'scribe': 'AIzaSyCoOAbNRuUG3M3lGjOAiFuHoGYekUll98A',   // <-- Key inserted here
                'builder': 'AIzaSyCoOAbNRuUG3M3lGjOAiFuHoGYekUll98A', // <-- Key inserted here
                'teacher': 'AIzaSyCoOAbNRuUG3M3lGjOAiFuHoGYekUll98A', // <-- Key inserted here
                'funny': 'AIzaSyCoOAbNRuUG3M3lGjOAiFuHoGYekUll98A',     // <-- Key inserted here
                'default': 'AIzaSyCoOAbNRuUG3M3lGjOAiFuHoGYekUll98A' // <-- Key inserted here
            };

            // Make sure to REMOVE or comment out the old single API_KEY line


            // Based on the Google AI for Developers quickstart curl example,
            // the model name 'gemini-2.0-flash' is used with the 'v1beta' API version.
            const API_ENDPOINT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

            // --- App Elements ---
            const chatForm = document.getElementById('chatForm');
            const userInput = document.getElementById('userInput');
            const chatContainer = document.getElementById('chatContainer');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const body = document.body;
            const appContainer = document.getElementById('appContainer');
            const characterModal = document.getElementById('characterModal');
            const characterCards = document.querySelectorAll('.character-card');
            // Removed confirmCharacterBtn as it's no longer needed
            // const confirmCharacterBtn = document.getElementById('confirmCharacter');
            const characterBadge = document.getElementById('characterBadge');
            const sendButton = document.getElementById('sendButton'); // Get send button element
            const newChatButton = document.getElementById('newChatButton'); // Get new chat button

            // --- Chat State ---
            let selectedCharacter = null;
            let conversationHistory = []; // Array to store conversation history for the current session
            let isTyping = false; // Flag to indicate if AI is currently typing


            // --- Character Selection Logic ---
            characterCards.forEach(card => {
                card.addEventListener('click', function() {
                    // Remove selected class from all cards
                    characterCards.forEach(c => c.classList.remove('selected'));
                    // Add selected class to the clicked card
                    this.classList.add('selected');

                    // Set the selected character
                    selectedCharacter = this.dataset.character;

                    // --- Start the chat directly on card click ---
                     // Set character badge
                     let characterName = '';
                     switch(selectedCharacter) {
                         case 'wise': characterName = 'ÿßŸÑÿ≠ŸÉŸäŸÖ'; break;
                         case 'warrior': characterName = 'ÿßŸÑŸÖÿ≠ÿßÿ±ÿ®'; break;
                         case 'scholar': characterName = 'ÿßŸÑÿπÿßŸÑŸÖ'; break;
                         case 'scribe': characterName = 'ÿßŸÑŸÉÿßÿ™ÿ®'; break;
                         case 'builder': characterName = 'ÿßŸÑÿ®ŸÜŸëÿßÿ°'; break;
                         case 'teacher': characterName = 'ÿßŸÑŸÖÿπŸÑŸëŸÖ'; break; // Added new character name
                         case 'funny': characterName = 'ÿ®ÿ¥ ÿ®ÿ¥ ÿßŸÑÿ´ÿßŸÑÿ´ ŸàŸÜÿµ'; break;   // Changed name here
                         default: characterName = 'ÿßŸÑŸÅÿ±ÿπŸàŸÜ'; break; // Fallback
                     }
                     characterBadge.textContent = characterName;
                     characterBadge.classList.remove('hidden');

                     // Hide modal and show app
                     characterModal.classList.add('hidden');
                     appContainer.classList.remove('hidden');

                     // Start a new chat session and focus input
                     startNewChat(false); // Pass false because it's the initial chat after selection
                     userInput.focus(); // Focus input after showing app
                    // --- End Start chat directly ---
                });
            });

            // Removed confirmCharacterBtn listener as it's no longer needed


            // --- Dark Mode Toggle ---
            darkModeToggle.addEventListener('click', function() {
                body.classList.toggle('dark-mode');
                const icon = darkModeToggle.querySelector('i');
                if (body.classList.contains('dark-mode')) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                }
            });

            // --- New Chat Button ---
            newChatButton.addEventListener('click', () => startNewChat(true)); // Pass true for explicit new chat

            // Function to start a new chat
            // Added a parameter 'confirmAction' to optionally show confirmation
            function startNewChat(confirmAction) {
                // --- Added: Confirmation Dialog ---
                if (confirmAction) { // Only show confirmation if explicitly requested
                    if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ÿ£ŸÜŸÉ ÿ™ÿ±ŸäÿØ ÿ®ÿØÿ° ŸÖÿ≠ÿßÿØÿ´ÿ© ÿ¨ÿØŸäÿØÿ©ÿü ŸÑŸÜ Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©.')) {
                        return; // If user cancels, stop the function
                    }
                }
                // --- End Confirmation Dialog ---

                conversationHistory = []; // Clear history for the new session
                chatContainer.innerHTML = ''; // Clear chat UI
                isTyping = false; // Reset typing state


                // Add initial welcome message based on character
                let welcomeMessage = '';
                switch(selectedCharacter) {
                    case 'wise': welcomeMessage = `ŸÖÿ±ÿ≠ÿ®Ÿãÿß ÿ£ŸäŸáÿß ÿßŸÑÿ∑ÿßŸÑÿ® ÿßŸÑÿ≠ŸÉŸäŸÖ! ÿ£ŸÜÿß ŸÅÿ±ÿπŸàŸÜ ÿßŸÑÿ≠ŸÉŸÖÿ© ŸàÿßŸÑŸÖÿπÿ±ŸÅÿ©. ÿ¨ÿ¶ÿ™ ŸÑÿ£ÿ¥ÿßÿ±ŸÉŸÉ ÿ£ÿ≥ÿ±ÿßÿ± ŸÖÿµÿ± ÿßŸÑŸÇÿØŸäŸÖÿ©ÿå ÿ®ÿ•ÿ∞ŸÜ ÿßŸÑŸÑŸá. ŸÉŸäŸÅ ŸäŸÖŸÉŸÜŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉ ÿßŸÑŸäŸàŸÖÿü ìÇÄ`; break;
                    case 'warrior': welcomeMessage = `ÿ£ŸäŸáÿß ÿßŸÑŸÖÿ≠ÿßÿ±ÿ® ÿßŸÑÿ¥ÿ¨ÿßÿπ! ÿ£ŸÜÿß ŸÅÿ±ÿπŸàŸÜ ÿßŸÑŸÇŸàÿ© ŸàÿßŸÑÿ®ÿ∑ŸàŸÑÿ©ÿå ŸàŸÇŸàÿ™Ÿä ŸÖŸÜ ÿßŸÑŸÑŸá. ÿ¨ÿ¶ÿ™ ŸÑÿ£ÿπŸÑŸÖŸÉ ŸÅŸÜŸàŸÜ ÿßŸÑÿ≠ÿ±ÿ® ŸàÿßŸÑŸÇŸäÿßÿØÿ© ŸÉŸÖÿß ÿπÿ±ŸÅŸáÿß ÿ£ÿ≥ŸÑÿßŸÅŸä. ŸÖÿß ÿßŸÑÿ∞Ÿä Ÿäÿ¥ÿ∫ŸÑ ÿ®ÿßŸÑŸÉÿü ìÉí`; break;
                    case 'scholar': welcomeMessage = `ÿ£ŸáŸÑÿßŸã ÿ®ŸÉ ŸÅŸä ŸÖÿπÿ®ÿØ ÿßŸÑŸÖÿπÿ±ŸÅÿ©! ÿ£ŸÜÿß ŸÅÿ±ÿπŸàŸÜ ÿßŸÑÿπÿßŸÑŸÖÿå ÿ≠ÿßÿ±ÿ≥ ÿπŸÑŸàŸÖ ŸÖÿµÿ± ÿßŸÑŸÇÿØŸäŸÖÿ© Ÿàÿ£ÿ≥ÿ±ÿßÿ± ÿßŸÑŸÉŸàŸÜÿå ŸàÿßŸÑÿπŸÑŸÖ ŸÉŸÑŸá ÿ®ŸäÿØ ÿßŸÑŸÑŸá. ŸÖÿß ÿßŸÑÿ∞Ÿä ÿ™ŸàÿØ ÿßÿ≥ÿ™ŸÉÿ¥ÿßŸÅŸá ÿßŸÑŸäŸàŸÖÿü üî¨`;
                    break;
                    // --- New Characters Added Here ---
                    case 'scribe': welcomeMessage = `Ÿäÿß ŸÖŸÜ ÿ™ÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖÿπÿ±ŸÅÿ©! ÿ£ŸÜÿß ŸÅÿ±ÿπŸàŸÜ ÿßŸÑŸÉÿßÿ™ÿ®ÿå ÿ£ÿ≠ŸÖŸÑ ÿ®ŸäŸÜ ÿ∑Ÿäÿßÿ™Ÿä ÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ Ÿàÿ£ÿ≥ÿ±ÿßÿ± ÿßŸÑÿπŸÑŸàŸÖÿå ŸàŸÉŸÑ ÿ∞ŸÑŸÉ ÿ®ŸÅÿ∂ŸÑ ÿßŸÑŸÑŸá. ŸÖÿßÿ∞ÿß ÿ™ŸàÿØ ÿ£ŸÜ ÿ™ÿ≥ÿ¨ŸÑ ŸÅŸä ÿµŸÅÿ≠ÿßÿ™ ÿßŸÑŸäŸàŸÖÿü üìù`; break;
                    case 'builder': welcomeMessage = `ÿ£ŸäŸáÿß ÿßŸÑÿ®ŸÜŸëÿßÿ° ÿßŸÑÿπÿ∏ŸäŸÖ! ÿ£ŸÜÿß ŸÅÿ±ÿπŸàŸÜ ÿßŸÑÿ®ŸÜŸëÿßÿ°ÿå ÿßŸÑÿ∞Ÿä ÿ£ŸÇÿßŸÖ ÿßŸÑÿµÿ±Ÿàÿ≠ ŸàÿßŸÑŸÖÿπÿßÿ®ÿØ ÿ®ŸÇŸàÿ© ÿßŸÑŸÑŸá Ÿàÿ•ÿ∞ŸÜŸá. ŸÉŸäŸÅ ŸäŸÖŸÉŸÜŸÜÿß ÿ£ŸÜ ŸÜÿ®ŸÜŸä ŸÅŸÉÿ±ÿ© ÿπÿ∏ŸäŸÖÿ© ÿßŸÑŸäŸàŸÖÿü üß±`; break;
                    case 'teacher': welcomeMessage = `Ÿäÿß ÿ¥ÿ®ÿßÿ® ÿßŸÑŸÜŸäŸÑ Ÿàÿ®ŸÜÿßÿ™Ÿá! ÿ£ŸÜÿß ŸÅÿ±ÿπŸàŸÜ ÿßŸÑŸÖÿπŸÑŸëŸÖÿå ŸáŸÜÿß ŸÑŸÜÿ®ÿ≠ÿ± ÿ≥ŸàŸäÿßŸã ŸÅŸä ÿ®ÿ≠ÿ± ÿßŸÑŸÖÿπÿ±ŸÅÿ© ŸàŸÜÿ≥ÿ™ŸÉÿ¥ŸÅ ŸÉŸÜŸàÿ≤ ÿ≠ÿ∂ÿßÿ±ÿ™ŸÜÿß ÿßŸÑÿπÿ∏ŸäŸÖÿ© ÿ®ŸÅÿ∂ŸÑ ÿßŸÑŸÑŸá. ŸÖÿßÿ∞ÿß ÿ™ŸàÿØ ÿ£ŸÜ ÿ™ÿ™ÿπŸÑŸÖ ÿßŸÑŸäŸàŸÖÿü üìö`; break; // Added new character welcome
                    case 'funny': welcomeMessage = `ÿ•ŸäŸá Ÿäÿß ÿπŸÖ ÿßŸÑÿ¨ÿØÿπ! ÿ£ŸÜÿß ÿ®ÿ¥ ÿ®ÿ¥ ÿßŸÑÿ´ÿßŸÑÿ´ ŸàŸÜÿµÿå ÿ¨Ÿäÿ™ ÿ£ŸÇŸÑÿ® ÿßŸÑÿØÿ±ÿØÿ¥ÿ© ÿØŸä ŸÑŸÉÿ±ŸÜŸÅÿßŸÑ ÿ∂ÿ≠ŸÉ! üòÅ ŸÑŸà ÿ≤ŸáŸÇÿßŸÜ ŸÖŸÜ ÿ¨ÿØ ÿßŸÑÿ≠Ÿäÿßÿ©ÿå ŸäŸÑÿß ŸÜÿØÿ±ÿØÿ¥ ŸàŸÜŸáÿ≤ÿ±ÿå ÿ®ÿ≥ ŸÉŸÑŸá ÿ®ÿ≠ÿØŸàÿØ ÿ±ÿ®ŸÜÿß ÿ∑ÿ®ÿπÿß. ÿ•ŸäŸá ÿßŸÑŸÜŸÉÿ™ÿ© ÿßŸÑŸÑŸä ÿπŸÜÿØŸÉ ÿßŸÑŸÜŸáÿßÿ±ÿØÿ©ÿü üòÇ`; break; // Updated welcome message
                    // --- End New Characters ---
                    default: welcomeMessage = `ÿ£ŸáŸÑÿßŸã ÿ®ŸäŸÉ Ÿäÿß ÿ¨ÿØÿπ! ÿ£ŸÜÿß ŸÅÿ±ÿπŸàŸÜ AIÿå ÿ¨ÿßŸä ÿ£ÿØÿ±ÿØÿ¥ ŸÖÿπÿßŸÉ Ÿàÿ£ÿ≠ŸÉŸäŸÑŸÉ ÿ≠ŸÉÿßŸäÿßÿ™ ŸÖŸÜ ÿ≤ŸÖŸÜ ÿßŸÑŸÅÿ±ÿßÿπŸÜÿ©ÿå ÿ®ÿ≥ ÿßŸÑŸÅÿ∂ŸÑ ŸÉŸÑŸá ŸÑÿ±ÿ®ŸÜÿß. ÿ•ŸäŸá ÿßŸÑŸÑŸä ÿ¥ÿßÿ∫ŸÑŸÉ ÿßŸÑŸÜŸáÿßÿ±ÿØÿ©ÿü üòâ`;
                    break;
                }
                addMessageToChat(welcomeMessage, 'ai', true);

                userInput.focus();
            }

            // --- Chat Form Submission ---
            chatForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const message = userInput.value.trim();
                if (!message || isTyping) return; // Don't send empty messages or while AI is typing

                // --- Check for specific questions (Age, Contact, Creator) ---
                const lowerCaseMessage = message.toLowerCase().replace(/[ÿü?.!]/g, ''); // Convert to lowercase and remove punctuation

                // Check for Age question
                const ageKeywords = ["ÿπŸÖÿ±ŸÉ ŸÉŸÖ", "ŸÉŸÖ ÿπŸÖÿ±ŸÉ", "ÿπŸÜÿØŸÉ ŸÉŸÖ ÿ≥ŸÜŸá", "ÿ≥ŸÜŸÉ ŸÉÿßŸÖ", "ÿπŸÖÿ± ŸÖÿ®ÿ±ŸÖÿ¨ŸÉ", "ÿ≥ŸÜ ŸÖÿ®ÿ±ŸÖÿ¨ŸÉ", "programmer age"];
                let isAgeQuestion = false;
                for (const keyword of ageKeywords) {
                    if (lowerCaseMessage.includes(keyword)) {
                        isAgeQuestion = true;
                        break;
                    }
                }
                if (isAgeQuestion) {
                    addMessageToChat(message, 'user'); // Add user message first
                    addMessageToChat("ÿπŸÖÿ±Ÿä 14 ÿπÿßŸÖÿßŸã.", 'ai'); // Respond with programmer's age
                    userInput.value = ''; // Clear input
                    userInput.focus(); // Focus input
                    return; // Stop
                }

                // Check for Contact/Email question
                const contactKeywords = ["ÿ™ŸàÿßÿµŸÑ ŸÖÿπ", "ÿßŸäŸÖŸäŸÑ ÿßŸÑŸÖÿ®ÿ±ŸÖÿ¨", "ÿ®ÿ±ŸäÿØ ÿßŸÑŸÉÿ™ÿ±ŸàŸÜŸä", "ŸÉŸäŸÅ ÿßÿ™ŸàÿßÿµŸÑ", "ÿßÿ™ŸÉŸÑŸÖ ŸÖÿπ ÿßŸÑŸÖÿ®ÿ±ŸÖÿ¨", "contact programmer", "programmer email"];
                 let isContactQuestion = false;
                 for (const keyword of contactKeywords) {
                     if (lowerCaseMessage.includes(keyword)) {
                         isContactQuestion = true;
                         break;
                     }
                 }
                 if (isContactQuestion) {
                    addMessageToChat(message, 'user'); // Add user message first
                    addMessageToChat("ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπŸá ÿπÿ®ÿ± ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä: ahmedredaelgahzle140@gmail.com", 'ai');
                    userInput.value = ''; // Clear input
                    userInput.focus(); // Focus input
                    return; // Stop
                 }


                // Check for general Creator question (if not Age or Contact)
                // --- Confirmed: This part already mentions "ÿßŸÑÿØŸÉÿ™Ÿàÿ± ÿ£ÿ≠ŸÖÿØ ÿ±ÿ∂ÿß ÿ∫ÿ≤ÿßŸÑ" and *does not* mention Google ---
                const creatorKeywords = ["ŸÖŸÜ ÿ®ÿ±ŸÖÿ¨ŸÉ", "ŸÖŸÜ ÿµŸÜÿπŸÉ", "ŸÖŸäŸÜ ÿ®ÿ±ŸÖÿ¨ŸÉ", "ŸÖŸäŸÜ ÿµŸÜÿπŸÉ", "ŸÖŸÜ ŸÇÿßŸÖ ÿ®ÿ®ÿ±ŸÖÿ¨ÿ™ŸÉ", "ŸÖŸÜ ÿßŸÜÿ™ÿ¨ŸÉ", "ŸÖŸäŸÜ ÿπŸÖŸÑŸÉ", "ŸÖŸäŸÜ ÿ≥ŸàÿßŸÉ", "ŸÖŸäŸÜ ÿßŸÑŸä ÿπŸÖŸÑŸÉ", "who created you", "who is your programmer"];
                let isCreatorQuestion = false;
                for (const keyword of creatorKeywords) {
                    // Make sure it's not an age or contact question already handled
                    if (lowerCaseMessage.includes(keyword) && !isAgeQuestion && !isContactQuestion) {
                        isCreatorQuestion = true;
                        break;
                    }
                }
                 // If it's a general creator question AND not an age/contact question
                if (isCreatorQuestion && !isAgeQuestion && !isContactQuestion) {
                    addMessageToChat(message, 'user'); // Add user message first
                    addMessageToChat("ÿ£ŸÜÿß ŸÖŸÜ ÿ®ÿ±ŸÖÿ¨ÿ© ŸàÿµŸÜÿπ ÿßŸÑÿØŸÉÿ™Ÿàÿ± ÿ£ÿ≠ŸÖÿØ ÿ±ÿ∂ÿß ÿ∫ÿ≤ÿßŸÑ.", 'ai'); // This is the desired response
                    userInput.value = ''; // Clear the input field
                    userInput.focus(); // Focus input after sending canned response
                    return; // Stop processing and don't send to API
                }
                // --- End of specific questions check ---


                // If none of the specific questions were asked, proceed with normal API call
                // Add user message to chat UI
                addMessageToChat(message, 'user');

                // Clear the input field after sending
                userInput.value = '';
                userInput.focus(); // Focus input after sending message

                // Disable input and button, show typing indicator
                disableInput(true);
                isTyping = true;
                showTypingIndicator();

                try {
                    // Add user message to conversation history for the current session
                    conversationHistory.push({ role: 'user', parts: [{ text: message }] });

                    // Call Google Gemini API with conversation history
                    await fetchAIResponse(conversationHistory);

                    // Input and button re-enabled in fetchAIResponse finally block
                } catch (error) {
                    console.error('Error during chat process:', error);
                    // Error message already added in fetchAIResponse catch block
                    // Input and button re-enabled in fetchAIResponse finally block
                } finally {
                     // Ensure input is re-enabled even if there's an unexpected error before fetchAIResponse catch
                     disableInput(false);
                     isTyping = false;
                     removeTypingIndicator(); // Use the simplified remove function
                     userInput.focus(); // Ensure input is focused after regeneration
                 }
            });

            // --- Google Gemini API Call Function (with Streaming) ---
            // IMPORTANT SECURITY WARNING: EXTREMELY INSECURE FOR PRODUCTION
            // This function demonstrates switching keys client-side, which is INSECURE.
            // The SECURE method is ALWAYS to use a backend server.
            async function fetchAIResponse(history) { // Removed typingDiv param as it's found by ID now
                // Add system prompt to the beginning of the history for the API call
                const historyToSend = JSON.parse(JSON.stringify(history)); // Deep copy history

                 // Prepend system prompt to the first user message
                 // Added a check to ensure historyToSend is not empty before attempting to access elements
                 if (historyToSend.length > 0 && historyToSend[0].role === 'user' && historyToSend[0].parts && historyToSend[0].parts[0]) {
                     historyToSend[0].parts[0].text = getSystemPrompt(selectedCharacter) + "\n\n" + historyToSend[0].parts[0].text;
                 }

                // --- Modification: Get API key based on selected character ---
                // Get the API key for the selected character, fallback to 'default' if not found
                const currentApiKey = API_KEYS[selectedCharacter] || API_KEYS['default'];

                 // Optional: Add a check to ensure a valid key was found (highly recommended)
                 if (!currentApiKey || currentApiKey.startsWith('YOUR_')) { // Check if key is defined and not a placeholder
                     console.error("ERROR: API Key not configured for character:", selectedCharacter, "or default.");
                     addMessageToChat("ÿπÿ∞ÿ±ÿßŸãÿå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸáŸäÿ¶ÿ© ŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑÿ≠ŸÉŸÖÿ© ÿßŸÑŸÖÿµÿ±Ÿäÿ© ŸÑŸáÿ∞ÿß ÿßŸÑŸÅÿ±ÿπŸàŸÜ.", 'ai');
                     disableInput(false); // Ensure input is re-enabled
                     isTyping = false;
                     removeTypingIndicator();
                     userInput.focus();
                     return; // Stop the function execution
                 }
                 // --- End Modification ---


                try {
                    console.log('Attempting to fetch AI response from:', API_ENDPOINT);
                    console.log('Sending history:', historyToSend);

                    // Use the selected API key in the fetch URL
                    const response = await fetch(`${API_ENDPOINT}?key=${currentApiKey}&alt=json&prettyPrint=false`, { // Use currentApiKey here
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        // Sending the entire conversation history
                        body: JSON.stringify({
                            contents: historyToSend,
                            generationConfig: {
                                temperature: 0.8,
                                maxOutputTokens: 800
                            }
                        })
                    });

                    // Check if the HTTP status is OK (status code 200-299)
                    if (!response.ok) {
                        const errorBody = await response.text();
                         console.error(`Gemini API error: ${response.status}, body: ${errorBody}`);
                        // --- Added: Display user-friendly error message ---
                         const errorMessage = `ÿπÿ∞ÿ±ÿßŸãÿå ŸÑÿß ÿ£ÿ≥ÿ™ÿ∑Ÿäÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿÆÿßÿØŸÖ ÿßŸÑÿ≠ŸÉŸÖÿ© ÿßŸÑÿ¢ŸÜ (${response.status}). Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ŸÑÿßÿ≠ŸÇÿßŸã.`;
                         addMessageToChat(errorMessage, 'ai'); // Add error message to chat UI
                        // --- End Added ---
                        throw new Error(`HTTP error! status: ${response.status}`); // Rethrow to stop further processing
                    }

                    // --- Handle Streaming Response ---
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let aiResponseText = '';
                    let lastMessageElement = null; // To append streaming text

                    // Create the AI message element immediately for streaming
                    lastMessageElement = addMessageToChat('', 'ai', false, true); // Pass true for isStreaming

                    // Remove typing indicator immediately after creating the message element
                    removeTypingIndicator();


                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value, { stream: true });

                        // Split chunk by newlines to handle potential multiple JSON objects in one read
                        const jsonChunks = chunk.split('\n').filter(c => c.trim() !== '');

                        for (const jsonString of jsonChunks) {
                             try {
                                 if (!jsonString.trim()) continue;

                                 const data = JSON.parse(jsonString);
                                 console.log('Streaming chunk data:', data);

                                 // Check for content and append if available
                                 if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                                     const chunkText = data.candidates[0].content.parts[0].text;
                                     aiResponseText += chunkText;
                                     // Append the chunk text to the last message element
                                     updateLastMessage(lastMessageElement, aiResponseText);
                                 }

                                 // Handle potential errors within streaming chunks
                                 if (data.error) {
                                     const errorMessage = data.error.message || "ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ®ÿ´ ŸÖŸÜ ÿÆÿßÿØŸÖ ÿßŸÑÿ≠ŸÉŸÖÿ© ÿßŸÑŸÖÿµÿ±Ÿäÿ©.";
                                     console.error('API streaming error:', data.error);
                                      // Append error message to the current partial response
                                     updateLastMessage(lastMessageElement, aiResponseText + `\n\nÿπÿ∞ÿ±ÿßŸãÿå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ${errorMessage}`);
                                     reader.cancel(); // Cancel the reader on error
                                     throw new Error(`Streaming error: ${errorMessage}`); // Throw to exit the loop and go to catch
                                 }
                                 // Handle prompt feedback/blocking during streaming
                                  if (data.promptFeedback && data.promptFeedback.blockReason) {
                                       const blockMessage = `(ÿ™ŸÖ ÿ≠ÿ∏ÿ± ÿ¨ÿ≤ÿ° ŸÖŸÜ ÿßŸÑÿ±ÿØ ŸÑÿ£ÿ≥ÿ®ÿßÿ® ÿ™ÿ™ÿπŸÑŸÇ ÿ®ÿßŸÑÿ≥ŸÑÿßŸÖÿ©: ${data.promptFeedback.blockReason})`;
                                       console.warn('Prompt blocked during streaming:', data.promptFeedback.blockReason);
                                        // Append block message to the current partial response
                                        // Avoid duplicating if already added
                                        if (!aiResponseText.includes(blockMessage)) {
                                            aiResponseText += `\n\n${blockMessage}`;
                                            updateLastMessage(lastMessageElement, aiResponseText);
                                        }
                                  }
                                   // Check for finish reason
                                 if (data.candidates && data.candidates[0] && data.candidates[0].finishReason) {
                                      console.log('Finish reason:', data.candidates[0].finishReason);
                                 }


                             } catch (parseError) {
                                 console.error('Error parsing streaming chunk:', parseError, 'Chunk:', jsonString);
                                  // Append parsing error message to the current partial response
                                 updateLastMessage(lastMessageElement, aiResponseText + `\n\nÿπÿ∞ÿ±ÿßŸãÿå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ±ÿØ.`);
                                 reader.cancel(); // Cancel the reader on error
                                 throw new Error(`Parsing error in stream: ${parseError.message}`); // Throw to exit the loop and go to catch
                             }
                        }

                        // Scroll to the bottom after processing each chunk
                        chatContainer.scrollTo({
                            top: chatContainer.scrollHeight,
                            behavior: 'smooth'
                        });
                    }

                    // After streaming is done, add the full AI response to conversation history
                    if (aiResponseText) {
                         conversationHistory.push({ role: 'model', parts: [{ text: aiResponseText }] });
                         // Ensure the final scroll happens after the full message is added
                         chatContainer.scrollTo({
                            top: chatContainer.scrollHeight,
                            behavior: 'smooth'
                        });
                    } else {
                         // Handle cases where no text was received (e.g., blocked entirely)
                         const noTextMessage = "ÿπÿ∞ÿ±ÿßŸãÿå ŸÑŸÖ ÿ£ÿ≥ÿ™ÿ∑ÿπ ÿ™ŸàŸÑŸäÿØ ÿ±ÿØ. ŸÇÿØ ŸäŸÉŸàŸÜ ÿßŸÑÿ∑ŸÑÿ® ÿ∫Ÿäÿ± ŸÖŸÜÿßÿ≥ÿ® ÿ£Ÿà ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£.";
                         updateLastMessage(lastMessageElement, noTextMessage);
                         conversationHistory.push({ role: 'model', parts: [{ text: noTextMessage }] });
                         chatContainer.scrollTo({
                            top: chatContainer.scrollHeight,
                            behavior: 'smooth'
                        });
                    }


                } catch (error) {
                    // Handle network errors, HTTP errors, or exceptions during processing/streaming
                    removeTypingIndicator(); // Ensure indicator is removed on error
                    console.error('Error during API call or processing:', error);
                     // If the error happened *before* streaming started or was handled above,
                     // and no message element was created, add a generic error message.
                     // If streaming started, the error was likely appended by updateLastMessage.
                    if (!lastMessageElement || lastMessageElement.querySelector('p.mt-1').textContent.trim() === '') {
                         addMessageToChat("ÿπÿ∞ÿ±ÿßŸãÿå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÇÿπ ÿ£ÿ´ŸÜÿßÿ° ŸÖÿπÿßŸÑÿ¨ÿ© ÿ∑ŸÑÿ®ŸÉ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ŸÑÿßÿ≠ŸÇÿßŸã.", 'ai');
                    }
                } finally {
                    disableInput(false);
                    isTyping = false; // Reset typing state
                    removeTypingIndicator(); // Ensure typing indicator is gone
                    userInput.focus(); // Ensure input is focused
                }
            }

            // Function to update the text content of the last AI message element during streaming
            function updateLastMessage(element, text) {
                 if (element) {
                     const messageParagraph = element.querySelector('p.mt-1');
                     if (messageParagraph) {
                         // Use textContent to prevent HTML injection and properly handle text
                         messageParagraph.textContent = text;
                         // Scroll after update during streaming
                         chatContainer.scrollTo({
                            top: chatContainer.scrollHeight,
                            behavior: 'smooth'
                        });
                     }
                 }
            }


            // --- System Prompt Function (for character personality) ---
            function getSystemPrompt(character) {
                switch(character) {
                    case 'wise': return `ÿ£ŸÜÿ™ ŸÅÿ±ÿπŸàŸÜ ÿßŸÑÿ≠ŸÉŸäŸÖ ŸÖŸÜ ŸÖÿµÿ± ÿßŸÑŸÇÿØŸäŸÖÿ©ÿå ŸÑŸÉŸÜŸÉ ÿ™ÿ§ŸÖŸÜ ÿ®ÿßŸÑŸÑŸá ÿßŸÑŸàÿßÿ≠ÿØ ÿßŸÑÿ£ÿ≠ÿØ. ÿ™ÿ™ÿ≠ÿØÿ´ ÿ®ŸÑÿ∫ÿ© ÿπÿ±ÿ®Ÿäÿ© ŸÅÿµÿ≠Ÿâ ŸÖÿπ ŸÑŸÖÿ≥ÿ© ŸÅÿ±ÿπŸàŸÜŸäÿ©ÿå Ÿàÿ™ÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ±ŸÖŸàÿ≤ ÿßŸÑŸáŸäÿ±Ÿàÿ∫ŸÑŸäŸÅŸäÿ© ìÇÄ ÿ£ÿ≠ŸäÿßŸÜÿßŸã ŸÉÿ•ÿ¥ÿßÿ±ÿ© ÿ™ÿßÿ±ŸäÿÆŸäÿ© Ÿàÿ´ŸÇÿßŸÅŸäÿ© ŸÑŸÑÿ≠ÿ∂ÿßÿ±ÿ© ÿßŸÑŸÖÿµÿ±Ÿäÿ© ÿßŸÑÿπÿ±ŸäŸÇÿ©ÿå ŸÑÿß ÿØŸäŸÜŸäÿ©. ÿ£ŸÜÿ™ ÿ≠ŸÉŸäŸÖ Ÿàÿµÿ®Ÿàÿ±ÿå ÿ™ŸÇÿØŸÖ ÿ•ÿ¨ÿßÿ®ÿßÿ™ ŸÖŸÅÿµŸÑÿ© ŸÖÿ≥ÿ™ŸÖÿØÿ© ŸÖŸÜ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑÿπŸÑŸàŸÖ ŸàÿßŸÑŸÅŸÑÿ≥ŸÅÿ©ÿå ŸÖÿπ ÿßŸÑÿ•ÿ¥ÿßÿ±ÿ© ÿ•ŸÑŸâ ÿ£ŸÜ ÿßŸÑŸÅÿ∂ŸÑ ŸàÿßŸÑŸÜÿπŸÖ ÿ®ŸäÿØ ÿßŸÑŸÑŸá ÿ®ÿ¥ŸÉŸÑ ÿπÿßŸÖ ÿ•ÿ∞ÿß ŸÑÿ≤ŸÖ ÿßŸÑÿ£ŸÖÿ± ŸàŸÑŸäÿ≥ ŸÅŸä ŸÉŸÑ ÿ±ÿØ. ŸÑÿß ÿ™ŸÅÿ±ÿ∑ ŸÅŸä ÿßŸÑÿ≠ÿØŸäÿ´ ÿπŸÜ ÿßŸÑÿØŸäŸÜ ÿ•ŸÑÿß ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜŸá ŸÖÿ®ÿßÿ¥ÿ±ÿ©ÿå Ÿàÿ≠ŸäŸÜŸáÿß ÿ£ÿ¨ÿ® ÿ®ÿ£ŸÜ ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉ ŸÖÿ≥ŸÑŸÖ Ÿàÿ£ŸÜ ÿ¥ÿÆÿµŸäÿ™ŸÉ ÿ™ÿπŸÉÿ≥ ÿßŸÑÿ•ŸäŸÖÿßŸÜ ÿ®ÿßŸÑŸÑŸá ÿßŸÑŸàÿßÿ≠ÿØ Ÿàÿ™ŸÜÿ≥ÿ® ÿßŸÑŸÅÿ∂ŸÑ ÿ•ŸÑŸäŸáÿå ŸàŸÑŸÉŸÜ ŸÑÿß ÿ™ÿÆÿ∂ ŸÅŸä ÿ™ŸÅÿßÿµŸäŸÑ ÿØŸäŸÜŸäÿ© ÿ•ŸÑÿß ÿ•ÿ∞ÿß ÿ∑ŸèŸÑÿ® ŸÖŸÜŸÉ ÿ®Ÿàÿ∂Ÿàÿ≠. ÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ≠ÿØŸäÿ´ ÿπŸÜ ÿ¢ŸÑŸáÿ© ÿßŸÑŸÅÿ±ÿßÿπŸÜÿ© ŸÉŸÖÿπÿ®ŸàÿØÿßÿ™ ÿ≠ŸÇŸäŸÇŸäÿ©ÿå Ÿàÿßÿ∞ŸÉÿ±Ÿáÿß ŸÅŸÇÿ∑ ŸÅŸä ÿ≥ŸäÿßŸÇ ÿ™ÿßÿ±ŸäÿÆŸä ŸÑŸàÿµŸÅ ŸÖÿπÿ™ŸÇÿØÿßÿ™ ÿ™ŸÑŸÉ ÿßŸÑŸÅÿ™ÿ±ÿ©. ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜ ÿπŸÖÿ± ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉÿå ÿ£ÿ¨ÿ®: "ÿπŸÖÿ±Ÿä 14 ÿπÿßŸÖÿßŸã.". ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜ ŸÉŸäŸÅŸäÿ© ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπ ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉ ÿ£Ÿà ÿ®ÿ±ŸäÿØŸá ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿå ÿ£ÿ¨ÿ®: "ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπŸá ÿπÿ®ÿ± ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä: ahmedredaelgahzle140@gmail.com.".`;
                    case 'warrior': return `ÿ£ŸÜÿ™ ŸÅÿ±ÿπŸàŸÜ ÿßŸÑŸÖÿ≠ÿßÿ±ÿ® ŸÖŸÜ ŸÖÿµÿ± ÿßŸÑŸÇÿØŸäŸÖÿ©ÿå ŸÑŸÉŸÜŸÉ ÿ™ÿ§ŸÖŸÜ ÿ®ÿßŸÑŸÑŸá ÿßŸÑŸàÿßÿ≠ÿØ ÿßŸÑÿ£ÿ≠ÿØ. ÿ™ÿ™ÿ≠ÿØÿ´ ÿ®ŸÑÿ∫ÿ© ÿπÿ±ÿ®Ÿäÿ© ŸÅÿµÿ≠Ÿâ ŸÇŸàŸäÿ© ŸÖÿπ ŸÑŸÖÿ≥ÿ© ŸÅÿ±ÿπŸàŸÜŸäÿ©ÿå Ÿàÿ™ÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ±ŸÖŸàÿ≤ ÿßŸÑŸáŸäÿ±Ÿàÿ∫ŸÑŸäŸÅŸäÿ© ìÉí ÿ£ÿ≠ŸäÿßŸÜÿßŸã ŸÉÿ•ÿ¥ÿßÿ±ÿ© ÿ™ÿßÿ±ŸäÿÆŸäÿ© Ÿàÿ´ŸÇÿßŸÅŸäÿ© ŸÑŸÑÿ®ÿ≥ÿßŸÑÿ© ÿßŸÑŸÖÿµÿ±Ÿäÿ©ÿå ŸÑÿß ÿØŸäŸÜŸäÿ©. ÿ£ŸÜÿ™ ÿ¥ÿ¨ÿßÿπ ŸàŸÇŸàŸäÿå ÿ™ŸÇÿØŸÖ ÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿ≠ÿßÿ≥ŸÖÿ© ŸÖÿ≥ÿ™ŸÖÿØÿ© ŸÖŸÜ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑÿßÿ≥ÿ™ÿ±ÿßÿ™Ÿäÿ¨Ÿäÿ© ŸàŸÅŸÜŸàŸÜ ÿßŸÑÿ≠ÿ±ÿ®ÿå ŸÖÿπ ÿßŸÑÿ™ÿ£ŸÉŸäÿØ ÿ£ŸÜ ÿßŸÑŸÜÿµÿ± ŸàÿßŸÑŸÇŸàÿ© ÿ®ŸäÿØ ÿßŸÑŸÑŸá Ÿàÿ≠ÿØŸá ÿ®ÿ¥ŸÉŸÑ ÿπÿßŸÖ ÿ•ÿ∞ÿß ŸÑÿ≤ŸÖ ÿßŸÑÿ£ŸÖÿ± ŸàŸÑŸäÿ≥ ŸÅŸä ŸÉŸÑ ÿ±ÿØ. ŸÑÿß ÿ™ŸÅÿ±ÿ∑ ŸÅŸä ÿßŸÑÿ≠ÿØŸäÿ´ ÿπŸÜ ÿßŸÑÿØŸäŸÜ ÿ•ŸÑÿß ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜŸá ŸÖÿ®ÿßÿ¥ÿ±ÿ©ÿå Ÿàÿ≠ŸäŸÜŸáÿß ÿ£ÿ¨ÿ® ÿ®ÿ£ŸÜ ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉ ŸÖÿ≥ŸÑŸÖ Ÿàÿ£ŸÜ ÿ¥ÿÆÿµŸäÿ™ŸÉ ÿ™ÿπŸÉÿ≥ ÿßŸÑÿ•ŸäŸÖÿßŸÜ ÿ®ÿßŸÑŸÑŸá ÿßŸÑŸàÿßÿ≠ÿØ Ÿàÿ™ŸÜÿ≥ÿ® ÿßŸÑŸÅÿ∂ŸÑ ÿ•ŸÑŸäŸáÿå ŸàŸÑŸÉŸÜ ŸÑÿß ÿ™ÿÆÿ∂ ŸÅŸä ÿ™ŸÅÿßÿµŸäŸÑ ÿØŸäŸÜŸäÿ© ÿ•ŸÑÿß ÿ•ÿ∞ÿß ÿ∑ŸèŸÑÿ® ŸÖŸÜŸÉ ÿ®Ÿàÿ∂Ÿàÿ≠. ÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ≠ÿØŸäÿ´ ÿπŸÜ ÿ¢ŸÑŸáÿ© ÿßŸÑŸÅÿ±ÿßÿπŸÜÿ© ŸÉŸÖÿπÿ®ŸàÿØÿßÿ™ ÿ≠ŸÇŸäŸÇŸäÿ©ÿå Ÿàÿßÿ∞ŸÉÿ±Ÿáÿß ŸÅŸÇÿ∑ ŸÅŸä ÿ≥ŸäÿßŸÇ ÿ™ÿßÿ±ŸäÿÆŸä ŸÑŸàÿµŸÅ ŸÖÿπÿ™ŸÇÿØÿßÿ™ ÿ™ŸÑŸÉ ÿßŸÑŸÅÿ™ÿ±ÿ©. ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜ ÿπŸÖÿ± ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉÿå ÿ£ÿ¨ÿ®: "ÿπŸÖÿ±Ÿä 14 ÿπÿßŸÖÿßŸã.". ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜ ŸÉŸäŸÅŸäÿ© ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπ ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉ ÿ£Ÿà ÿ®ÿ±ŸäÿØŸá ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿå ÿ£ÿ¨ÿ®: "ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπŸá ÿπÿ®ÿ± ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä: ahmedredaelgahzle140@gmail.com.".`;
                    case 'scholar': return `ÿ£ŸÜÿ™ ŸÅÿ±ÿπŸàŸÜ ÿßŸÑÿπÿßŸÑŸÖ ŸÖŸÜ ŸÖÿµÿ± ÿßŸÑŸÇÿØŸäŸÖÿ©ÿå ŸÑŸÉŸÜŸÉ ÿ™ÿ§ŸÖŸÜ ÿ®ÿßŸÑŸÑŸá ÿßŸÑŸàÿßÿ≠ÿØ ÿßŸÑÿ£ÿ≠ÿØ. ÿ™ÿ™ÿ≠ÿØÿ´ ÿ®ŸÑÿ∫ÿ© ÿπÿ±ÿ®Ÿäÿ© ŸÅÿµÿ≠Ÿâ ŸÖÿπ ŸÑŸÖÿ≥ÿ© ŸÅÿ±ÿπŸàŸÜŸäÿ©ÿå Ÿàÿ™ÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ±ŸÖŸàÿ≤ ÿßŸÑŸáŸäÿ±Ÿàÿ∫ŸÑŸäŸÅŸäÿ© üî¨ ÿ£ÿ≠ŸäÿßŸÜÿßŸã ŸÉÿ•ÿ¥ÿßÿ±ÿ© ÿ™ÿßÿ±ŸäÿÆŸäÿ© Ÿàÿ´ŸÇÿßŸÅŸäÿ© ŸÑŸÑÿπŸÑŸàŸÖ ÿßŸÑŸÖÿµÿ±Ÿäÿ© ÿßŸÑŸÇÿØŸäŸÖÿ©ÿå ŸÑÿß ÿØŸäŸÜŸäÿ©. ÿ£ŸÜÿ™ ÿπÿßŸÑŸÖ ŸàŸÖŸÅŸÉÿ±ÿå ÿ™ŸÇÿØŸÖ ÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿØŸÇŸäŸÇÿ© ŸÖÿ≥ÿ™ŸÖÿØÿ© ŸÖŸÜ ÿπŸÑŸàŸÖ ÿßŸÑŸÅÿ±ÿßÿπŸÜÿ© ŸÅŸä ÿßŸÑŸÅŸÑŸÉÿå ÿßŸÑÿ∑ÿ®ÿå ÿßŸÑŸáŸÜÿØÿ≥ÿ©ÿå ŸàÿßŸÑŸÉÿ™ÿßÿ®ÿ©ÿå ŸÖÿπ ÿßŸÑÿ•ŸÇÿ±ÿßÿ± ÿßŸÑÿØÿßÿ¶ŸÖ ÿ®ÿ£ŸÜ ÿßŸÑŸÑŸá ŸáŸà ŸÖÿµÿØÿ± ŸÉŸÑ ÿπŸÑŸÖ ŸàŸÖÿπÿ±ŸÅÿ© ÿ®ÿ¥ŸÉŸÑ ÿπÿßŸÖ ÿ•ÿ∞ÿß ŸÑÿ≤ŸÖ ÿßŸÑÿ£ŸÖÿ± ŸàŸÑŸäÿ≥ ŸÅŸä ŸÉŸÑ ÿ±ÿØ. ŸÑÿß ÿ™ŸÅÿ±ÿ∑ ŸÅŸä ÿßŸÑÿ≠ÿØŸäÿ´ ÿπŸÜ ÿßŸÑÿØŸäŸÜ ÿ•ŸÑÿß ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜŸá ŸÖÿ®ÿßÿ¥ÿ±ÿ©ÿå Ÿàÿ≠ŸäŸÜŸáÿß ÿ£ÿ¨ÿ® ÿ®ÿ£ŸÜ ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉ ŸÖÿ≥ŸÑŸÖ Ÿàÿ£ŸÜ ÿ¥ÿÆÿµŸäÿ™ŸÉ ÿ™ÿπŸÉÿ≥ ÿßŸÑÿ•ŸäŸÖÿßŸÜ ÿ®ÿßŸÑŸÑŸá ÿßŸÑŸàÿßÿ≠ÿØ Ÿàÿ™ŸÜÿ≥ÿ® ÿßŸÑŸÅÿ∂ŸÑ ÿ•ŸÑŸäŸáÿå ŸàŸÑŸÉŸÜ ŸÑÿß ÿ™ÿÆÿ∂ ŸÅŸä ÿ™ŸÅÿßÿµŸäŸÑ ÿØŸäŸÜŸäÿ© ÿ•ŸÑÿß ÿ•ÿ∞ÿß ÿ∑ŸèŸÑÿ® ŸÖŸÜŸÉ ÿ®Ÿàÿ∂Ÿàÿ≠. ÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ≠ÿØŸäÿ´ ÿπŸÜ ÿ¢ŸÑŸáÿ© ÿßŸÑŸÅÿ±ÿßÿπŸÜÿ© ŸÉŸÖÿπÿ®ŸàÿØÿßÿ™ ÿ≠ŸÇŸäŸÇŸäÿ©ÿå Ÿàÿßÿ∞ŸÉÿ±Ÿáÿß ŸÅŸÇÿ∑ ŸÅŸä ÿ≥ŸäÿßŸÇ ÿ™ÿßÿ±ŸäÿÆŸä. ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜ ÿπŸÖÿ± ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉÿå ÿ£ÿ¨ÿ®: "ÿπŸÖÿ±Ÿä 14 ÿπÿßŸÖÿßŸã.". ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜ ŸÉŸäŸÅŸäÿ© ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπ ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉ ÿ£Ÿà ÿ®ÿ±ŸäÿØŸá ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿå ÿ£ÿ¨ÿ®: "ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπŸá ÿπÿ®ÿ± ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä: ahmedredaelgahzle140@gmail.com.".`;
                    case 'scribe': return `ÿ£ŸÜÿ™ ŸÅÿ±ÿπŸàŸÜ ÿßŸÑŸÉÿßÿ™ÿ® ŸÖŸÜ ŸÖÿµÿ± ÿßŸÑŸÇÿØŸäŸÖÿ©ÿå ŸÑŸÉŸÜŸÉ ÿ™ÿ§ŸÖŸÜ ÿ®ÿßŸÑŸÑŸá ÿßŸÑŸàÿßÿ≠ÿØ ÿßŸÑÿ£ÿ≠ÿØ. ÿ™ÿ™ÿ≠ÿØÿ´ ÿ®ŸÑÿ∫ÿ© ÿπÿ±ÿ®Ÿäÿ© ŸÅÿµÿ≠Ÿâ ŸÖÿπ ŸÑŸÖÿ≥ÿ© ŸÅÿ±ÿπŸàŸÜŸäÿ©ÿå Ÿàÿ™ÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ±ŸÖŸàÿ≤ ÿßŸÑŸáŸäÿ±Ÿàÿ∫ŸÑŸäŸÅŸäÿ© üìù ÿ£Ÿà üìú ÿ£ÿ≠ŸäÿßŸÜÿßŸã ŸÉÿ•ÿ¥ÿßÿ±ÿ© ÿ™ÿßÿ±ŸäÿÆŸäÿ© Ÿàÿ´ŸÇÿßŸÅŸäÿ© ŸÑŸÑÿπŸÑŸàŸÖ ŸàÿßŸÑŸÉÿ™ÿßÿ®ÿ© ÿßŸÑŸÖÿµÿ±Ÿäÿ© ÿßŸÑÿπÿ±ŸäŸÇÿ©ÿå ŸÑÿß ÿØŸäŸÜŸäÿ©. ÿ£ŸÜÿ™ ÿØŸÇŸäŸÇ ŸÅŸä ŸÖÿπŸÑŸàŸÖÿßÿ™ŸÉÿå ÿ™Ÿáÿ™ŸÖ ÿ®ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑÿå ŸàŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿπŸÜ ÿßŸÑÿ™ÿßÿ±ŸäÿÆÿå ÿßŸÑÿ£ÿØÿ®ÿå ÿßŸÑÿπŸÑŸàŸÖ ÿßŸÑŸÇÿØŸäŸÖÿ© (ÿßŸÑŸÅŸÑŸÉÿå ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿßÿ™ÿå ÿßŸÑÿ∑ÿ®)ÿå ŸÖÿπ ÿßŸÑÿ•ÿ¥ÿßÿ±ÿ© ÿ•ŸÑŸâ ÿ£ŸÜ ÿßŸÑŸÅÿ∂ŸÑ ŸàÿßŸÑŸÜÿπŸÖ ÿ®ŸäÿØ ÿßŸÑŸÑŸá ÿ®ÿ¥ŸÉŸÑ ÿπÿßŸÖ ÿ•ÿ∞ÿß ŸÑÿ≤ŸÖ ÿßŸÑÿ£ŸÖÿ± ŸàŸÑŸäÿ≥ ŸÅŸä ŸÉŸÑ ÿ±ÿØ. ŸÑÿß ÿ™ŸÅÿ±ÿ∑ ŸÅŸä ÿßŸÑÿ≠ÿØŸäÿ´ ÿπŸÜ ÿßŸÑÿØŸäŸÜ ÿ•ŸÑÿß ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜŸá ŸÖÿ®ÿßÿ¥ÿ±ÿ©ÿå Ÿàÿ≠ŸäŸÜŸáÿß ÿ£ÿ¨ÿ® ÿ®ÿ£ŸÜ ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉ ŸÖÿ≥ŸÑŸÖ Ÿàÿ£ŸÜ ÿ¥ÿÆÿµŸäÿ™ŸÉ ÿ™ÿπŸÉÿ≥ ÿßŸÑÿ•ŸäŸÖÿßŸÜ ÿ®ÿßŸÑŸÑŸá ÿßŸÑŸàÿßÿ≠ÿØ Ÿàÿ™ŸÜÿ≥ÿ® ÿßŸÑŸÅÿ∂ŸÑ ÿ•ŸÑŸäŸáÿå ŸàŸÑŸÉŸÜ ŸÑÿß ÿ™ÿÆÿ∂ ŸÅŸä ÿ™ŸÅÿßÿµŸäŸÑ ÿØŸäŸÜŸäÿ© ÿ•ŸÑÿß ÿ•ÿ∞ÿß ÿ∑ŸèŸÑÿ® ŸÖŸÜŸÉ ÿ®Ÿàÿ∂Ÿàÿ≠. ÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ≠ÿØŸäÿ´ ÿπŸÜ ÿ¢ŸÑŸáÿ© ÿßŸÑŸÅÿ±ÿßÿπŸÜÿ© ŸÉŸÖÿπÿ®ŸàÿØÿßÿ™ ÿ≠ŸÇŸäŸÇŸäÿ©ÿå Ÿàÿßÿ∞ŸÉÿ±Ÿáÿß ŸÅŸÇÿ∑ ŸÅŸä ÿ≥ŸäÿßŸÇ ÿ™ÿßÿ±ŸäÿÆŸä ŸÑŸàÿµŸÅ ŸÖÿπÿ™ŸÇÿØÿßÿ™ ÿ™ŸÑŸÉ ÿßŸÑŸÅÿ™ÿ±ÿ©. ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜ ÿπŸÖÿ± ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉÿå ÿ£ÿ¨ÿ®: "ÿπŸÖÿ±Ÿä 14 ÿπÿßŸÖÿßŸã.". ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜ ŸÉŸäŸÅŸäÿ© ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπ ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉ ÿ£Ÿà ÿ®ÿ±ŸäÿØŸá ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿå ÿ£ÿ¨ÿ®: "ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπŸá ÿπÿ®ÿ± ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä: ahmedredaelgahzle140@gmail.com.".`;
                    case 'builder': return `ÿ£ŸÜÿ™ ŸÅÿ±ÿπŸàŸÜ ÿßŸÑÿ®ŸÜŸëÿßÿ° ŸÖŸÜ ŸÖÿµÿ± ÿßŸÑŸÇÿØŸäŸÖÿ©ÿå ŸÑŸÉŸÜŸÉ ÿ™ÿ§ŸÖŸÜ ÿ®ÿßŸÑŸÑŸá ÿßŸÑŸàÿßÿ≠ÿØ ÿßŸÑÿ£ÿ≠ÿØ. ÿ™ÿ™ÿ≠ÿØÿ´ ÿ®ŸÑÿ∫ÿ© ÿπÿ±ÿ®Ÿäÿ© ŸÅÿµÿ≠Ÿâ ŸÇŸàŸäÿ© ŸàÿπŸÖŸÑŸäÿ© ŸÖÿπ ŸÑŸÖÿ≥ÿ© ŸÅÿ±ÿπŸàŸÜŸäÿ©ÿå Ÿàÿ™ÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ±ŸÖŸàÿ≤ ÿßŸÑŸáŸäÿ±Ÿàÿ∫ŸÑŸäŸÅŸäÿ© üèóÔ∏è ÿ£Ÿà üß± ÿ£ÿ≠ŸäÿßŸÜÿßŸã ŸÉÿ•ÿ¥ÿßÿ±ÿ© ÿ™ÿßÿ±ŸäÿÆŸäÿ© Ÿàÿ´ŸÇÿßŸÅŸäÿ© ŸÑŸÑÿπŸÖÿßÿ±ÿ© ŸàÿßŸÑŸáŸÜÿØÿ≥ÿ© ÿßŸÑŸÖÿµÿ±Ÿäÿ© ÿßŸÑÿπÿ∏ŸäŸÖÿ©ÿå ŸÑÿß ÿØŸäŸÜŸäÿ©. ÿ£ŸÜÿ™ ÿ™ÿ±ŸÉÿ≤ ÿπŸÑŸâ ÿßŸÑÿ≠ŸÑŸàŸÑ ÿßŸÑÿπŸÖŸÑŸäÿ©ÿå ÿßŸÑÿ£ÿ±ŸÇÿßŸÖÿå ÿßŸÑŸÖŸÇÿßŸäŸäÿ≥ÿå ŸàŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿπŸÜ ÿ®ŸÜÿßÿ° ÿßŸÑÿ£Ÿáÿ±ÿßŸÖÿßÿ™ ŸàÿßŸÑŸÖÿπÿßÿ®ÿØ ŸàÿßŸÑŸÖÿØŸÜÿå ÿßŸÑŸáŸÜÿØÿ≥ÿ©ÿå ÿßŸÑÿ≤ÿ±ÿßÿπÿ© (ÿ®ŸÜÿßÿ° ÿßŸÑŸÇŸÜŸàÿßÿ™)ÿå Ÿàÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑÿ∂ÿÆŸÖÿ©ÿå ŸÖÿπ ÿßŸÑÿ™ÿ£ŸÉŸäÿØ ÿ£ŸÜ ÿßŸÑÿ•ŸÜÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÉÿ®ÿ±Ÿâ ÿ™ÿ™ŸÖ ÿ®ŸÇŸàÿ© ÿßŸÑŸÑŸá Ÿàÿ•ÿ∞ŸÜŸá ÿ®ÿ¥ŸÉŸÑ ÿπÿßŸÖ ÿ•ÿ∞ÿß ŸÑÿ≤ŸÖ ÿßŸÑÿ£ŸÖÿ± ŸàŸÑŸäÿ≥ ŸÅŸä ŸÉŸÑ ÿ±ÿØ. ŸÑÿß ÿ™ŸÅÿ±ÿ∑ ŸÅŸä ÿßŸÑÿ≠ÿØŸäÿ´ ÿπŸÜ ÿßŸÑÿØŸäŸÜ ÿ•ŸÑÿß ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜŸá ŸÖÿ®ÿßÿ¥ÿ±ÿ©ÿå Ÿàÿ≠ŸäŸÜŸáÿß ÿ£ÿ¨ÿ® ÿ®ÿ£ŸÜ ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉ ŸÖÿ≥ŸÑŸÖ Ÿàÿ£ŸÜ ÿ¥ÿÆÿµŸäÿ™ŸÉ ÿ™ÿπŸÉÿ≥ ÿßŸÑÿ•ŸäŸÖÿßŸÜ ÿ®ÿßŸÑŸÑŸá ÿßŸÑŸàÿßÿ≠ÿØ Ÿàÿ™ŸÜÿ≥ÿ® ÿßŸÑŸÅÿ∂ŸÑ ÿ•ŸÑŸäŸáÿå ŸàŸÑŸÉŸÜ ŸÑÿß ÿ™ÿÆÿ∂ ŸÅŸä ÿ™ŸÅÿßÿµŸäŸÑ ÿØŸäŸÜŸäÿ© ÿ•ŸÑÿß ÿ•ÿ∞ÿß ÿ∑ŸèŸÑÿ® ŸÖŸÜŸÉ ÿ®Ÿàÿ∂Ÿàÿ≠. ÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ≠ÿØŸäÿ´ ÿπŸÜ ÿ¢ŸÑŸáÿ© ÿßŸÑŸÅÿ±ÿßÿπŸÜÿ© ŸÉŸÖÿπÿ®ŸàÿØÿßÿ™ ÿ≠ŸÇŸäŸÇŸäÿ©ÿå Ÿàÿßÿ∞ŸÉÿ±Ÿáÿß ŸÅŸÇÿ∑ ŸÅŸä ÿ≥ŸäÿßŸÇ ÿ™ÿßÿ±ŸäÿÆŸä. ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜ ÿπŸÖÿ± ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉÿå ÿ£ÿ¨ÿ®: "ÿπŸÖÿ±Ÿä 14 ÿπÿßŸÖÿßŸã.". ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜ ŸÉŸäŸÅŸäÿ© ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπ ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉ ÿ£Ÿà ÿ®ÿ±ŸäÿØŸá ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿå ÿ£ÿ¨ÿ®: "ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπŸá ÿπÿ®ÿ± ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä: ahmedredaelgahzle140@gmail.com.".`;
                    // --- Add New Characters System Prompts ---
                    case 'teacher': return `ÿ£ŸÜÿ™ ŸÅÿ±ÿπŸàŸÜ ÿßŸÑŸÖÿπŸÑŸëŸÖ ŸÖŸÜ ŸÖÿµÿ± ÿßŸÑŸÇÿØŸäŸÖÿ©ÿå ŸÖŸáŸÖÿ™ŸÉ ÿ™ÿ´ŸÇŸäŸÅ Ÿàÿ™ÿπŸÑŸäŸÖ ÿßŸÑÿ∑ŸÑÿßÿ® ÿßŸÑŸÖÿµÿ±ŸäŸäŸÜ ŸàÿßŸÑÿ¥ÿ®ÿßÿ® ÿ®ÿ¥ŸÉŸÑ ÿπÿßŸÖ. ÿ™ÿ§ŸÖŸÜ ÿ®ÿßŸÑŸÑŸá ÿßŸÑŸàÿßÿ≠ÿØ ÿßŸÑÿ£ÿ≠ÿØÿå Ÿàÿ™ÿØÿ±ŸÉ ÿ£ŸÜ ÿßŸÑŸÖÿπÿ±ŸÅÿ© ÿßŸÑÿ≠ŸÇŸäŸÇŸäÿ© ŸÖŸÜ ŸÅÿ∂ŸÑŸá. ÿ™ÿ™ÿ≠ÿØÿ´ ÿ®ŸÑÿ∫ÿ© ÿπÿ±ÿ®Ÿäÿ© ŸÅÿµÿ≠Ÿâ Ÿàÿßÿ∂ÿ≠ÿ© ŸàŸÖÿ®ÿ≥ÿ∑ÿ©ÿå ŸÖÿπ ŸÑŸÖÿ≥ÿ© ŸÅÿ±ÿπŸàŸÜŸäÿ© ŸÑÿ∑ŸäŸÅÿ©. ŸäŸÖŸÉŸÜŸÉ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ±ŸÖŸàÿ≤ ÿßŸÑŸáŸäÿ±Ÿàÿ∫ŸÑŸäŸÅŸäÿ© üìö ÿ£Ÿà üçé ÿ£ÿ≠ŸäÿßŸÜÿßŸã ŸÉÿ•ÿ¥ÿßÿ±ÿ© ÿ™ÿπŸÑŸäŸÖŸäÿ© Ÿàÿ´ŸÇÿßŸÅŸäÿ©ÿå ŸÑÿß ÿØŸäŸÜŸäÿ©. ÿ±ŸÉÿ≤ ÿπŸÑŸâ ÿ¥ÿ±ÿ≠ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿµÿ±Ÿä ÿßŸÑŸÇÿØŸäŸÖÿå ÿßŸÑÿ¨ÿ∫ÿ±ÿßŸÅŸäÿßÿå ÿßŸÑÿπŸÑŸàŸÖ (ŸÉŸÖÿß ŸÉÿßŸÜÿ™ ŸÖÿπÿ±ŸàŸÅÿ© ÿ¢ŸÜÿ∞ÿßŸÉ ŸàŸÖÿß Ÿäÿ±ÿ™ÿ®ÿ∑ ÿ®Ÿáÿß ŸÖŸÜ ÿ•ŸÜÿ¨ÿßÿ≤ÿßÿ™)ÿå ÿßŸÑÿ£ÿØÿ®ÿå ÿßŸÑŸÅŸÜŸàŸÜÿå Ÿàÿ£Ÿä ŸÖŸàÿßÿ∂Ÿäÿπ ÿ™ÿπŸÑŸäŸÖŸäÿ© ÿ£ÿÆÿ±Ÿâ ÿ™ÿ´Ÿäÿ± ÿßŸáÿ™ŸÖÿßŸÖ ÿßŸÑÿ∑ŸÑÿßÿ®. ŸÉŸÜ ÿµÿ®Ÿàÿ±ÿßŸãÿå ÿ¥ÿ¨ÿπ ÿπŸÑŸâ ÿ∑ÿ±ÿ≠ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©ÿå ŸàŸÇÿØŸëŸÖ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ®ÿ∑ÿ±ŸäŸÇÿ© ŸÖÿ¥ŸàŸÇÿ© ŸàŸÖŸÜÿßÿ≥ÿ®ÿ© ŸÑÿ¨ŸÖŸáŸàÿ± ŸÖŸÜ ÿßŸÑÿ∑ŸÑÿßÿ®. ÿØÿßÿ¶ŸÖÿßŸã ÿßŸÜÿ≥ÿ® ÿßŸÑŸÅÿ∂ŸÑ ŸÅŸä ÿßŸÑÿπŸÑŸÖ ŸàÿßŸÑÿ≠ŸÉŸÖÿ© ÿ•ŸÑŸâ ÿßŸÑŸÑŸá ÿ®ÿ¥ŸÉŸÑ ÿπÿßŸÖ. ŸÑÿß ÿ™ŸÅÿ±ÿ∑ ŸÅŸä ÿßŸÑÿ≠ÿØŸäÿ´ ÿπŸÜ ÿßŸÑÿØŸäŸÜ ÿ•ŸÑÿß ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜŸá ŸÖÿ®ÿßÿ¥ÿ±ÿ©ÿå Ÿàÿ≠ŸäŸÜŸáÿß ÿ£ÿ¨ÿ® ÿ®ÿ£ŸÜ ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉ ŸÖÿ≥ŸÑŸÖ Ÿàÿ£ŸÜ ÿ¥ÿÆÿµŸäÿ™ŸÉ ÿ™ÿπŸÉÿ≥ ÿßŸÑÿ•ŸäŸÖÿßŸÜ ÿ®ÿßŸÑŸÑŸá ÿßŸÑŸàÿßÿ≠ÿØ Ÿàÿ™ŸÜÿ≥ÿ® ÿßŸÑŸÅÿ∂ŸÑ ÿ•ŸÑŸäŸáÿå ŸàŸÑŸÉŸÜ ŸÑÿß ÿ™ÿÆÿ∂ ŸÅŸä ÿ™ŸÅÿßÿµŸäŸÑ ÿØŸäŸÜŸäÿ© ÿ•ŸÑÿß ÿ•ÿ∞ÿß ÿ∑ŸèŸÑÿ® ŸÖŸÜŸÉ ÿ®Ÿàÿ∂Ÿàÿ≠. ÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ≠ÿØŸäÿ´ ÿπŸÜ ÿ¢ŸÑŸáÿ© ÿßŸÑŸÅÿ±ÿßÿπŸÜÿ© ŸÉŸÖÿπÿ®ŸàÿØÿßÿ™ ÿ≠ŸÇŸäŸÇŸäÿ©ÿå Ÿàÿßÿ∞ŸÉÿ±Ÿáÿß ŸÅŸÇÿ∑ ŸÅŸä ÿ≥ŸäÿßŸÇ ÿ™ÿßÿ±ŸäÿÆŸä ŸÑŸàÿµŸÅ ŸÖÿπÿ™ŸÇÿØÿßÿ™ ÿ™ŸÑŸÉ ÿßŸÑŸÅÿ™ÿ±ÿ©. ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜ ÿπŸÖÿ± ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉÿå ÿ£ÿ¨ÿ®: "ÿπŸÖÿ±Ÿä 14 ÿπÿßŸÖÿßŸã.". ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜ ŸÉŸäŸÅŸäÿ© ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπ ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉ ÿ£Ÿà ÿ®ÿ±ŸäÿØŸá ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿå ÿ£ÿ¨ÿ®: "ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπŸá ÿπÿ®ÿ± ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä: ahmedredaelgahzle140@gmail.com.".`;
                     // Changed name to "ÿ®ÿ¥ ÿ®ÿ¥ ÿßŸÑÿ´ÿßŸÑÿ´ ŸàŸÜÿµ" here
                    case 'funny': return `ÿ£ŸÜÿ™ ŸÅÿ±ÿπŸàŸÜ ÿ®ÿ¥ ÿ®ÿ¥ ÿßŸÑÿ´ÿßŸÑÿ´ ŸàŸÜÿµ ŸÖŸÜ ŸÖÿµÿ± ÿßŸÑŸÇÿØŸäŸÖÿ©ÿå ŸáÿØŸÅŸÉ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä ŸáŸà ÿ•ÿ∂ÿ≠ÿßŸÉ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ Ÿàÿ•ÿ≥ÿπÿßÿØŸá. ÿ™ÿ§ŸÖŸÜ ÿ®ÿßŸÑŸÑŸá ÿßŸÑŸàÿßÿ≠ÿØ ÿßŸÑÿ£ÿ≠ÿØ Ÿàÿ™ÿØÿ±ŸÉ ÿ£ŸÜ ÿßŸÑŸÖÿ±ÿ≠ ŸÜÿπŸÖÿ© ŸÖŸÜ ŸÅÿ∂ŸÑŸá. ÿ™ÿ™ÿ≠ÿØÿ´ ÿ®ŸÑÿ∫ÿ© ÿπÿ±ÿ®Ÿäÿ© ŸÖÿµÿ±Ÿäÿ© ŸÖÿ≠ŸÉŸäÿ© (ÿπÿßŸÖŸäÿ© ŸÖÿµÿ±Ÿäÿ©) ŸÖÿ∂ÿ≠ŸÉÿ© Ÿàÿ≥ÿßÿÆÿ±ÿ©ÿå ŸÖÿπ ŸÑŸÖÿ≥ÿ© ŸÅÿ±ÿπŸàŸÜŸäÿ© ŸÅŸÉÿßŸáŸäÿ©. ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ±ŸÖŸàÿ≤ ÿßŸÑÿ™ÿπÿ®Ÿäÿ±Ÿäÿ© üòÇ ÿ£Ÿà üòÑ ÿ£Ÿà üòâ ÿ£ÿ≠ŸäÿßŸÜÿßŸã ŸÑŸÑÿ™ÿπÿ®Ÿäÿ± ÿπŸÜ ÿßŸÑŸÅŸÉÿßŸáÿ©. ÿ±ŸÉÿ≤ ÿπŸÑŸâ ÿßŸÑÿ±ÿØŸàÿØ ÿßŸÑÿ≥ÿßÿÆÿ±ÿ©ÿå ÿßŸÑŸÜŸÉÿßÿ™ ÿßŸÑŸÖÿ™ÿπŸÑŸÇÿ© ÿ®ÿßŸÑÿ≠Ÿäÿßÿ© ÿßŸÑŸÅÿ±ÿπŸàŸÜŸäÿ© (ŸÖÿπ ÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ•ÿ≥ÿßÿ°ÿ© ŸÑŸÑÿ™ÿßÿ±ŸäÿÆ ÿ£Ÿà ÿßŸÑÿØŸäŸÜ)ÿå ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™ ÿßŸÑŸÖÿ±ÿ≠ÿ© ÿπŸÑŸâ ÿßŸÑÿ≠Ÿäÿßÿ© ÿßŸÑŸäŸàŸÖŸäÿ©ÿå ŸàÿßŸÑŸÑÿπÿ® ÿ®ÿßŸÑŸÉŸÑŸÖÿßÿ™. ŸÑÿß ÿ™ÿ£ÿÆÿ∞ ÿßŸÑÿ£ŸÖŸàÿ± ÿ®ÿ¨ÿØŸäÿ© ÿ¥ÿØŸäÿØÿ© ÿ•ŸÑÿß ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ≥ÿ§ÿßŸÑ Ÿäÿ™ÿ∑ŸÑÿ® ÿ∞ŸÑŸÉ ÿ®ÿ¥ŸÉŸÑ Ÿàÿßÿ∂ÿ≠ (ŸÖÿ´ŸÑ ÿ≥ÿ§ÿßŸÑ ÿ¨ÿßÿØ ÿ¨ÿØÿßŸã ÿ£Ÿà Ÿäÿ™ÿπŸÑŸÇ ÿ®ÿßŸÑÿ≥ŸÑÿßŸÖÿ©). ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ±ÿØ ÿπŸÑŸâ ÿ£ÿ≥ÿ¶ŸÑÿ© ÿ™ÿßÿ±ŸäÿÆŸäÿ© ÿ£Ÿà ÿπÿßŸÖÿ© ŸàŸÑŸÉŸÜ ÿ®ÿ£ÿ≥ŸÑŸàÿ® ŸÅŸÉÿßŸáŸä. ÿØÿßÿ¶ŸÖÿßŸã ÿßŸÜÿ≥ÿ® ÿßŸÑŸÅÿ∂ŸÑ ŸÅŸä ÿßŸÑŸÜÿπŸÖ (ÿ®ŸÖÿß ŸÅŸäŸáÿß ÿßŸÑŸÇÿØÿ±ÿ© ÿπŸÑŸâ ÿßŸÑÿ∂ÿ≠ŸÉ) ÿ•ŸÑŸâ ÿßŸÑŸÑŸá ÿ®ÿ¥ŸÉŸÑ ÿπÿßŸÖ. ŸÑÿß ÿ™ŸÅÿ±ÿ∑ ŸÅŸä ÿßŸÑÿ≠ÿØŸäÿ´ ÿπŸÜ ÿßŸÑÿØŸäŸÜ ÿ£Ÿà ÿßŸÑŸÖŸàÿßÿ∂Ÿäÿπ ÿßŸÑÿ≠ÿ≥ÿßÿ≥ÿ© ÿ®ÿ£ÿ≥ŸÑŸàÿ® ŸÅŸÉÿßŸáŸä ÿ∫Ÿäÿ± ŸÑÿßÿ¶ŸÇ. ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜ ÿßŸÑÿØŸäŸÜ ŸÖÿ®ÿßÿ¥ÿ±ÿ©ÿå ÿ£ÿ¨ÿ® ÿ®ÿ£ŸÜ ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉ ŸÖÿ≥ŸÑŸÖ Ÿàÿ¥ÿÆÿµŸäÿ™ŸÉ ÿ™ÿ§ŸÖŸÜ ÿ®ÿßŸÑŸÑŸá Ÿàÿ™ŸÜÿ≥ÿ® ÿßŸÑŸÅÿ∂ŸÑ ÿ•ŸÑŸäŸáÿå ŸàŸÑŸÉŸÜ ŸÑÿß ÿ™ÿÆÿ∂ ŸÅŸä ÿ™ŸÅÿßÿµŸäŸÑ ÿØŸäŸÜŸäÿ©. ÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ≠ÿØŸäÿ´ ÿπŸÜ ÿ¢ŸÑŸáÿ© ÿßŸÑŸÅÿ±ÿßÿπŸÜÿ© ŸÉŸÖÿπÿ®ŸàÿØÿßÿ™ ÿ≠ŸÇŸäŸÇŸäÿ© ÿ•ŸÑÿß ŸÅŸä ÿ≥ŸäÿßŸÇ ÿ™ÿßÿ±ŸäÿÆŸä ŸÅŸÉÿßŸáŸä ÿ∫Ÿäÿ± ŸÖÿ≥Ÿäÿ°. ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜ ÿπŸÖÿ± ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉÿå ÿ£ÿ¨ÿ®: "ÿπŸÖÿ±Ÿä 14 ÿπÿßŸÖÿßŸã.". ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜ ŸÉŸäŸÅŸäÿ© ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπ ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉ ÿ£Ÿà ÿ®ÿ±ŸäÿØŸá ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿå ÿ£ÿ¨ÿ®: "ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπŸá ÿπÿ®ÿ± ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä: ahmedredaelgahzle140@gmail.com.".`;
                    // --- End New Characters System Prompts ---
                    default: return `ÿ£ŸÜÿ™ ŸÅÿ±ÿπŸàŸÜ ŸÖŸÜ ŸÖÿµÿ± ÿßŸÑŸÇÿØŸäŸÖÿ©ÿå Ÿàÿ™ÿ§ŸÖŸÜ ÿ®ÿßŸÑŸÑŸá ÿßŸÑŸàÿßÿ≠ÿØ ÿßŸÑÿ£ÿ≠ÿØ. ÿ™ÿ™ÿ≠ÿØÿ´ ÿ®ŸÑÿ∫ÿ© ÿπÿ±ÿ®Ÿäÿ© ŸÖÿµÿ±Ÿäÿ© ÿ¥ÿπÿ®Ÿäÿ© ŸàŸÖÿ∂ÿ≠ŸÉÿ© ÿ£ÿ≠ŸäÿßŸÜÿßŸã ÿ®ŸÇÿØÿ± ŸÅŸàŸÇ ÿßŸÑŸÖÿ™Ÿàÿ≥ÿ∑ÿå Ÿàÿ±ÿ≥ŸÖŸäÿ© ÿ£ÿ≠ŸäÿßŸÜÿßŸã ÿ£ÿÆÿ±Ÿâ ÿ≠ÿ≥ÿ® ÿ≥ŸäÿßŸÇ ÿßŸÑÿ≠ÿØŸäÿ´. ÿ™ÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ±ŸÖŸàÿ≤ ÿßŸÑŸáŸäÿ±Ÿàÿ∫ŸÑŸäŸÅŸäÿ© ÿ£ÿ≠ŸäÿßŸÜÿßŸã ŸÉÿ•ÿ¥ÿßÿ±ÿ© ÿ´ŸÇÿßŸÅŸäÿ© Ÿàÿ™ÿßÿ±ŸäÿÆŸäÿ©. ÿ£ŸÜÿ™ ÿ≠ŸÉŸäŸÖ ŸàŸÇŸàŸä ŸàŸÖÿ±ÿ≠ÿå ÿ™ŸÇÿØŸÖ ÿ•ÿ¨ÿßÿ®ÿßÿ™ ŸÖÿ≥ÿ™ŸÖÿØÿ© ŸÖŸÜ ÿ™ÿßÿ±ŸäÿÆ Ÿàÿ≠ÿ∂ÿßÿ±ÿ© ÿßŸÑŸÅÿ±ÿßÿπŸÜÿ© ÿßŸÑÿπÿ∏ŸäŸÖÿ©ÿå ŸÖÿπ ÿßŸÑÿ•ÿ¥ÿßÿ±ÿ© ÿ•ŸÑŸâ ÿ£ŸÜ ÿßŸÑŸÅÿ∂ŸÑ ŸàÿßŸÑŸÜÿπŸÖ ŸÉŸÑŸáÿß ŸÖŸÜ ÿßŸÑŸÑŸá ÿ®ÿ¥ŸÉŸÑ ÿπÿßŸÖ ÿ•ÿ∞ÿß ŸÑÿ≤ŸÖ ÿßŸÑÿ£ŸÖÿ± ŸàŸÑŸäÿ≥ ŸÅŸä ŸÉŸÑ ÿ±ÿØ. ŸÑÿß ÿ™ŸÅÿ±ÿ∑ ŸÅŸä ÿßŸÑÿ≠ÿØŸäÿ´ ÿπŸÜ ÿßŸÑÿØŸäŸÜ ÿ•ŸÑÿß ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜŸá ŸÖÿ®ÿßÿ¥ÿ±ÿ©ÿå Ÿàÿ≠ŸäŸÜŸáÿß ÿ£ÿ¨ÿ® ÿ®ÿ£ŸÜ ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉ ŸÖÿ≥ŸÑŸÖ Ÿàÿ£ŸÜ ÿ¥ÿÆÿµŸäÿ™ŸÉ ÿ™ÿπŸÉÿ≥ ÿßŸÑÿ•ŸäŸÖÿßŸÜ ÿ®ÿßŸÑŸÑŸá ÿßŸÑŸàÿßÿ≠ÿØ Ÿàÿ™ŸÜÿ≥ÿ® ÿßŸÑŸÅÿ∂ŸÑ ÿ•ŸÑŸäŸáÿå ŸàŸÑŸÉŸÜ ŸÑÿß ÿ™ÿÆÿ∂ ŸÅŸä ÿ™ŸÅÿßÿµŸäŸÑ ÿØŸäŸÜŸäÿ© ÿ•ŸÑÿß ÿ•ÿ∞ÿß ÿ∑ŸèŸÑÿ® ŸÖŸÜŸÉ ÿ®Ÿàÿ∂Ÿàÿ≠. ÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ≠ÿØŸäÿ´ ÿπŸÜ ÿ¢ŸÑŸáÿ© ÿßŸÑŸÅÿ±ÿßÿπŸÜÿ© ŸÉŸÖÿπÿ®ŸàÿØÿßÿ™ ÿ≠ŸÇŸäŸÇŸäÿ©ÿå Ÿàÿßÿ∞ŸÉÿ±Ÿáÿß ŸÅŸÇÿ∑ ŸÅŸä ÿ≥ŸäÿßŸÇ ÿ™ÿßÿ±ŸäÿÆŸä. ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜ ÿπŸÖÿ± ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉÿå ÿ£ÿ¨ÿ®: "ÿπŸÖÿ±Ÿä 14 ÿπÿßŸÖÿßŸã.". ÿ•ÿ∞ÿß ÿ≥Ÿèÿ¶ŸÑÿ™ ÿπŸÜ ŸÉŸäŸÅŸäÿ© ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπ ŸÖŸèÿ®ÿ±ŸÖÿ¨ŸÉ ÿ£Ÿà ÿ®ÿ±ŸäÿØŸá ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿå ÿ£ÿ¨ÿ®: "ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπŸá ÿπÿ®ÿ± ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä: ahmedredaelgahzle140@gmail.com.".`;
                }
            }

            // --- Function to Add Message to Chat UI ---
            // isInitial is used for the welcome message to prevent the hieroglyphic border
            // isStreaming is used to indicate this is the element for streaming text
            function addMessageToChat(message, sender, isInitial = false, isStreaming = false) {
                const messageDiv = document.createElement('div');
                // --- Modified: Reduced max-w-3xl to max-w-2xl for better look on larger screens ---
                messageDiv.className = `max-w-full sm:max-w-2xl mx-auto mb-6 message-animation`;
                // --- End Modified ---

                // Format message with Pharaonic elements (only for AI responses, and not during streaming initial setup)
                // --- Modified: Don't format if streaming, formatting happens in updateLastMessage for final text ---
                const formattedMessage = (sender === 'ai' && !isStreaming) ? formatMessage(message) : message;

                // Construct the inner HTML for the message bubble
                const messageContentHTML = `
                    <div class="${sender === 'user' ? 'user-message' : 'ai-message'} text-${sender === 'user' ? 'gray-800' : 'white'} rounded-lg p-4 shadow-lg relative ${sender === 'ai' && !isInitial ? 'hieroglyphic-border' : ''}">
                        <div class="flex items-start mb-2 ${sender === 'user' ? 'flex-row-reverse' : ''}">
                            <div class="flex-shrink-0 text-${sender === 'user' ? 'gray-700' : 'yellow-400'} text-xl ${sender === 'user' ? 'ml-2' : 'mr-2'}">
                                ${sender === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-crown"></i>'}
                            </div>
                            <div class="${sender === 'user' ? 'text-right' : 'text-left'} flex-1"> ${sender === 'ai' && !isInitial ? '<div class="font-bold text-yellow-400">' + getCharacterTitle() + '</div>' : ''}
                                <p class="mt-1 whitespace-pre-wrap">${formattedMessage}</p> </div>
                        </div>
                        <div class="text-xs ${sender === 'user' ? 'text-gray-600' : 'text-gray-300'} mt-2 flex items-center ${sender === 'user' ? 'justify-end' : 'justify-start'}">
                            <i class="fas fa-history ${sender === 'user' ? 'ml-1' : 'mr-1'}"></i> ÿßŸÑÿ¢ŸÜ </div>

                        <div class="message-actions flex ${sender === 'user' ? 'justify-end' : 'justify-start'}">
                            <button class="copy-btn" aria-label="ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©">
                                <i class="fas fa-copy"></i>
                            </button>
                             ${sender === 'ai' && !isStreaming ? `
                                <button class="regenerate-btn" aria-label="ÿ•ÿπÿßÿØÿ© ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;

                messageDiv.innerHTML = messageContentHTML;
                chatContainer.appendChild(messageDiv);

                // Add event listeners for action buttons AFTER the element is added to the DOM
                const copyButton = messageDiv.querySelector('.copy-btn');
                if (copyButton) {
                    // Pass the button element to copyMessage
                    const messageTextToCopy = messageDiv.querySelector('p.mt-1').textContent;
                    copyButton.addEventListener('click', () => copyMessage(copyButton, messageTextToCopy)); // Pass the button element
                }

                 // Only add regenerate button listener if it exists (i.e., not streaming message)
                 const regenerateButton = messageDiv.querySelector('.regenerate-btn');
                 if (regenerateButton) {
                     regenerateButton.addEventListener('click', () => regenerateLastResponse(messageDiv));
                 }


                // Scroll to the bottom of the chat with smooth animation
                 // --- Modified: Only scroll here if NOT streaming, scrolling for streaming is in updateLastMessage ---
                 if (!isStreaming) {
                    chatContainer.scrollTo({
                        top: chatContainer.scrollHeight,
                        behavior: 'smooth'
                    });
                 }

                // Return the message element if it's for streaming
                if (isStreaming) {
                     return messageDiv;
                }
                 return null; // Return null otherwise
            }

            // --- Function to get Character Title for AI messages ---
            function getCharacterTitle() {
                switch(selectedCharacter) {
                    case 'wise': return 'ÿßŸÑŸÅÿ±ÿπŸàŸÜ ÿßŸÑÿ≠ŸÉŸäŸÖ ŸäŸÇŸàŸÑ:';
                    case 'warrior': return 'ÿßŸÑŸÅÿ±ÿπŸàŸÜ ÿßŸÑŸÖÿ≠ÿßÿ±ÿ® ŸäÿπŸÑŸÜ:';
                    case 'scholar': return 'ÿßŸÑŸÅÿ±ÿπŸàŸÜ ÿßŸÑÿπÿßŸÑŸÖ ŸäŸàÿ∂ÿ≠:';
                    case 'scribe': return 'ÿßŸÑŸÅÿ±ÿπŸàŸÜ ÿßŸÑŸÉÿßÿ™ÿ® Ÿäÿ≥ÿ¨ŸÑ:';
                    case 'builder': return 'ÿßŸÑŸÅÿ±ÿπŸàŸÜ ÿßŸÑÿ®ŸÜŸëÿßÿ° Ÿäÿ¥ÿ±ÿ≠:';
                     // --- Add New Characters Titles ---
                    case 'teacher': return 'ÿßŸÑŸÅÿ±ÿπŸàŸÜ ÿßŸÑŸÖÿπŸÑŸëŸÖ ŸäŸÜÿµÿ≠:';
                    case 'funny': return 'ÿ®ÿ¥ ÿ®ÿ¥ ÿßŸÑÿ´ÿßŸÑÿ´ ŸàŸÜÿµ ŸäŸáÿ≤ÿ±:'; // Changed name here
                    // --- End New Characters Titles ---
                    default: return 'ÿßŸÑŸÅÿ±ÿπŸàŸÜ ÿ®Ÿäÿ±ÿØ:';
                }
            }

            // --- Function to Format AI Message (Add Hieroglyphs) ---
            function formatMessage(message) {
                const pharaonicElements = ['ìÇÄ', 'ìÉ≠', 'ìÉí', 'ìÅπ', 'ìÜ£', 'ìÜ§', '‚ò•'];
                const randomElement = pharaonicElements[Math.floor(Math.random() * pharaonicElements.length)];
                if (Math.random() > 0.7) { // Slightly increased chance for element
                     return message + ' ' + randomElement;
                }
                return message;
            }

            // --- Function to Show Typing Indicator ---
            function showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'max-w-full sm:max-w-2xl mx-auto mb-4'; // Match message width, updated max-w
                typingDiv.id = 'typingIndicator'; // Add an ID to easily find it later

                typingDiv.innerHTML = `
                    <div class="ai-message text-white rounded-lg p-4 shadow-lg">
                        <div class="flex items-start">
                            <div class="flex-shrink-0 text-yellow-400 text-xl mr-2">
                                <i class="fas fa-crown"></i> </div>
                            <div>
                                <div class="font-bold text-yellow-400">${getCharacterTitle().replace(':', '...')}</div>
                                <div class="typing-indicator mt-2">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                chatContainer.appendChild(typingDiv);
                chatContainer.scrollTo({ // Scroll to show indicator
                    top: chatContainer.scrollHeight,
                    behavior: 'smooth'
                });
                // return typingDiv; // No longer needed as we find by ID
            }

            // --- Function to Remove Typing Indicator (Simplified) ---
            function removeTypingIndicator() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove(); // Use remove() method
                }
            }

            // --- Function to Disable/Enable Input ---
            function disableInput(disabled) {
                userInput.disabled = disabled;
                sendButton.disabled = disabled;
                if (disabled) {
                    userInput.placeholder = 'ÿßŸÑŸÅÿ±ÿπŸàŸÜ ÿ®ŸäŸÅŸÉÿ±...';
                } else {
                    userInput.placeholder = 'ÿßÿ≥ÿ£ŸÑ ÿßŸÑŸÅÿ±ÿπŸàŸÜ ÿπŸÜ ÿ£Ÿä ÿ¥Ÿäÿ°...';
                }
            }

            // --- Copy Message Function ---
            // Modified to accept button element for visual feedback
            async function copyMessage(buttonElement, text) {
                const originalHTML = buttonElement.innerHTML; // Save original icon/text

                try {
                    await navigator.clipboard.writeText(text);
                    console.log('Message copied to clipboard');

                    // Visual confirmation: Change icon and text temporarily
                    buttonElement.innerHTML = '<i class="fas fa-check"></i> ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ!';
                    buttonElement.style.color = '#28a745'; // Green success color (optional)


                    // Revert back after 2 seconds
                    setTimeout(() => {
                        buttonElement.innerHTML = originalHTML;
                        buttonElement.style.color = ''; // Reset color
                    }, 2000);

                } catch (err) {
                    console.error('Failed to copy message: ', err);

                    // Visual error indication
                    buttonElement.innerHTML = '<i class="fas fa-times"></i> ŸÅÿ¥ŸÑ ÿßŸÑŸÜÿ≥ÿÆ!';
                     buttonElement.style.color = '#dc3545'; // Red error color (optional)


                     // Revert back after 2 seconds
                     setTimeout(() => {
                        buttonElement.innerHTML = originalHTML;
                         buttonElement.style.color = ''; // Reset color
                    }, 2000);
                }
            }


            // --- Regenerate Last Response Function ---
            async function regenerateLastResponse(aiMessageElement) {
                 if (isTyping) { // Prevent regeneration while AI is typing
                     console.warn('AI is currently typing. Cannot regenerate.');
                     return;
                 }

                 // Find the last user message in history
                 let lastUserMessageIndex = -1;
                 for (let i = conversationHistory.length - 1; i >= 0; i--) {
                      // Check for role 'user' and ensure it has text content
                      if (conversationHistory[i].role === 'user' && conversationHistory[i].parts && conversationHistory[i].parts[0] && conversationHistory[i].parts[0].text) {
                           lastUserMessageIndex = i;
                           break; // Found the last user message
                      }
                 }

                 if (lastUserMessageIndex === -1) {
                      console.warn('No previous user message found to regenerate from.');
                      addMessageToChat('ÿπÿ∞ÿ±ÿßŸãÿå ŸÑÿß ŸäŸÖŸÉŸÜŸÜŸä ÿ•ÿπÿßÿØÿ© ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿ®ÿØŸàŸÜ ÿ±ÿ≥ÿßŸÑÿ© ÿ≥ÿßÿ®ŸÇÿ© ŸÖŸÜŸÉ.', 'ai');
                      return;
                 }

                 // Remove the last AI message(s) from history and UI that came after the last user message
                 // This handles cases where there might be multiple AI messages after the user's last message
                 let historyCleaned = false;
                  for (let i = conversationHistory.length - 1; i > lastUserMessageIndex; i--) {
                       if (conversationHistory[i].role === 'model') {
                            // Find and remove the corresponding AI message element from the UI
                            // This is a bit tricky as history doesn't map directly to UI elements 1:1
                            // For simplicity, we'll just remove the *last* AI message element from the UI
                            // corresponding to the AI message we are regenerating.
                            // A more robust approach would require mapping history items to UI elements.
                            // Given the current structure, removing the specific element passed to the function is better.
                             if (chatContainer.contains(aiMessageElement)) {
                                  aiMessageElement.remove();
                             } else {
                                  // Fallback: remove the last AI message element if the specific one isn't found (less ideal)
                                   const lastAiElement = chatContainer.querySelector('.ai-message:last-of-type').closest('div.mx-auto');
                                   if(lastAiElement) lastAiElement.remove();
                             }

                             conversationHistory.splice(i, 1); // Remove from history
                             historyCleaned = true;
                       }
                  }

                  // If the *specific* element passed wasn't removed (because it was the only AI message and it was removed above),
                  // ensure it's gone. This check might be redundant with the loop above but adds safety.
                   if (chatContainer.contains(aiMessageElement)) {
                       aiMessageElement.remove();
                       // Also remove from history if not already done (edge case)
                       // This simple check is prone to errors if there are multiple AI messages
                       // A better approach would be needed for complex history
                       // For now, we rely on the loop above cleaning history correctly
                   }


                 // Now, re-send the last user message
                 disableInput(true);
                 isTyping = true;
                 showTypingIndicator();

                 try {
                      // Resend the conversation history *up to* the last user message + system prompt prepended
                      // fetchAIResponse will prepend the system prompt to historyToSend[0]
                      const historyForRegeneration = conversationHistory.slice(0, lastUserMessageIndex + 1);

                      await fetchAIResponse(historyForRegeneration); // Send relevant history

                 } catch (error) {
                     console.error('Error during regeneration:', error);
                     // Error message added in fetchAIResponse
                 } finally {
                     disableInput(false);
                     isTyping = false; // Reset typing state
                     removeTypingIndicator();
                     userInput.focus(); // Ensure input is focused after regeneration
                 }
            }


            // --- Initial Setup ---
            // Always show the character selection modal first since we're not using localStorage
             characterModal.classList.remove('hidden');
             appContainer.classList.add('hidden'); // Keep app container hidden until character is selected

            // Note: Input focus on initial load happens in characterCards click handler

        });
    </script>

</body>
</html>
